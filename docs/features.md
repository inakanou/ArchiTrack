# ArchiTrack 機能一覧

このドキュメントでは、ArchiTrackの実装済み機能と開発予定機能の詳細を説明します。

---

## 現在実装済み

### インフラストラクチャ

- ✅ **ヘルスチェックAPI**
  - システムの稼働状態を監視するためのエンドポイント
  - データベース、Redis、アプリケーションサーバーの状態チェック

- ✅ **Swagger/OpenAPI仕様書自動生成**
  - API仕様を自動的にドキュメント化
  - 開発者向けのインタラクティブなAPI探索UI
  - エンドポイント: `http://localhost:3000/docs`

- ✅ **PostgreSQLデータベース統合**
  - Prisma 7（Driver Adapter Pattern）による型安全なデータベースアクセス
  - マイグレーション管理とスキーマ定義

- ✅ **Redisキャッシング準備**
  - セッション管理、レート制限、キャッシング用のRedis統合
  - パフォーマンス最適化のためのインメモリストレージ

- ✅ **Sentry統合（エラー監視）**
  - 本番環境でのエラートラッキング
  - パフォーマンスモニタリング
  - リアルタイムアラート

- ✅ **E2Eテスト環境（Playwright）**
  - ブラウザベースの自動テスト
  - CI/CDパイプライン統合
  - スクリーンショット、ビデオ、トレース機能

### 認証・認可機能

#### ユーザー認証

- ✅ **JWT（EdDSA署名）ベースの認証**
  - Ed25519楕円曲線署名アルゴリズムによる安全なトークン
  - アクセストークン（15分有効期限）+ リフレッシュトークン（7日有効期限）
  - トークンローテーション対応

- ✅ **招待制ユーザー登録**
  - 管理者による招待トークン発行
  - トークンの有効期限管理（7日間）
  - ロール指定による初期権限設定

#### 二段階認証（2FA）

- ✅ **TOTP方式**
  - RFC 6238準拠の時間ベースワンタイムパスワード
  - Google Authenticator、Authy等のアプリ対応
  - 30秒周期、6桁コード

- ✅ **バックアップコード**
  - デバイス紛失時のリカバリー手段
  - 8桁 × 10個の使い捨てコード
  - 一度使用したコードは無効化

- ✅ **QRコード生成**
  - 認証アプリへの簡単な登録
  - Base64エンコードされたPNG画像
  - otpauth:// URIスキーム

#### パスワード管理

- ✅ **Argon2idハッシュ化**
  - メモリハード関数による強力なハッシュ化
  - ブルートフォース攻撃への高い耐性
  - PHC（Password Hashing Competition）優勝アルゴリズム

- ✅ **HIBP（Have I Been Pwned）漏洩チェック**
  - 登録・パスワード変更時に漏洩データベースをチェック
  - k-匿名性モデルによるプライバシー保護
  - 既知の漏洩パスワードを拒否

- ✅ **パスワード履歴管理**
  - 過去10回のパスワードを記録
  - パスワード再利用を防止
  - セキュリティ要件の強化

#### ロールベースアクセス制御（RBAC）

- ✅ **NIST RBAC標準準拠**
  - Core RBAC（基本的なロールと権限）
  - Hierarchical RBAC（ロールの階層構造）
  - Constrained RBAC（制約付きロール割り当て）

- ✅ **事前定義ロール**
  - `ADMIN`: システム管理者（全権限）
  - `EDITOR`: コンテンツ編集者（ADR作成・編集）
  - `VIEWER`: 閲覧者（読み取りのみ）

- ✅ **権限管理**
  - きめ細かい権限設定
  - ロールと権限の動的割り当て
  - 最小権限の原則（Principle of Least Privilege）

#### セッション管理

- ✅ **マルチデバイス対応**
  - 複数デバイスでの同時ログイン
  - デバイスごとのセッション追跡
  - User-Agent、IPアドレスの記録

- ✅ **全デバイスログアウト**
  - セキュリティ侵害時の緊急対応
  - 全セッションの一括無効化
  - リフレッシュトークンの完全削除

#### 監査ログ

- ✅ **センシティブな操作の完全記録**
  - ログイン/ログアウト
  - パスワード変更
  - 2FA設定変更
  - ロール変更
  - ユーザー招待
  - 監査ログ閲覧（管理者のみ）

- ✅ **詳細なコンテキスト記録**
  - タイムスタンプ（UTC）
  - ユーザー識別情報
  - IPアドレス
  - User-Agent
  - 操作結果（成功/失敗）
  - エラー詳細

### プロジェクト管理機能

- ✅ **プロジェクトCRUD**
  - プロジェクトの作成・編集・削除（論理削除）
  - 楽観的排他制御による競合防止
  - 担当者割り当て

- ✅ **ステータス遷移管理**
  - 12種類のプロジェクトステータス（見込み〜完了・中止）
  - ステータス変更履歴の記録
  - 差し戻し理由の必須入力

- ✅ **検索・フィルタリング・ページネーション**
  - プロジェクト名・顧客名による検索
  - ステータス・担当者によるフィルタリング
  - ソート（作成日、更新日、プロジェクト名）

### 取引先管理機能

- ✅ **取引先CRUD**
  - 顧客・協力業者の作成・編集・削除（論理削除）
  - 楽観的排他制御による競合防止
  - 取引先種別の複数選択（顧客/協力業者）

- ✅ **請求管理情報**
  - 請求締日設定（月末または毎月5日〜25日）
  - 支払日設定（翌月末または翌々月末）

- ✅ **検索・フィルタリング・ページネーション**
  - 取引先名による検索
  - 取引先種別によるフィルタリング
  - オートコンプリート検索（プロジェクト登録時）

### 現場調査機能

- ✅ **現場調査CRUD**
  - プロジェクトに紐付く現場調査の作成・編集・削除（論理削除）
  - 楽観的排他制御による競合防止
  - 調査日・調査者・調査結果の管理

- ✅ **画像アップロード・管理**
  - ストレージ抽象化レイヤー（開発: ローカル、本番: Cloudflare R2）
  - 画像圧縮・サムネイル生成（Sharp）
  - 画像順序の変更
  - 署名付きURL生成

- ✅ **Canvas注釈編集（Fabric.js）**
  - 寸法線ツール（計測値入力対応）
  - 矢印・円・四角形・多角形・折れ線ツール
  - フリーハンド描画
  - テキスト注釈
  - Undo/Redo機能
  - 自動保存

- ✅ **PDF報告書エクスポート**
  - jsPDFによるPDF生成
  - 注釈付き画像のエクスポート
  - 調査情報のレポート出力

### 数量表作成機能

- ✅ **数量表CRUD**
  - 現場調査に紐付く数量表の作成・編集・削除（論理削除）
  - 楽観的排他制御による競合防止
  - 数量表タイトル・説明の管理

- ✅ **数量グループ管理**
  - 数量項目をグループ化して管理
  - グループの作成・編集・削除
  - グループ順序の変更
  - 現場調査写真との紐づけ

- ✅ **数量項目管理**
  - 数量項目の作成・編集・削除
  - 項目のコピー・移動
  - 項目順序の変更
  - オートコンプリートによる入力支援

- ✅ **計算方法選択**
  - 標準計算（数量 × 単価）
  - 面積体積計算（縦 × 横 × 高さ）
  - ピッチ計算（長さ ÷ ピッチ + 1）
  - 計算方法に応じた入力フィールド自動切り替え

- ✅ **調整係数・丸め設定**
  - 調整係数による数量調整
  - 丸め単位の設定（整数、小数点以下1桁など）
  - 丸め方向の設定（切り上げ、切り捨て、四捨五入）

- ✅ **フィールドバリデーション**
  - 文字数制限（項目名、単位、備考など）
  - 数値範囲バリデーション（数量、単価、寸法など）
  - 表示書式の統一（小数点以下桁数など）

### 共通UI機能

- ✅ **共通ナビゲーション（AppHeader）**
  - 認証状態対応のアプリケーションヘッダー
  - レスポンシブメニュー
  - ユーザードロップダウン

- ✅ **ダッシュボード**
  - ログイン後のランディングページ

- ✅ **管理者機能**
  - ロール管理ページ
  - 権限管理ページ
  - ユーザー管理ページ

---

## 開発予定

以下の機能は現在開発中、または今後の開発予定です。

### ADR管理機能（コア機能）

- 🚧 **ADR作成・編集・削除**
  - Markdownエディタによる記述
  - テンプレート選択
  - メタデータ管理（ステータス、タグ、関連ADR）

- 🚧 **ADRバージョン管理**
  - 変更履歴の追跡
  - 差分表示
  - 以前のバージョンへの復元

- 🚧 **ADR検索・フィルタリング**
  - 全文検索
  - タグによるフィルタリング
  - ステータスによる絞り込み
  - 日付範囲検索

### チーム機能

- 🚧 **チーム管理**
  - チーム作成・編集・削除
  - メンバー管理
  - チームごとのADR管理

### エディター機能

- 🚧 **Markdownエディタ**
  - リアルタイムプレビュー
  - シンタックスハイライト
  - 画像アップロード
  - コードブロック対応

### テンプレート機能

- 🚧 **ADRテンプレート管理**
  - カスタムテンプレート作成
  - テンプレートライブラリ
  - 組織標準テンプレート

---

## 関連ドキュメント

- [API概要](api/overview.md) - 各機能のAPIエンドポイント
- [セキュリティ設計](architecture/security-design.md) - 認証・認可の設計詳細
- [技術スタック](architecture/tech-stack.md) - 使用技術の選定理由
