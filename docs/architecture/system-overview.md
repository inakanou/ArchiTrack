# システム構成

このドキュメントでは、ArchiTrackのシステム構成とアーキテクチャを説明します。

---

## システム構成図

### 本番環境（Railway）

```
┌─────────────────────────────────────────────────────────────────┐
│                         クライアント                              │
│                      (ブラウザ/モバイル)                          │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTPS
                             │
┌────────────────────────────┴────────────────────────────────────┐
│                      Railway (Production)                        │
│  ┌──────────────────┐              ┌─────────────────────┐     │
│  │   Frontend       │              │   Backend API       │     │
│  │   (Nginx/React)  │──────────────│   (Node.js/Express) │     │
│  │   Port: 443      │   API calls  │   Port: 3000        │     │
│  └──────────────────┘              └──────────┬──────────┘     │
│                                                │                 │
│                                    ┌───────────┴─────────┐      │
│                                    │                     │      │
│                          ┌─────────▼──────┐   ┌─────────▼─────┐│
│                          │  PostgreSQL 15 │   │   Redis 7     ││
│                          │  (Database)    │   │   (Cache)     ││
│                          └────────────────┘   └───────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### ローカル開発環境（Docker Compose）

```
┌─────────────────────────────────────────────────────────────────┐
│  ┌──────────────────┐              ┌─────────────────────┐     │
│  │   Frontend       │              │   Backend API       │     │
│  │   (Vite HMR)     │──────────────│   (tsx watch)       │     │
│  │   Port: 5173     │              │   Port: 3000        │     │
│  └──────────────────┘              └──────────┬──────────┘     │
│                                                │                 │
│                                    ┌───────────┴─────────┐      │
│                                    │                     │      │
│                          ┌─────────▼──────┐   ┌─────────▼─────┐│
│                          │  PostgreSQL 15 │   │   Redis 7     ││
│                          │  (Docker)      │   │   (Docker)    ││
│                          └────────────────┘   └───────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント

### Frontend（React + Vite）

**役割:**
- ユーザーインターフェース
- クライアントサイドルーティング
- 状態管理
- APIクライアント

**技術スタック:**
- React 18
- Vite 5
- React Router
- Axios（APIクライアント）

**本番環境:**
- Nginx（静的ファイルサーバー）
- HTTPS（Railway自動設定）

**開発環境:**
- Vite Dev Server（HMR）
- ポート: 5173

### Backend（Node.js + Express）

**役割:**
- REST API提供
- ビジネスロジック
- データベースアクセス
- 認証・認可

**技術スタック:**
- Node.js 20
- Express
- Prisma（ORM）
- JWT（認証）

**本番環境:**
- Node.js プロセス
- ポート: 3000
- HTTPS（Railway自動設定）

**開発環境:**
- tsx watch（ホットリロード）
- ポート: 3000

### Database（PostgreSQL）

**役割:**
- データ永続化
- トランザクション管理
- リレーショナルデータ管理

**技術スタック:**
- PostgreSQL 15

**アクセス:**
- Backend経由のみ（Prisma ORM）
- 接続暗号化（本番環境）

### Cache（Redis）

**役割:**
- セッション管理
- レートリミット
- 一時データキャッシュ

**技術スタック:**
- Redis 7

**アクセス:**
- Backend経由のみ
- 接続暗号化（本番環境）

---

## ネットワーク構成

### 本番環境（Railway）

| サービス | ポート | プロトコル | アクセス |
|---------|-------|-----------|---------|
| Frontend | 443 | HTTPS | 公開 |
| Backend | 443 | HTTPS | 公開（APIのみ） |
| PostgreSQL | - | Internal | Backend のみ |
| Redis | - | Internal | Backend のみ |

**特徴:**
- Railwayの内部ネットワークでサービス間通信
- 外部からはFrontend/BackendのHTTPSエンドポイントのみアクセス可能
- データベースは外部アクセス不可

### ローカル開発環境（Docker Compose）

| サービス | ポート | プロトコル | アクセス |
|---------|-------|-----------|---------|
| Frontend | 5173 | HTTP | localhost |
| Backend | 3000 | HTTP | localhost |
| PostgreSQL | 5432 | TCP | localhost |
| Redis | 6379 | TCP | localhost |

**特徴:**
- Dockerネットワークでサービス間通信
- すべてのポートがlocalhostからアクセス可能
- 開発用にHTTPを使用

---

## スケーラビリティ

### 水平スケーリング

**Frontend:**
- 静的ファイルサーバー（Nginx）
- CDN配信可能
- 複数インスタンスで負荷分散

**Backend:**
- ステートレス設計
- セッションはRedisで管理
- 複数インスタンスで負荷分散可能

**Database:**
- PostgreSQL レプリケーション
- 読み取りレプリカ（将来的に）

**Cache:**
- Redis Cluster（将来的に）

### 垂直スケーリング

Railway環境でリソース（CPU、メモリ）を増強可能

---

## 可用性

### ヘルスチェック

```
GET /health
```

**レスポンス:**
```json
{
  "status": "ok",
  "timestamp": "2025-11-13T00:00:00.000Z",
  "services": {
    "database": "connected",
    "redis": "connected"
  }
}
```

### モニタリング

- **Sentry**: エラートラッキング
- **Railway Dashboard**: リソース監視
- **Prisma Metrics**: データベースクエリパフォーマンス

---

## 次のステップ

- [データフロー](data-flow.md): データの流れ
- [セキュリティ設計](security-design.md): セキュリティ層
- [技術スタック](tech-stack.md): 技術選定理由
