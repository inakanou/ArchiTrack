# Requirements Document

## Introduction

数量表・内訳書管理システムは、積算担当者が現場調査結果に基づいて数量を拾い出し、調査写真と紐づけながら内訳書を作成するための統合システムです。本システムにより、従来の手作業による積算作業を効率化し、正確性の向上とトレーサビリティの確保を実現します。

### Business Value
- 積算作業の効率化と標準化
- 現場調査写真との紐づけによるトレーサビリティ確保
- 計算ミスの削減と品質向上
- 内訳書生成の自動化

## Requirements

### Requirement 1: 内訳書の作成・管理機能

**Objective:** As a 積算担当者, I want プロジェクトの内訳書を効率的に作成・管理する機能, so that 積算作業の標準化と効率化を実現できる

#### Acceptance Criteria

1. When プロジェクト詳細画面で内訳書作成操作を行う, the 数量表管理システム shall 新規作成または既存内訳書コピーの選択肢を表示する
2. If 新規作成が選択される, then the 数量表管理システム shall 空の内訳書を作成し編集画面を表示する
3. If 既存内訳書コピーが選択される, then the 数量表管理システム shall 選択可能な既存内訳書一覧を表示し、選択後に複製を作成する
4. When 内訳書編集画面が表示される, the 数量表管理システム shall 数量表編集エリア、関連写真表示エリア、自動生成内訳書プレビューエリアを表示する
5. When 内訳書一覧画面を表示する, the 数量表管理システム shall プロジェクトに紐づく内訳書の一覧を作成日時順に表示する

### Requirement 2: 数量グループの作成・編集機能

**Objective:** As a 積算担当者, I want 現場調査写真に基づいた数量グループを作成し数量項目を管理する機能, so that 写真と数量の紐づけによるトレーサビリティを確保できる

#### Acceptance Criteria

1. When 内訳書詳細画面で数量グループ追加操作を行う, the 数量表管理システム shall 新しい数量グループを数量表に追加する
2. If 数量グループが追加される, then the 数量表管理システム shall 同一プロジェクトの注釈付き現場調査写真選択機能を提供する
3. When 数量グループ内で行追加操作を行う, the 数量表管理システム shall 「大項目・中項目・小項目・任意分類・工種・名称・規格・単位・数量・備考」で構成される新しい数量項目を追加する
4. When 数量グループ内で写真選択操作を行う, the 数量表管理システム shall 同一プロジェクトの注釈付き現場写真一覧を表示し選択可能にする
5. Where 数量グループに写真が紐づけられている状態で, the 数量表管理システム shall 写真と数量項目の関連性を視覚的に表示する
6. When 数量グループの削除操作を行う, the 数量表管理システム shall 確認ダイアログを表示し、承認後に数量グループとその配下の数量項目を削除する

### Requirement 3: 数量項目の操作機能

**Objective:** As a 積算担当者, I want 数量項目を柔軟に操作する機能, so that 効率的に数量表を構築できる

#### Acceptance Criteria

1. When 数量項目を選択して削除操作を行う, the 数量表管理システム shall 選択された数量項目を削除する
2. When 数量項目を選択してコピー操作を行う, the 数量表管理システム shall 選択された数量項目を直下に複製する
3. When 数量項目を選択して移動操作を行う, the 数量表管理システム shall 移動先選択UI（同一数量グループ内または別数量グループ）を表示し、選択後に項目を移動する
4. If 移動先に別数量グループが選択される, then the 数量表管理システム shall 選択数量項目を移動先数量グループに移動し、元の位置から削除する
5. When 複数の数量項目を選択して一括操作を行う, the 数量表管理システム shall 選択された全ての項目に対して削除・コピー・移動操作を実行する
6. When 数量項目のドラッグアンドドロップ操作を行う, the 数量表管理システム shall 項目の表示順序を変更する

### Requirement 4: 入力支援・オートコンプリート機能

**Objective:** As a 積算担当者, I want 一貫性のある入力を効率的に行う機能, so that 入力ミスを削減できる

#### Acceptance Criteria

1. When 大項目フィールドに入力を開始する, the 数量表管理システム shall 同一数量表内で過去に入力された大項目値をオートコンプリート候補として表示する
2. When 中項目フィールドに入力を開始する, the 数量表管理システム shall 同一数量表内で過去に入力された中項目値をオートコンプリート候補として表示する
3. When 小項目・任意分類・工種・名称・規格・単位・備考の各フィールドに入力を開始する, the 数量表管理システム shall 同一数量表内の対応フィールドの入力履歴をオートコンプリート候補として表示する
4. If オートコンプリート候補が選択される, then the 数量表管理システム shall 選択された値を該当フィールドに自動入力する
5. Where 同一フィールドで複数の候補がある場合に, the 数量表管理システム shall 使用頻度順に候補を表示する
6. When キーボードで候補リストをナビゲートする, the 数量表管理システム shall 上下キーで候補選択、Enterキーで確定を可能にする

### Requirement 5: 数量計算機能

**Objective:** As a 積算担当者, I want 様々な計算方式で数量を正確に算出する機能, so that 計算ミスを削減できる

#### Acceptance Criteria

1. When 数量フィールドに直接数値を入力する, the 数量表管理システム shall 入力された数値を数量として設定する
2. While 単位が「m2」に設定されている状態で and 計算入力モードが選択される, the 数量表管理システム shall 幅（W）・高さ（H）入力フィールドを表示し、W×Hで数量を自動計算する
3. While 単位が「m3」に設定されている状態で and 計算入力モードが選択される, the 数量表管理システム shall 幅（W）・奥行き（D）・高さ（H）入力フィールドを表示し、W×D×Hで数量を自動計算する
4. When 参照合計モードが選択される, the 数量表管理システム shall 他の数量項目選択UIを表示し、選択項目の数量合計を自動計算する
5. While 計算式が設定されている状態で, the 数量表管理システム shall 元データ変更時に数量を自動再計算する
6. If 計算エラーが発生した場合, then the 数量表管理システム shall 明確なエラーメッセージを表示し、手動入力への切り替えを提案する
7. When 計算式の詳細を確認する操作を行う, the 数量表管理システム shall 計算式と参照元を表示する

### Requirement 6: 数量表保存・内訳書自動生成機能

**Objective:** As a 積算担当者, I want 数量表を保存すると同時に内訳書が自動生成される機能, so that 常に最新の集計結果を確認できる

#### Acceptance Criteria

1. When 数量表の保存操作を行う, the 数量表管理システム shall 全ての数量項目を分類別（大項目・中項目・小項目）に集計し内訳書を自動生成する
2. If 数量表に変更が加えられて保存される, then the 数量表管理システム shall 変更内容を反映して内訳書を再集計・更新する
3. When 内訳書が生成・更新される, the 数量表管理システム shall 生成日時、更新履歴、集計項目数を記録する
4. Where 数量項目に不整合がある場合に, the 数量表管理システム shall 警告メッセージを表示し、問題箇所をハイライト表示する
5. While 自動保存が有効な状態で, the 数量表管理システム shall 一定間隔で数量表を自動保存し、内訳書を更新する
6. When 内訳書プレビューを表示する, the 数量表管理システム shall リアルタイムで集計結果を反映したプレビューを表示する

### Requirement 7: データ整合性・バリデーション機能

**Objective:** As a 積算担当者, I want データの整合性が保たれエラーのない内訳書を作成する機能, so that 正確な内訳書を作成できる

#### Acceptance Criteria

1. When 必須フィールド（大項目・工種・名称・単位・数量）が未入力で保存を試行する, the 数量表管理システム shall 該当フィールドをハイライトし、エラーメッセージを表示する
2. If 数量フィールドに負の値が入力される, then the 数量表管理システム shall 警告メッセージを表示し、確認を求める
3. When 単位の不整合（m2の項目にm3の計算式設定等）が検出される, the 数量表管理システム shall エラー箇所を明示し、修正を求める
4. If 参照合計で循環参照が発生した場合, then the 数量表管理システム shall 循環参照を検出しエラーメッセージを表示する
5. If データ保存時に整合性チェックでエラーが検出される, then the 数量表管理システム shall 保存を中断し、問題箇所の修正を求める
6. When バリデーションエラー一覧を表示する操作を行う, the 数量表管理システム shall 全てのエラーと警告を一覧形式で表示し、該当箇所へのナビゲーションを提供する

### Requirement 8: 内訳書出力機能

**Objective:** As a 積算担当者, I want 内訳書を様々な形式で出力する機能, so that 社内外での共有や提出に利用できる

#### Acceptance Criteria

1. When 内訳書のPDF出力操作を行う, the 数量表管理システム shall 分類別に集計された内訳書をPDF形式で生成する
2. When 内訳書のExcel出力操作を行う, the 数量表管理システム shall 編集可能なExcel形式（.xlsx）で内訳書を出力する
3. When 出力操作を行う, the 数量表管理システム shall プロジェクト名、出力日時、担当者情報をヘッダーに含める
4. Where 紐づけられた写真がある場合に, the 数量表管理システム shall 出力オプションで写真の添付有無を選択可能にする
5. When 出力プレビューを表示する, the 数量表管理システム shall 実際の出力結果と同等のプレビューを表示する

### Requirement 9: 楽観的排他制御機能

**Objective:** As a 積算担当者, I want 複数ユーザーによる同時編集時のデータ整合性が保たれる機能, so that データの競合を防止できる

#### Acceptance Criteria

1. When 数量表を保存する, the 数量表管理システム shall バージョン番号を用いた楽観的排他制御を実施する
2. If 他のユーザーが先に同一数量表を更新していた場合, then the 数量表管理システム shall 競合エラーを表示し、最新データの取得を促す
3. When 競合エラーが発生した場合, the 数量表管理システム shall ユーザーの編集内容と最新データの差分を表示する
4. When 競合解決操作を行う, the 数量表管理システム shall 自分の変更で上書き、または最新データで更新の選択肢を提供する

### Requirement 10: 監査ログ機能

**Objective:** As a システム管理者, I want 数量表・内訳書に対する操作履歴を追跡する機能, so that 変更の追跡とコンプライアンス対応ができる

#### Acceptance Criteria

1. When 数量表または内訳書に対する操作（作成・更新・削除）が行われる, the 数量表管理システム shall 操作者、操作日時、操作内容を監査ログに記録する
2. When 数量項目の変更が行われる, the 数量表管理システム shall 変更前後の値を監査ログに記録する
3. When 監査ログを表示する, the 数量表管理システム shall 日付範囲、操作者、操作種別でフィルタリング可能な一覧を表示する
4. The 数量表管理システム shall 監査ログを改ざん不可能な形式で保存する
