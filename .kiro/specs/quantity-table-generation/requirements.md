# Requirements Document

## Introduction

数量表作成機能は、積算担当者が現場調査結果に基づいて数量を拾い出し、調査写真と紐づけながら数量表を作成するための機能です。本機能により、従来の手作業による積算作業を効率化し、正確性の向上とトレーサビリティの確保を実現します。

### ビジネス価値
- 積算作業の効率化と標準化
- 現場調査写真との紐づけによるトレーサビリティ確保
- 計算ミスの削減と品質向上

### 機能概要
1つのプロジェクトに対して複数の数量表を作成できます。各数量表は複数の「数量グループ」で構成され、各数量グループには現場調査写真を紐づけることができます。数量グループ内には複数の「数量項目」を追加でき、各項目は大項目・中項目・小項目・任意分類・工種・名称・規格・単位・計算方法・（計算用列）・調整係数・丸め設定・数量・備考の属性を持ちます。

## Requirements

### Requirement 1: プロジェクト詳細画面の数量表セクション
**Objective:** 積算担当者として、プロジェクト詳細画面から数量表へ簡単にアクセスしたい。

#### Acceptance Criteria
1. When プロジェクト詳細画面を表示する THEN システムは数量表セクションを表示する
2. While 数量表セクションが表示されている状態で THE システムは数量表の総数（全N件）とヘッダーを表示する
3. Where プロジェクトに数量表が存在する場合 THE システムは直近の数量表カード（名称・更新日時・数量項目数）を一覧表示する
4. When 数量表セクションの「すべて見る」リンクをクリックする THEN システムは数量表一覧画面（/projects/{projectId}/quantity-tables）に遷移する
5. When 数量表カードをクリックする THEN システムは該当数量表の編集画面（/projects/{projectId}/quantity-tables/{quantityTableId}）に遷移する
6. Where プロジェクトに数量表が存在しない場合 THE システムは「数量表はまだありません」メッセージと新規作成ボタンを表示する
7. When 新規作成ボタンをクリックする THEN システムは数量表新規作成画面（/projects/{projectId}/quantity-tables/new）に遷移する

### Requirement 2: 数量表の作成・管理
**Objective:** 積算担当者として、プロジェクトに対して複数の数量表を作成・管理したい。

#### Acceptance Criteria
1. When 数量表一覧画面で新規作成操作を行う THEN システムは数量表名を入力するダイアログを表示する
2. When 数量表名を入力して作成を確定する THEN システムは新しい数量表を作成し、数量表編集画面に遷移する
3. When 数量表一覧画面を表示する THEN システムはプロジェクトに紐づく全ての数量表を作成日時順に一覧表示する
4. When 数量表を選択して削除操作を行う THEN システムは確認ダイアログを表示し、確認後に数量表と配下の全データを削除する
5. When 数量表名を編集する THEN システムは変更を即座に保存する

### Requirement 3: 数量表編集画面の表示
**Objective:** 積算担当者として、数量表編集画面で数量表を編集したい。効率的に数量を拾い出すために、関連する現場調査写真を参照しながら作業できるようにしたい。

#### Acceptance Criteria
1. When 数量表編集画面を表示する THEN システムは数量表編集エリアと関連写真表示エリアを表示する
2. While 数量表編集画面が表示されている状態で THE システムは数量グループ一覧と各グループ内の数量項目を階層的に表示する
3. Where 数量グループに写真が紐づけられている場合 THE システムは該当写真の注釈付きサムネイルを関連写真表示エリアに表示する

### Requirement 4: 数量グループの作成・管理
**Objective:** 積算担当者として、現場調査写真に基づいた数量グループを作成し、関連する数量項目をグループ化して管理したい。

#### Acceptance Criteria
1. When 数量表編集画面で数量グループ追加操作を行う THEN システムは新しい数量グループを数量表に追加する
2. When 数量グループが追加される THEN システムは同一プロジェクトの注釈付き現場調査写真選択機能を提供する
3. When 数量グループ内で写真選択操作を行う THEN システムは同一プロジェクトの注釈付き現場写真一覧を表示し選択可能にする
4. Where 数量グループに写真が紐づけられている状態で THE システムは注釈付き写真と数量項目の関連性を視覚的に表示する
5. When 数量グループの削除操作を行う THEN システムは確認ダイアログを表示し、確認後に数量グループと配下の数量項目を削除する

### Requirement 5: 数量項目の追加・編集
**Objective:** 積算担当者として、数量グループ内に数量項目を追加し、必要な属性を入力したい。

#### Acceptance Criteria
1. When 数量グループ内で行追加操作を行う THEN システムは「大項目・中項目・小項目・任意分類・工種・名称・規格・単位・計算方法・（計算用列）・調整係数・丸め設定・数量・備考」で構成される新しい数量項目を追加する
2. When 数量項目の各フィールドに値を入力する THEN システムは入力値を即座に反映する
3. If 必須フィールド（大項目・工種・名称・単位・数量）が未入力で保存を試行する THEN システムは該当フィールドをハイライトし、エラーメッセージを表示する
4. When 数量項目を選択して削除操作を行う THEN システムは選択された数量項目を削除する

### Requirement 6: 数量項目のコピー・移動
**Objective:** 積算担当者として、数量項目を柔軟に操作し、効率的に数量表を構築したい。

#### Acceptance Criteria
1. When 数量項目を選択してコピー操作を行う THEN システムは選択された数量項目を直下に複製する
2. When 数量項目を選択して移動操作を行う THEN システムは移動先選択UI（同一数量グループ内または別数量グループ）を表示する
3. When 移動先として同一数量グループ内の位置が選択される THEN システムは選択数量項目を指定位置に移動する
4. If 移動先に別数量グループが選択される THEN システムは選択数量項目を移動先数量グループに移動し、元の位置から削除する
5. When 複数の数量項目を選択して一括操作を行う THEN システムは選択された全ての項目に対して削除・コピー・移動操作を実行する

### Requirement 7: 入力支援・オートコンプリート
**Objective:** 積算担当者として、一貫性のある入力を効率的に行い、入力ミスを削減したい。

#### Acceptance Criteria
1. When 大項目フィールドに入力を開始する THEN システムは同一数量表内で過去に入力された大項目値をオートコンプリート候補として表示する
2. When 中項目フィールドに入力を開始する THEN システムは同一数量表内で過去に入力された中項目値をオートコンプリート候補として表示する
3. When 小項目・任意分類・工種・名称・規格・単位・備考の各フィールドに入力を開始する THEN システムは同一数量表内の対応フィールドの入力履歴をオートコンプリート候補として表示する
4. When オートコンプリート候補が選択される THEN システムは選択された値を該当フィールドに自動入力する
5. Where 同一フィールドで複数の候補がある場合に THE システムは使用頻度順に候補を表示する

### Requirement 8: 計算方法の選択
**Objective:** 積算担当者として、数量の算出方法を選択し、状況に応じた計算方式で数量を効率的に算出したい。

#### Acceptance Criteria
1. When 数量項目を追加する THEN システムは計算方法列に「標準」をデフォルト値として設定する
2. When 計算方法列で「標準」が選択されている状態で数量フィールドに直接数値を入力する THEN システムは入力された数値を数量として設定する
3. If 計算方法が「標準」で数量フィールドに負の値が入力される THEN システムは警告メッセージを表示し、確認を求める
4. If 計算方法が「標準」で数量フィールドに数値以外の文字が入力される THEN システムは入力を拒否しエラーメッセージを表示する
5. When 計算方法列で「面積・体積」が選択される THEN システムは計算用列として「幅（W）」「奥行き（D）」「高さ（H）」「重量」入力フィールドを表示する
6. When 「面積・体積」モードで計算用列に1つ以上の値が入力される THEN システムは入力された項目のみを掛け算して計算結果を数量として自動設定する
7. If 「面積・体積」モードで計算用列に値が1つも入力されていない状態で保存を試行する THEN システムはエラーメッセージを表示し、最低1項目の入力を求める
8. When 計算方法列で「ピッチ」が選択される THEN システムは計算用列として「範囲長」「端長1」「端長2」「ピッチ長」「長さ」「重量」入力フィールドを表示する
9. When 「ピッチ」モードで必須項目（範囲長・端長1・端長2・ピッチ長）に値が入力される THEN システムはピッチ計算式に基づいて本数を算出し、任意項目（長さ・重量）が入力されている場合はそれらを乗算した結果を数量として自動設定する
10. If 「ピッチ」モードで必須項目（範囲長・端長1・端長2・ピッチ長）のいずれかが未入力で保存を試行する THEN システムはエラーメッセージを表示し、必須項目の入力を求める
11. While 計算方法が「面積・体積」または「ピッチ」で計算用列に値が設定されている状態で THE システムは計算用列の値変更時に数量を自動再計算する

### Requirement 9: 調整係数
**Objective:** 積算担当者として、計算結果に係数を乗算して実際の発注数量に調整したい（例：残土処分のほぐし係数等）。

#### Acceptance Criteria
1. When 数量項目を追加する THEN システムは調整係数列に「1.00」をデフォルト値として設定する
2. When 調整係数列に数値を入力する THEN システムは計算結果に調整係数を乗算した値を数量として設定する
3. If 調整係数列に0以下の値が入力される THEN システムは警告メッセージを表示し、確認を求める
4. If 調整係数列に数値以外の文字が入力される THEN システムは入力を拒否しエラーメッセージを表示する
5. While 調整係数が設定されている状態で THE システムは計算元の値変更時に調整係数を適用した数量を自動再計算する

### Requirement 10: 丸め設定
**Objective:** 積算担当者として、最終数量を発注単位に合わせて丸めたい（例：コンクリートの0.25m3単位での切り上げ等）。

#### Acceptance Criteria
1. When 数量項目を追加する THEN システムは丸め設定列に「0.01」をデフォルト値として設定する
2. When 丸め設定列に数値を入力する THEN システムは調整係数適用後の値を指定された単位で切り上げた値を最終数量として設定する
3. If 丸め設定列に0以下の値が入力される THEN システムはエラーメッセージを表示し、正の値の入力を求める
4. If 丸め設定列に数値以外の文字が入力される THEN システムは入力を拒否しエラーメッセージを表示する
5. While 丸め設定が適用されている状態で THE システムは計算元または調整係数の変更時に丸め処理を適用した最終数量を自動再計算する

### Requirement 11: 参照合計計算
**Objective:** 積算担当者として、他の数量項目の合計を参照して数量を自動計算したい。

#### Acceptance Criteria
1. When 参照合計モードを選択する THEN システムは他の数量項目選択UIを表示する
2. When 参照する数量項目を選択する THEN システムは選択項目の数量合計を自動計算し、数量フィールドに反映する
3. While 参照合計が設定されている状態で THE システムは参照元の数量変更時に自動再計算する
4. Where 参照合計で循環参照が発生した場合に THE システムは循環参照を検出しエラーメッセージを表示する
5. If 参照先の数量項目が削除される THEN システムは参照エラーを検出し、警告メッセージを表示する

### Requirement 12: 数量表の保存
**Objective:** 積算担当者として、作成した数量表を保存したい。

#### Acceptance Criteria
1. When 数量表の保存操作を行う THEN システムは全ての数量グループと数量項目をデータベースに保存する
2. If データ保存時に整合性チェックでエラーが検出される THEN システムは保存を中断し、問題箇所の修正を求める
3. When 計算方法と入力値の不整合（面積・体積モードで計算用列が未入力等）が検出される THEN システムはエラー箇所を明示し、修正を求める
4. Where 数量項目に不整合がある場合に THE システムは警告メッセージを表示し、問題箇所をハイライト表示する
5. While 自動保存が有効な状態で THE システムは一定間隔で数量表を自動保存する

### Requirement 13: パンくずナビゲーション
**Objective:** 積算担当者として、現在の画面位置を把握し、上位階層へ簡単に移動したい。

#### Acceptance Criteria
1. When 数量表一覧画面を表示する THEN システムは「プロジェクト一覧 > {プロジェクト名} > 数量表」のパンくずナビゲーションを表示する
2. When 数量表編集画面を表示する THEN システムは「プロジェクト一覧 > {プロジェクト名} > 数量表 > {数量表名}」のパンくずナビゲーションを表示する
3. When 数量表新規作成画面を表示する THEN システムは「プロジェクト一覧 > {プロジェクト名} > 数量表 > 新規作成」のパンくずナビゲーションを表示する
4. When パンくずナビゲーションの各項目をクリックする THEN システムは該当画面に遷移する
5. While パンくずナビゲーションが表示されている状態で THE システムは現在の画面を示す項目をクリック不可（非リンク）として表示する

