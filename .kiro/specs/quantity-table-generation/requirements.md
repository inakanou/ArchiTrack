# Requirements Document

## Introduction

数量表作成機能は、積算担当者が現場調査結果に基づいて数量を拾い出し、調査写真と紐づけながら数量表を作成するための機能です。本機能により、従来の手作業による積算作業を効率化し、正確性の向上とトレーサビリティの確保を実現します。

### ビジネス価値
- 積算作業の効率化と標準化
- 現場調査写真との紐づけによるトレーサビリティ確保
- 計算ミスの削減と品質向上

### 機能概要
1つのプロジェクトに対して複数の数量表を作成できます。各数量表は複数の「数量グループ」で構成され、各数量グループには現場調査写真を紐づけることができます。数量グループ内には複数の「数量項目」を追加でき、各項目は大項目・中項目・小項目・任意分類・工種・名称・規格・計算方法・（計算用列）・数量・単位・備考の属性を持ちます。

**列順序仕様:**
- メインの行（標準計算時）: 大項目・中項目・小項目・任意分類・工種・名称・規格・計算方法・数量・単位・備考
- 面積・体積計算時の計算用列: 幅（W）・奥行き（D）・高さ（H）・重量・調整係数・丸め設定
- ピッチ計算時の計算用列: 範囲長・端長1・端長2・ピッチ長・長さ・重量・調整係数・丸め設定

**注記:** 「調整係数」「丸め設定」は計算方法が「面積・体積」または「ピッチ」の場合のみ表示され、それぞれの計算用フィールド群の末尾に配置されます。計算方法が「標準」の場合、調整係数・丸め設定はメインの行には表示されません。

### フィールド仕様

#### テキストフィールド（分類・基本情報）

| フィールド | 必須 | 配置 | 最大文字数 | デフォルト値 |
|-----------|------|------|------------|--------------|
| 大項目 | - | 左寄せ | 全角25文字/半角50文字 | 空白 |
| 中項目 | - | 左寄せ | 全角25文字/半角50文字 | 空白 |
| 小項目 | - | 左寄せ | 全角25文字/半角50文字 | 空白 |
| 任意分類 | - | 左寄せ | 全角25文字/半角50文字 | 空白 |
| 工種 | 必須 | 左寄せ | 全角8文字/半角16文字 | 空白 |
| 名称 | 必須 | 左寄せ | 全角25文字/半角50文字 | 空白 |
| 規格 | - | 左寄せ | 全角25文字/半角50文字 | 空白 |
| 単位 | 必須 | 左寄せ | 全角3文字/半角6文字 | 空白 |
| 計算方法 | 必須 | 左寄せ | 全角25文字/半角50文字 | 標準 |
| 備考 | - | 左寄せ | 全角25文字/半角50文字 | 空白 |

#### 数値フィールド（計算パラメータ）

| フィールド | 必須 | 配置 | 入力可能範囲 | デフォルト値 | 表示書式 | 空白時動作 | 表示条件 |
|-----------|------|------|--------------|--------------|----------|------------|----------|
| 数量 | 必須 | 右寄せ | -999999.99〜9999999.99 | 0 | 小数2桁常時表示 | デフォルト値を自動入力 | 常時表示 |
| 調整係数 | 必須 | 右寄せ | -9.99〜9.99 | 1.00 | 小数2桁常時表示 | デフォルト値を自動入力 | 面積・体積/ピッチ選択時のみ |
| 丸め設定 | 必須 | 右寄せ | -99.99〜99.99 | 0.01 | 小数2桁常時表示 | 0または空白でデフォルト値を自動入力 | 面積・体積/ピッチ選択時のみ |

**注記**: 「調整係数」「丸め設定」はメインの行には表示されず、計算方法が「面積・体積」または「ピッチ」の場合にのみ、それぞれの計算用フィールド群の末尾に表示されます。計算方法が「標準」の場合、これらのフィールドは表示されません。

#### 寸法フィールド（面積・体積計算用）

| フィールド | 必須 | 配置 | 入力可能範囲 | デフォルト値 | 表示書式 |
|-----------|------|------|--------------|--------------|----------|
| 幅(W) | - | 右寄せ | 0.01〜9999999.99または空白 | 空白 | 数値入力時は小数2桁、空白時は表示なし |
| 奥行き(D) | - | 右寄せ | 0.01〜9999999.99または空白 | 空白 | 数値入力時は小数2桁、空白時は表示なし |
| 高さ(H) | - | 右寄せ | 0.01〜9999999.99または空白 | 空白 | 数値入力時は小数2桁、空白時は表示なし |
| 重量（面積・体積計算用） | - | 右寄せ | 0.01〜9999999.99または空白 | 空白 | 数値入力時は小数2桁、空白時は表示なし |
| 調整係数（面積・体積計算用） | 必須 | 右寄せ | -9.99〜9.99 | 1.00 | 小数2桁常時表示 |
| 丸め設定（面積・体積計算用） | 必須 | 右寄せ | -99.99〜99.99 | 0.01 | 小数2桁常時表示 |

**制約**: 計算方法が「面積・体積」の場合、幅(W)、奥行き(D)、高さ(H)のうち最低1つの入力が必須

**フィールド順序**: 幅(W) → 奥行き(D) → 高さ(H) → 重量 → 調整係数 → 丸め設定

#### ピッチ計算フィールド

| フィールド | 必須 | 配置 | 入力可能範囲 | デフォルト値 | 表示書式 |
|-----------|------|------|--------------|--------------|----------|
| 範囲長 | 必須 | 右寄せ | 0.01〜9999999.99または空白 | 空白 | 数値入力時は小数2桁、空白時は表示なし |
| 端長1 | 必須 | 右寄せ | 0.01〜9999999.99または空白 | 空白 | 数値入力時は小数2桁、空白時は表示なし |
| 端長2 | 必須 | 右寄せ | 0.01〜9999999.99または空白 | 空白 | 数値入力時は小数2桁、空白時は表示なし |
| ピッチ長 | 必須 | 右寄せ | 0.01〜9999999.99または空白 | 空白 | 数値入力時は小数2桁、空白時は表示なし |
| 長さ（ピッチ計算用） | - | 右寄せ | 0.01〜9999999.99または空白 | 空白 | 数値入力時は小数2桁、空白時は表示なし |
| 重量（ピッチ計算用） | - | 右寄せ | 0.01〜9999999.99または空白 | 空白 | 数値入力時は小数2桁、空白時は表示なし |
| 調整係数（ピッチ計算用） | 必須 | 右寄せ | -9.99〜9.99 | 1.00 | 小数2桁常時表示 |
| 丸め設定（ピッチ計算用） | 必須 | 右寄せ | -99.99〜99.99 | 0.01 | 小数2桁常時表示 |

**制約**: 計算方法が「ピッチ」の場合、範囲長、端長1、端長2、ピッチ長の4項目すべてが必須

**フィールド順序**: 範囲長 → 端長1 → 端長2 → ピッチ長 → 長さ → 重量 → 調整係数 → 丸め設定

## Requirements

### Requirement 1: プロジェクト詳細画面の数量表セクション
**Objective:** 積算担当者として、プロジェクト詳細画面から数量表へ簡単にアクセスしたい。

#### Acceptance Criteria
1. When プロジェクト詳細画面を表示する, the 数量表管理システム shall 数量表セクションを表示する
2. While 数量表セクションが表示されている状態で, the 数量表管理システム shall 数量表の総数（全N件）とヘッダーを表示する
3. Where プロジェクトに数量表が存在する場合, the 数量表管理システム shall 直近の数量表カード（名称・更新日時・数量項目数）を一覧表示する
4. When 数量表セクションの「すべて見る」リンクをクリックする, the 数量表管理システム shall 数量表一覧画面（/projects/{projectId}/quantity-tables）に遷移する
5. When 数量表カードをクリックする, the 数量表管理システム shall 該当数量表の編集画面（/projects/{projectId}/quantity-tables/{quantityTableId}）に遷移する
6. Where プロジェクトに数量表が存在しない場合, the 数量表管理システム shall 「数量表はまだありません」メッセージと新規作成ボタンを表示する
7. When 新規作成ボタンをクリックする, the 数量表管理システム shall 数量表新規作成画面（/projects/{projectId}/quantity-tables/new）に遷移する

### Requirement 2: 数量表の作成・管理
**Objective:** 積算担当者として、プロジェクトに対して複数の数量表を作成・管理したい。

#### Acceptance Criteria
1. When 数量表一覧画面で新規作成操作を行う, the 数量表管理システム shall 数量表名を入力するダイアログを表示する
2. When 数量表名を入力して作成を確定する, the 数量表管理システム shall 新しい数量表を作成し、数量表編集画面に遷移する
3. When 数量表一覧画面を表示する, the 数量表管理システム shall プロジェクトに紐づく全ての数量表を作成日時順に一覧表示する
4. When 数量表を選択して削除操作を行う, the 数量表管理システム shall 確認ダイアログを表示し、確認後に数量表と配下の全データを削除する
5. When 数量表名を編集する, the 数量表管理システム shall 変更を即座に保存する

### Requirement 3: 数量表編集画面の表示
**Objective:** 積算担当者として、数量表編集画面で数量表を編集したい。効率的に数量を拾い出すために、関連する現場調査写真を参照しながら作業できるようにしたい。

#### Acceptance Criteria
1. When 数量表編集画面を表示する, the 数量表管理システム shall 数量表編集エリアと関連写真表示エリアを表示する
2. While 数量表編集画面が表示されている状態で, the 数量表管理システム shall 数量グループ一覧と各グループ内の数量項目を階層的に表示する
3. Where 数量グループに写真が紐づけられている場合, the 数量表管理システム shall 該当写真のオリジナル画像（注釈付き）を関連写真表示エリアに表示する
4. When 数量グループを折りたたむ, the 数量表管理システム shall 関連写真表示エリアの画像も含めて折りたたむ（グループを畳むと画像も非表示になる）

### Requirement 4: 数量グループの作成・管理
**Objective:** 積算担当者として、現場調査写真に基づいた数量グループを作成し、関連する数量項目をグループ化して管理したい。

#### Acceptance Criteria
1. When 数量表編集画面で数量グループ追加操作を行う, the 数量表管理システム shall 新しい数量グループを数量表に追加する
2. When 数量グループが追加される, the 数量表管理システム shall 同一プロジェクトの注釈付き現場調査写真選択機能を提供する
3. When 数量グループ内で写真選択操作を行う, the 数量表管理システム shall 同一プロジェクトの注釈付き現場写真一覧を表示し選択可能にする
4. Where 数量グループに写真が紐づけられている状態で, the 数量表管理システム shall 注釈付き写真と数量項目の関連性を視覚的に表示する
5. When 数量グループの削除操作を行う, the 数量表管理システム shall 確認ダイアログを表示し、確認後に数量グループと配下の数量項目を削除する

### Requirement 5: 数量項目の追加・編集
**Objective:** 積算担当者として、数量グループ内に数量項目を追加し、必要な属性を入力したい。

#### Acceptance Criteria
1. When 数量グループ内で行追加操作を行う, the 数量表管理システム shall 「大項目・中項目・小項目・任意分類・工種・名称・規格・計算方法・（計算用列）・数量・単位・備考」で構成される新しい数量項目を追加し、デフォルト値を設定する（大項目：空白、工種：空白、名称：空白、単位：空白、計算方法：「標準」、数量：「0」）
2. When 数量項目の各フィールドに値を入力する, the 数量表管理システム shall 入力値を即座に反映する
3. If 必須フィールド（工種・名称・単位・計算方法・数量）が未入力で保存を試行する, then the 数量表管理システム shall 該当フィールドをハイライトし、エラーメッセージを表示する
4. When 数量項目を選択して削除操作を行う, the 数量表管理システム shall 選択された数量項目を削除する
5. Where 計算方法が「標準」の場合, the 数量表管理システム shall メインの行に調整係数・丸め設定を表示しない

### Requirement 6: 数量項目のコピー・移動
**Objective:** 積算担当者として、数量項目を柔軟に操作し、効率的に数量表を構築したい。

#### Acceptance Criteria
1. When 数量項目を選択してコピー操作を行う, the 数量表管理システム shall 選択された数量項目を直下に複製する
2. When 数量項目を選択して移動操作を行う, the 数量表管理システム shall 移動先選択UI（同一数量グループ内または別数量グループ）を表示する
3. When 移動先として同一数量グループ内の位置が選択される, the 数量表管理システム shall 選択数量項目を指定位置に移動する
4. If 移動先に別数量グループが選択される, then the 数量表管理システム shall 選択数量項目を移動先数量グループに移動し、元の位置から削除する
5. When 複数の数量項目を選択して一括操作を行う, the 数量表管理システム shall 選択された全ての項目に対して削除・コピー・移動操作を実行する

### Requirement 7: 入力支援・オートコンプリート
**Objective:** 積算担当者として、一貫性のある入力を効率的に行い、入力ミスを削減したい。

#### Acceptance Criteria
1. When 大項目フィールドに入力を開始する, the 数量表管理システム shall 同一プロジェクト内で過去に入力された大項目値をオートコンプリート候補として表示する
2. When 中項目フィールドに入力を開始する, the 数量表管理システム shall 同一プロジェクト内で過去に入力された中項目値をオートコンプリート候補として表示する
3. When 小項目・任意分類・工種・名称・規格・単位・備考の各フィールドに入力を開始する, the 数量表管理システム shall 同一プロジェクト内の対応フィールドの入力履歴をオートコンプリート候補として表示する
4. When オートコンプリート候補が選択される, the 数量表管理システム shall 選択された値を該当フィールドに自動入力する
5. Where 同一フィールドで複数の候補がある場合, the 数量表管理システム shall 50音順に候補を表示する

### Requirement 8: 計算方法の選択
**Objective:** 積算担当者として、数量の算出方法を選択し、状況に応じた計算方式で数量を効率的に算出したい。

#### Acceptance Criteria
1. When 数量項目を追加する, the 数量表管理システム shall 計算方法列に「標準」をデフォルト値として設定する
2. When 計算方法列で「標準」が選択されている状態で数量フィールドに直接数値を入力する, the 数量表管理システム shall 入力された数値を数量として設定する
3. If 計算方法が「標準」で数量フィールドに負の値が入力される, then the 数量表管理システム shall 警告メッセージを表示し、確認を求める
4. If 計算方法が「標準」で数量フィールドに数値以外の文字が入力される, then the 数量表管理システム shall 入力を拒否しエラーメッセージを表示する
5. When 計算方法列で「面積・体積」が選択される, the 数量表管理システム shall 計算用列として「幅（W）」「奥行き（D）」「高さ（H）」「重量」「調整係数」「丸め設定」入力フィールドをこの順序で表示する
6. When 「面積・体積」モードで計算用列に1つ以上の値が入力される, the 数量表管理システム shall 入力された項目のみを掛け算して計算結果を数量として自動設定する
7. If 「面積・体積」モードで計算用列に値が1つも入力されていない状態で保存を試行する, then the 数量表管理システム shall エラーメッセージを表示し、幅(W)・奥行き(D)・高さ(H)のうち最低1項目の入力を求める
8. When 計算方法列で「ピッチ」が選択される, the 数量表管理システム shall 計算用列として「範囲長」「端長1」「端長2」「ピッチ長」「長さ」「重量」「調整係数」「丸め設定」入力フィールドをこの順序で表示する
9. When 「ピッチ」モードで必須項目（範囲長・端長1・端長2・ピッチ長）に値が入力される, the 数量表管理システム shall ピッチ計算式に基づいて本数を算出し、任意項目（長さ・重量）が入力されている場合はそれらを乗算した結果を数量として自動設定する
10. If 「ピッチ」モードで必須項目（範囲長・端長1・端長2・ピッチ長）のいずれかが未入力で保存を試行する, then the 数量表管理システム shall エラーメッセージを表示し、必須項目の入力を求める
11. While 計算方法が「面積・体積」または「ピッチ」で計算用列に値が設定されている状態で, the 数量表管理システム shall 計算用列の値変更時に数量を自動再計算する

### Requirement 9: 調整係数
**Objective:** 積算担当者として、計算結果に係数を乗算して実際の発注数量に調整したい（例：残土処分のほぐし係数等）。

**表示条件:** 調整係数フィールドは計算方法が「面積・体積」または「ピッチ」の場合のみ表示され、それぞれの計算用フィールド群（面積・体積：幅・奥行き・高さ・重量の後、ピッチ：範囲長・端長1・端長2・ピッチ長・長さ・重量の後）に配置されます。

#### Acceptance Criteria
1. When 計算方法が「面積・体積」または「ピッチ」に設定される, the 数量表管理システム shall 調整係数フィールドを計算用フィールド群の末尾（丸め設定の前）に「1.00」をデフォルト値として表示する
2. When 調整係数フィールドに数値を入力する, the 数量表管理システム shall 計算結果に調整係数を乗算した値を数量として設定する
3. When 調整係数フィールドに入力可能範囲（-9.99〜9.99）外の値が入力される, the 数量表管理システム shall エラーメッセージを表示し、範囲内の値の入力を求める
4. When 調整係数フィールドに空白が入力される, the 数量表管理システム shall 自動的にデフォルト値「1.00」を設定する
5. If 調整係数フィールドに数値以外の文字が入力される, then the 数量表管理システム shall 入力を拒否しエラーメッセージを表示する
6. While 調整係数が設定されている状態で, the 数量表管理システム shall 計算元の値変更時に調整係数を適用した数量を自動再計算する
7. The 数量表管理システム shall 調整係数を小数2桁で常に表示する（例：1を入力したら1.00と表示）
8. Where 計算方法が「標準」の場合, the 数量表管理システム shall 調整係数フィールドを表示しない

### Requirement 10: 丸め設定
**Objective:** 積算担当者として、最終数量を発注単位に合わせて丸めたい（例：コンクリートの0.25m3単位での切り上げ等）。

**表示条件:** 丸め設定フィールドは計算方法が「面積・体積」または「ピッチ」の場合のみ表示され、それぞれの計算用フィールド群の末尾（調整係数の後）に配置されます。

#### Acceptance Criteria
1. When 計算方法が「面積・体積」または「ピッチ」に設定される, the 数量表管理システム shall 丸め設定フィールドを計算用フィールド群の末尾（調整係数の後）に「0.01」をデフォルト値として表示する
2. When 丸め設定フィールドに数値を入力する, the 数量表管理システム shall 調整係数適用後の値を指定された単位で切り上げた値を最終数量として設定する
3. When 丸め設定フィールドに入力可能範囲（-99.99〜99.99）外の値が入力される, the 数量表管理システム shall エラーメッセージを表示し、範囲内の値の入力を求める
4. When 丸め設定フィールドに0または空白が入力される, the 数量表管理システム shall 自動的にデフォルト値「0.01」を設定する
5. If 丸め設定フィールドに数値以外の文字が入力される, then the 数量表管理システム shall 入力を拒否しエラーメッセージを表示する
6. While 丸め設定が適用されている状態で, the 数量表管理システム shall 計算元または調整係数の変更時に丸め処理を適用した最終数量を自動再計算する
7. The 数量表管理システム shall 丸め設定を小数2桁で常に表示する（例：1を入力したら1.00と表示）
8. Where 計算方法が「標準」の場合, the 数量表管理システム shall 丸め設定フィールドを表示しない

### Requirement 11: 数量表の保存
**Objective:** 積算担当者として、作成した数量表を保存したい。

#### Acceptance Criteria
1. When 数量表の保存操作を行う, the 数量表管理システム shall 全ての数量グループと数量項目をデータベースに保存する
2. If データ保存時に整合性チェックでエラーが検出される, then the 数量表管理システム shall 保存を中断し、問題箇所の修正を求める
3. When 計算方法と入力値の不整合（面積・体積モードで計算用列が未入力等）が検出される, the 数量表管理システム shall エラー箇所を明示し、修正を求める
4. Where 数量項目に不整合がある場合, the 数量表管理システム shall 警告メッセージを表示し、問題箇所をハイライト表示する
5. While 自動保存が有効な状態で, the 数量表管理システム shall 一定間隔で数量表を自動保存する

### Requirement 12: パンくずナビゲーション
**Objective:** 積算担当者として、現在の画面位置を把握し、上位階層へ簡単に移動したい。

#### Acceptance Criteria
1. When 数量表一覧画面を表示する, the 数量表管理システム shall 「プロジェクト一覧 > {プロジェクト名} > 数量表」のパンくずナビゲーションを表示する
2. When 数量表編集画面を表示する, the 数量表管理システム shall 「プロジェクト一覧 > {プロジェクト名} > 数量表 > {数量表名}」のパンくずナビゲーションを表示する
3. When 数量表新規作成画面を表示する, the 数量表管理システム shall 「プロジェクト一覧 > {プロジェクト名} > 数量表 > 新規作成」のパンくずナビゲーションを表示する
4. When パンくずナビゲーションの各項目をクリックする, the 数量表管理システム shall 該当画面に遷移する
5. While パンくずナビゲーションが表示されている状態で, the 数量表管理システム shall 現在の画面を示す項目をクリック不可（非リンク）として表示する

### Requirement 13: テキストフィールドの入力制御
**Objective:** 積算担当者として、テキストフィールドへの入力が適切に制御され、データの一貫性が保たれるようにしたい。

#### Acceptance Criteria
1. When 大項目・中項目・小項目・任意分類・名称・規格・計算方法・備考フィールドに入力する, the 数量表管理システム shall 最大文字数（全角25文字/半角50文字）を超える入力を防止する
2. When 工種フィールドに入力する, the 数量表管理システム shall 最大文字数（全角8文字/半角16文字）を超える入力を防止する
3. When 単位フィールドに入力する, the 数量表管理システム shall 最大文字数（全角3文字/半角6文字）を超える入力を防止する
4. The 数量表管理システム shall 全てのテキストフィールドを左寄せで表示する

### Requirement 14: 数値フィールドの表示書式
**Objective:** 積算担当者として、数値フィールドが統一された書式で表示され、視認性が向上するようにしたい。

#### Acceptance Criteria
1. The 数量表管理システム shall 調整係数・丸め設定・数量フィールドを右寄せで表示する
2. The 数量表管理システム shall 調整係数・丸め設定・数量フィールドを小数2桁で常に表示する（例：1を入力したら1.00と表示）
3. When 寸法フィールド（幅・奥行き・高さ・重量）またはピッチ計算フィールド（範囲長・端長1・端長2・ピッチ長・長さ・重量）に数値を入力する, the 数量表管理システム shall 小数2桁で表示する
4. When 寸法フィールドまたはピッチ計算フィールドが空白の場合, the 数量表管理システム shall 小数2桁の表示を行わず空白のまま表示する
5. The 数量表管理システム shall 全ての数値フィールドを右寄せで表示する

### Requirement 15: 数量フィールドの入力制御
**Objective:** 積算担当者として、数量フィールドへの入力が適切に制御され、計算の正確性が保たれるようにしたい。

#### Acceptance Criteria
1. When 数量フィールドに入力可能範囲（-999999.99〜9999999.99）外の値が入力される, the 数量表管理システム shall エラーメッセージを表示し、範囲内の値の入力を求める
2. When 数量フィールドに空白が入力される, the 数量表管理システム shall 自動的にデフォルト値「0」を設定し、「0.00」と表示する
3. When 寸法フィールドまたはピッチ計算フィールドに入力可能範囲（0.01〜9999999.99）外の値が入力される, the 数量表管理システム shall エラーメッセージを表示し、範囲内の値の入力を求める
