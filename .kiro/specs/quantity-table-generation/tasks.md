# Implementation Plan

## Tasks

- [x] 1. データベーススキーマと基盤サービスの実装
- [x] 1.1 (P) 数量表、数量グループ、数量項目のデータモデルを作成する
  - QuantityTable、QuantityGroup、QuantityItemのPrismaスキーマを定義
  - CalculationMethod列挙型（STANDARD、AREA_VOLUME、PITCH）を追加
  - プロジェクト、現場調査画像とのリレーション設定
  - displayOrderによる表示順序管理
  - 楽観的排他制御用のupdatedAtフィールド
  - 必要なインデックスの作成
  - _Requirements: 2.1, 2.2, 3.2, 4.1, 5.1_

- [x] 1.2 (P) 計算エンジンの共有ロジックを実装する
  - Decimal.jsによる高精度演算機能
  - 面積・体積計算（入力項目のみを乗算）
  - ピッチ計算（本数算出と任意項目の乗算）
  - 調整係数の適用処理
  - 丸め処理（指定単位での切り上げ）
  - 計算式の文字列生成（トレーサビリティ用）
  - フロントエンドとバックエンドで共有可能な設計
  - _Requirements: 8.1, 8.2, 8.5, 8.6, 8.8, 8.9, 9.2, 10.2_

- [x] 2. 数量表サービス層の実装
- [x] 2.1 数量表のCRUD操作を実装する
  - 数量表の作成処理（プロジェクトとの関連付け）
  - 数量表の取得処理（ID検索、プロジェクトID検索）
  - 数量表の更新処理（名称変更、楽観的排他制御）
  - 数量表の削除処理（確認後のカスケード削除）
  - プロジェクト詳細画面向けサマリー取得
  - ページネーションとソート機能
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 1.2, 1.3_

- [x] 2.2 数量グループの管理機能を実装する
  - 数量グループの作成処理
  - 現場調査画像との紐付け・解除機能
  - グループの表示順序管理
  - グループ削除時の配下項目カスケード削除
  - グループ詳細取得（項目と画像情報を含む）
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 3.2, 3.3_

- [x] 2.3 数量項目のCRUD操作を実装する
  - 数量項目の作成処理（全属性の設定）
  - 数量項目の更新処理（楽観的排他制御）
  - 数量項目の削除処理
  - 必須フィールドのバリデーション
  - 表示順序の管理
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 2.4 数量項目のコピー・移動機能を実装する
  - 項目の複製処理（直下に配置）
  - 同一グループ内での移動処理
  - 別グループへの移動処理
  - 複数項目の一括操作処理
  - 移動時の表示順序自動調整
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 2.5 計算検証とバリデーションを実装する
  - 計算方法と入力値の整合性チェック
  - 面積・体積モードでの最低1項目入力検証
  - ピッチモードでの必須項目検証
  - 調整係数の範囲チェック（0以下で警告）
  - 丸め設定の範囲チェック（0以下でエラー）
  - 負の値入力時の警告処理
  - _Requirements: 8.3, 8.4, 8.7, 8.10, 9.3, 9.4, 10.3, 10.4_

- [x] 3. APIルートの実装
- [x] 3.1 (P) 数量表APIエンドポイントを実装する
  - 数量表一覧取得API（プロジェクト別）
  - 数量表サマリー取得API（プロジェクト詳細用）
  - 数量表詳細取得API
  - 数量表作成API
  - 数量表更新API
  - 数量表削除API
  - Zodスキーマによる入力検証
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 1.2, 1.3_

- [x] 3.2 (P) 数量グループAPIエンドポイントを実装する
  - グループ一覧取得API
  - グループ詳細取得API
  - グループ作成API
  - グループ更新API
  - グループ削除API
  - 画像紐付け・解除API
  - グループ順序変更API
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 3.3 (P) 数量項目APIエンドポイントを実装する
  - 項目一覧取得API
  - 項目詳細取得API
  - 項目作成API
  - 項目更新API
  - 項目削除API
  - 項目コピーAPI
  - 項目移動API
  - 一括操作API
  - 順序変更API
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 3.4 (P) オートコンプリートAPIエンドポイントを実装する
  - 列別の入力候補取得API
  - プロジェクト内の保存済み値の集約
  - 重複除去と50音順ソート
  - 最大100件制限
  - _Requirements: 7.1, 7.2, 7.3, 7.5_

- [x] 4. フロントエンド基盤コンポーネントの実装
- [x] 4.1 プロジェクト詳細画面の数量表セクションを実装する
  - 数量表セクションカードの表示
  - 総数とヘッダー情報の表示
  - 直近の数量表カード一覧（名称・更新日時・項目数）
  - 「すべて見る」リンクの配置
  - 数量表カードのクリックナビゲーション
  - 数量表が存在しない場合のメッセージと新規作成ボタン
  - 新規作成ボタンのナビゲーション
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7_

- [x] 4.2 数量表一覧画面を実装する
  - 数量表一覧の表示（作成日時順）
  - 新規作成ダイアログの表示
  - 数量表名入力と作成処理
  - 数量表選択時の編集画面遷移
  - 削除操作と確認ダイアログ
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 4.3 パンくずナビゲーションを実装する
  - 数量表一覧画面用パンくず
  - 数量表編集画面用パンくず
  - 数量表新規作成画面用パンくず
  - 各項目クリック時の画面遷移
  - 現在画面の項目を非リンク表示
  - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5_

- [x] 5. 数量表編集画面の実装
- [x] 5.1 数量表編集画面のレイアウトを実装する
  - 数量表編集エリアと関連写真表示エリアの配置
  - 数量グループ一覧の階層的表示
  - グループ展開・折りたたみ機能
  - 保存状態インジケーターの表示
  - _Requirements: 3.1, 3.2_

- [x] 5.2 数量グループコンポーネントを実装する
  - グループ追加機能
  - 同一プロジェクトの注釈付き写真選択UI
  - 写真の紐付け・解除操作
  - 紐付け写真のサムネイル表示
  - グループ削除と確認ダイアログ
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 3.3_

- [x] 5.3 数量項目行コンポーネントを実装する
  - 全属性フィールドの配置と編集機能
  - 行追加操作の実装
  - 行削除操作の実装
  - 入力値の即座反映
  - 必須フィールドのハイライトとエラー表示
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 5.4 数量項目のコピー・移動UIを実装する
  - コピー操作（直下に複製）
  - 移動先選択UIの表示
  - 同一グループ内移動
  - 別グループへの移動
  - 複数選択と一括操作
  - ドラッグ&ドロップによる並べ替え
  - コンテキストメニューからの操作
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 6. 計算機能UIの実装
- [ ] 6.1 計算方法選択コンポーネントを実装する
  - 計算方法ドロップダウン（標準/面積・体積/ピッチ）
  - 標準モードのデフォルト設定
  - 計算方法変更時の計算用列表示切り替え
  - _Requirements: 8.1, 8.5, 8.8_

- [ ] 6.2 計算用フィールドコンポーネントを実装する
  - 面積・体積モード用フィールド（幅/奥行き/高さ/重量）
  - ピッチモード用フィールド（範囲長/端長1/端長2/ピッチ長/長さ/重量）
  - 入力値変更時の自動再計算
  - 入力バリデーションとエラー表示
  - _Requirements: 8.5, 8.6, 8.8, 8.9, 8.11_

- [ ] 6.3 調整係数入力コンポーネントを実装する
  - デフォルト値1.00の設定
  - 係数入力と自動再計算
  - 0以下入力時の警告表示
  - 数値以外入力の拒否
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 6.4 丸め設定入力コンポーネントを実装する
  - デフォルト値0.01の設定
  - 丸め単位入力と自動再計算
  - 0以下入力時のエラー表示
  - 数値以外入力の拒否
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 6.5 標準モードの数量入力を実装する
  - 直接数値入力
  - 負の値入力時の警告確認
  - 数値以外入力の拒否とエラー表示
  - _Requirements: 8.2, 8.3, 8.4_

- [ ] 7. 入力支援機能の実装
- [ ] 7.1 オートコンプリート入力コンポーネントを実装する
  - 入力開始時の候補表示
  - DB保存済み値と未保存入力値の統合
  - 重複除去と50音順ソート
  - 候補選択時の自動入力
  - 上下キー選択とEnter確定
  - 2文字以上入力での候補表示
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 7.2 各フィールドにオートコンプリートを適用する
  - 大項目フィールド
  - 中項目フィールド
  - 小項目フィールド
  - 任意分類フィールド
  - 工種フィールド
  - 名称フィールド
  - 規格フィールド
  - 単位フィールド
  - 備考フィールド
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 8. 保存機能の実装
- [ ] 8.1 自動保存機能を実装する
  - 1500msデバウンスによる自動保存トリガー
  - 変更検出と保存キューの管理
  - 保存失敗時のリトライ処理
  - ローカルストレージへのドラフト保存
  - beforeunload時の未保存警告
  - _Requirements: 11.5_

- [ ] 8.2 手動保存と整合性チェックを実装する
  - 全データのデータベース保存処理
  - 整合性チェックと問題箇所の明示
  - 計算方法と入力値の不整合検出
  - エラー箇所のハイライト表示
  - 保存状態フィードバック表示
  - _Requirements: 11.1, 11.2, 11.3, 11.4_

- [ ] 9. テストの実装
- [x] 9.1 (P) 計算エンジンの単体テストを実装する
  - 面積・体積計算のテスト
  - ピッチ計算のテスト
  - 調整係数適用のテスト
  - 丸め処理のテスト
  - エッジケースのテスト
  - _Requirements: 8.1, 8.5, 8.6, 8.8, 8.9, 9.2, 10.2_

- [ ] 9.2 (P) サービス層の単体テストを実装する
  - QuantityTableServiceのCRUDテスト
  - QuantityGroupServiceのCRUDテスト
  - QuantityItemServiceのCRUDテスト
  - コピー・移動操作のテスト
  - バリデーションのテスト
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 4.1, 4.5, 5.1, 5.4, 6.1, 6.5_

- [ ] 9.3 (P) APIエンドポイントの統合テストを実装する
  - 数量表APIのテスト
  - 数量グループAPIのテスト
  - 数量項目APIのテスト
  - オートコンプリートAPIのテスト
  - エラーハンドリングのテスト
  - _Requirements: 2.1, 4.1, 5.1, 7.1_

- [ ] 9.4 フロントエンドコンポーネントの単体テストを実装する
  - 数量表セクションカードのテスト
  - 数量グループコンポーネントのテスト
  - 数量項目行コンポーネントのテスト
  - 計算フィールドコンポーネントのテスト
  - オートコンプリートコンポーネントのテスト
  - _Requirements: 1.1, 3.1, 5.1, 8.1, 7.1_

- [ ] 9.5 E2Eテストを実装する
  - 数量表新規作成から保存までのフロー
  - 計算方法変更と数量再計算
  - コピー・移動操作
  - パンくずナビゲーション
  - オートコンプリート操作
  - 自動保存の動作確認
  - _Requirements: 2.1, 2.2, 8.1, 8.5, 8.8, 6.1, 6.4, 12.1, 12.4, 7.4, 11.5_

- [ ] 10. 統合と最終調整
- [ ] 10.1 ルーティングと画面遷移の統合
  - 数量表関連のルート設定
  - プロジェクト詳細画面からの遷移
  - 数量表一覧画面の統合
  - 数量表編集画面の統合
  - 新規作成画面の統合
  - _Requirements: 1.4, 1.5, 1.7, 2.2_

- [ ] 10.2 パフォーマンス最適化
  - 大量項目での仮想スクロール実装
  - 数量グループの遅延読み込み
  - 計算結果のメモ化
  - オートコンプリート候補のキャッシュ
  - _Requirements: 3.2, 7.5, 8.11_
