# Requirements Document

## Introduction

見積依頼機能は、プロジェクトに紐づく協力業者への見積依頼を管理する機能です。プロジェクト詳細画面から見積依頼を作成し、内訳書の項目を選択して、メールまたはFAX送信に必要な情報（宛先、表題、本文）を生成します。生成された情報はクリップボードにコピー可能で、外部メールクライアントやFAX送信での利用を支援します。

## Requirements

### Requirement 1: 見積依頼セクション表示

**Objective:** As a ユーザー, I want プロジェクト詳細画面で見積依頼セクションを確認したい, so that 見積依頼の作成・管理にアクセスできる

#### Acceptance Criteria

1. The システム shall プロジェクト詳細画面の内訳書セクションの下に見積依頼セクションを表示する
2. The システム shall 見積依頼セクションに「新規作成」ボタンを表示する
3. The システム shall 見積依頼セクションに「すべて見る」リンクを表示する
4. When ユーザーが「新規作成」ボタンをクリックしたとき, the システム shall 見積依頼作成画面に遷移する
5. When ユーザーが「すべて見る」リンクをクリックしたとき, the システム shall 見積依頼一覧画面に遷移する

### Requirement 2: 見積依頼一覧画面

**Objective:** As a ユーザー, I want 作成済みの見積依頼を一覧で確認したい, so that 過去の見積依頼を参照・管理できる

#### Acceptance Criteria

1. The システム shall 見積依頼一覧画面にパンくずナビゲーションを表示する
2. The システム shall 見積依頼一覧画面に「新規作成」ボタンを表示する
3. The システム shall 作成済みの見積依頼を一覧形式で表示する
4. The システム shall 一覧に見積依頼の名前、宛先（取引先名）、見積依頼方法（メール/FAX）、参照内訳書名、作成日時を表示する
5. When ユーザーが見積依頼項目をクリックしたとき, the システム shall 該当する見積依頼詳細画面に遷移する
6. The システム shall 一覧表示にページネーションを提供する
7. When 見積依頼が存在しない場合, the システム shall 「見積依頼がありません」というメッセージを表示する

### Requirement 3: 見積依頼新規作成

**Objective:** As a ユーザー, I want 新しい見積依頼を作成したい, so that 協力業者に見積を依頼できる

#### Acceptance Criteria

1. The システム shall 新規作成時に見積依頼の名前入力フィールドを表示する
2. The システム shall 新規作成時に宛先（取引先）選択フィールドを表示する
3. The システム shall 新規作成時に参照する内訳書の選択フィールドを表示する
4. The システム shall 宛先の候補として協力業者である取引先のみを表示する
5. The システム shall 取引先の検索機能を提供する（プロジェクト新規作成時の顧客名検索と同様）
6. When ユーザーが必須項目を入力して保存したとき, the システム shall 見積依頼を作成し詳細画面に遷移する
7. If 必須項目が未入力の場合, then the システム shall バリデーションエラーを表示する
8. If 協力業者の取引先が存在しない場合, then the システム shall 「協力業者が登録されていません」というメッセージを表示する
9. If プロジェクトに内訳書が存在しない場合, then the システム shall 「内訳書が登録されていません」というメッセージを表示する

### Requirement 4: 見積依頼詳細画面 - 項目選択

**Objective:** As a ユーザー, I want 内訳書の項目から見積依頼対象を選択したい, so that 必要な項目のみを見積依頼に含められる

#### Acceptance Criteria

1. The システム shall 見積依頼詳細画面にパンくずナビゲーションを表示する
2. The システム shall 見積依頼詳細画面に指定した内訳書の項目一覧を表示する
3. The システム shall 各項目に選択用のチェックボックスを表示する
4. When ユーザーがチェックボックスを変更したとき, the システム shall 該当項目を見積依頼対象として記録する
5. When ユーザーがチェックボックスを変更したとき, the システム shall 選択状態を自動的に保存する
6. The システム shall 項目一覧の下に「内訳書を本文に含める」チェックボックスを表示する
7. The システム shall 項目一覧の下にExcel出力ボタンを表示する
8. The システム shall 見積依頼方法としてラジオボタン（メール/FAX）を表示する
9. The システム shall 見積依頼方法のデフォルト値をメールとする
10. While 内訳書項目が他の見積依頼で選択済みのとき, the システム shall 該当行の背景色を変更して視覚的に区別する
11. While 内訳書項目が他の見積依頼で選択済みのとき, the システム shall 該当行の一番右の列に依頼先取引先名を表示する
12. While 内訳書項目が複数の見積依頼で選択済みのとき, the システム shall 該当行の一番右の列にすべての依頼先取引先名を表示する
13. If 参照内訳書に項目が存在しない場合, then the システム shall 「内訳書に項目がありません」というメッセージを表示する

### Requirement 5: 内訳書Excel出力

**Objective:** As a ユーザー, I want 選択した内訳書項目をExcelファイルとして出力したい, so that 見積依頼に添付資料として送付できる

#### Acceptance Criteria

1. When ユーザーがExcel出力ボタンをクリックしたとき, the システム shall チェックした項目のみを含むExcelファイルを生成する
2. The システム shall 生成したExcelファイルをダウンロードさせる
3. If 項目が1つも選択されていない場合, then the システム shall エラーメッセージを表示する

### Requirement 6: 見積依頼文表示

**Objective:** As a ユーザー, I want 見積依頼に必要な情報をコピー可能な形式で確認したい, so that メールクライアントやFAX送信に利用できる

#### Acceptance Criteria

1. When ユーザーが「見積依頼文表示」ボタンをクリックしたとき, the システム shall 宛先、表題、本文を表示する
2. While 見積依頼方法がメールのとき, the システム shall 宛先として宛先取引先のメールアドレスを表示する
3. While 見積依頼方法がFAXのとき, the システム shall 宛先として宛先取引先のFAX番号を表示する
4. If 見積依頼方法がメールで取引先にメールアドレスが未登録の場合, then the システム shall 「メールアドレスが登録されていません」というエラーメッセージを表示する
5. If 見積依頼方法がFAXで取引先にFAX番号が未登録の場合, then the システム shall 「FAX番号が登録されていません」というエラーメッセージを表示する
6. The システム shall 表題として「[プロジェクト名] 御見積依頼」を表示する
7. The システム shall 本文を所定のフォーマットで表示する
8. While 「内訳書を本文に含める」がチェックされているとき, the システム shall 本文の【内容】セクションにチェックされた内訳書項目を成形して表示する
9. While 「内訳書を本文に含める」がチェックされていないとき, the システム shall 本文の【内容】セクションに「添付内訳書の通り」と表示する
10. The システム shall 本文の【現場】セクションにプロジェクトの現場住所を表示する

### Requirement 7: クリップボードコピー機能

**Objective:** As a ユーザー, I want 宛先・表題・本文をそれぞれクリップボードにコピーしたい, so that メールクライアントやFAX送信に簡単に利用できる

#### Acceptance Criteria

1. The システム shall 宛先の横にクリップボードコピーボタンを表示する
2. The システム shall 表題の横にクリップボードコピーボタンを表示する
3. The システム shall 本文の横にクリップボードコピーボタンを表示する
4. When ユーザーがクリップボードコピーボタンをクリックしたとき, the システム shall 該当する項目の内容をクリップボードにコピーする
5. When クリップボードへのコピーが成功したとき, the システム shall コピー完了のフィードバックを表示する
6. If クリップボードAPIが利用できない場合, then the システム shall テキストを選択状態にしてコピーを促すフォールバックを提供する

### Requirement 8: 見積依頼データ管理

**Objective:** As a システム管理者, I want 見積依頼データを適切に管理したい, so that データの整合性と追跡性を確保できる

#### Acceptance Criteria

1. The システム shall 見積依頼をプロジェクトに紐づけて保存する
2. The システム shall 見積依頼に選択された項目リストを保存する
3. The システム shall 見積依頼の作成日時と更新日時を記録する
4. The システム shall 見積依頼の削除時に論理削除を行う
5. The システム shall 楽観的排他制御により同時更新を防止する

### Requirement 9: 見積依頼編集・削除

**Objective:** As a ユーザー, I want 作成済みの見積依頼を編集・削除したい, so that 誤りを修正したり不要な見積依頼を整理できる

#### Acceptance Criteria

1. The システム shall 見積依頼詳細画面に編集ボタンを表示する
2. The システム shall 見積依頼詳細画面に削除ボタンを表示する
3. When ユーザーが編集ボタンをクリックしたとき, the システム shall 見積依頼の名前・宛先・内訳書を編集可能にする
4. When ユーザーが削除ボタンをクリックしたとき, the システム shall 削除確認ダイアログを表示する
5. When ユーザーが削除を確認したとき, the システム shall 見積依頼を論理削除し一覧画面に遷移する
6. When ユーザーが編集内容を保存したとき, the システム shall 変更を保存し詳細画面を更新する

### Requirement 10: 権限管理

**Objective:** As a システム管理者, I want 見積依頼の操作権限を適切に制御したい, so that 権限のないユーザーによる不正操作を防止できる

#### Acceptance Criteria

1. The システム shall プロジェクトの閲覧権限を持つユーザーのみに見積依頼の閲覧を許可する
2. The システム shall プロジェクトの編集権限を持つユーザーのみに見積依頼の作成・編集・削除を許可する
3. If 権限のないユーザーが見積依頼にアクセスした場合, then the システム shall アクセス拒否エラーを表示する
4. If 権限のないユーザーが見積依頼を操作しようとした場合, then the システム shall 操作拒否エラーを表示する
