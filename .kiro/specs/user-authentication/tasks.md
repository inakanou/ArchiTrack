# 実装タスク

本ドキュメントは、ユーザー認証機能（user-authentication）の実装タスクを定義します。要件定義書（requirements.md）と技術設計書（design.md）に基づいて、段階的に実装を進めます。

## タスク一覧

- [ ] 1. プロジェクト基盤整備とデータモデル構築
- [ ] 1.1 Prismaスキーマの拡張とデータベースマイグレーション
  - 認証・認可に必要な全テーブルを定義（User、Invitation、RefreshToken、Role、Permission、UserRole、RolePermission、PasswordHistory、TwoFactorBackupCode、AuditLog）
  - データベースインデックス戦略を実装（users.email、invitations.token、refresh_tokens.token、audit_logs複合インデックス等）
  - Prismaマイグレーションを生成・実行してデータベーススキーマを更新
  - _Requirements: 1-27（全要件の基盤）_

- [ ] 1.2 EdDSA鍵ペア生成とJWKSエンドポイント準備
  - EdDSA（Ed25519）鍵ペアを生成するスクリプトを実装
  - 秘密鍵と公開鍵をBase64エンコードして環境変数用に出力
  - JWKSエンドポイント（/.well-known/jwks.json）で公開鍵を配布する機能を実装
  - _Requirements: 5.7, 5.8, 5.9, 5.10_

- [ ] 1.3 新規依存関係のインストールと設定
  - Backend: jose、@node-rs/argon2、nodemailer、bull、handlebars、dataloader、bloom-filters、otplib、qrcode
  - Frontend: zxcvbn
  - 型定義ファイルを含むすべての依存関係をpackage.jsonに追加
  - _Requirements: 2.6, 2.7, 5.7, 7.2, 27.2, 27.3_

- [ ] 1.4 環境変数の設定とBloom Filterデータの準備
  - Backend環境変数を設定（ACCESS_TOKEN_EXPIRY、REFRESH_TOKEN_EXPIRY、TWO_FACTOR_ENCRYPTION_KEY、INITIAL_ADMIN_EMAIL等）
  - Frontend環境変数を設定（VITE_API_BASE_URL、VITE_TOKEN_REFRESH_THRESHOLD）
  - HIBP Pwned Passwordsサブセットをダウンロードし、Bloom Filterに変換するスクリプトを実装
  - _Requirements: 2.7, 3.1, 5.9, 5.10, 27C.4, 27C.5_

- [ ] 2. 認証システムのコア機能実装
- [ ] 2.1 トークン管理サービスの実装
  - JWTアクセストークンとリフレッシュトークンをEdDSA署名で生成する機能を実装
  - JWTトークンの検証とペイロード抽出機能を実装
  - トークンのデコード（検証なし）機能を実装
  - _Requirements: 5.1, 5.2, 5.4, 5.6, 5.7, 5.8, 5.9, 5.10_

- [ ] 2.2 パスワード管理サービスの実装
  - Argon2idアルゴリズムでパスワードハッシュ化機能を実装（メモリコスト: 64MB、時間コスト: 3、並列度: 4）
  - Argon2idでハッシュ化されたパスワードの検証機能を実装
  - パスワード強度検証機能を実装（Bloom Filter + zxcvbn統合、12文字最小、複雑性要件、禁止パスワード照合）
  - パスワード履歴チェック機能を実装（過去3回のArgon2idハッシュ比較、自動削除）
  - _Requirements: 2.6, 2.7, 2.8, 2.9, 7.2, 7.6, 7.7, 7.8, 10.2_

- [ ] 2.3 招待管理サービスの実装
  - 管理者が新規ユーザーを招待する機能を実装（招待トークン生成、7日間有効期限設定）
  - 招待トークンの検証機能を実装（有効期限、使用済みチェック）
  - 招待の取り消し機能を実装（未使用招待を無効化）
  - 招待一覧取得機能を実装（ステータス別フィルタリング対応）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8_

- [ ] 2.4 メール送信サービスの実装
  - nodemailerを使用したメール送信基盤を実装（SMTP設定、テンプレート対応）
  - Redis Bullキューを使用した非同期メール送信機能を実装
  - 招待メール送信機能を実装（招待URL付きテンプレート）
  - パスワードリセットメール送信機能を実装（リセットURL付きテンプレート）
  - メール送信リトライロジックを実装（最大5回、エクスポネンシャルバックオフ）
  - _Requirements: 1.3, 1.6, 7.1, 24.3_

- [ ] 2.5 認証サービスの統合実装
  - ユーザー登録機能を実装（招待トークン検証、パスワード強度チェック、Argon2idハッシュ、トランザクション管理）
  - ログイン機能を実装（メールアドレス・パスワード検証、JWT発行、連続失敗検知、アカウントロック）
  - ログアウト機能を実装（リフレッシュトークン無効化、デバイス別セッション削除）
  - 全デバイスログアウト機能を実装（全リフレッシュトークン無効化）
  - 現在のユーザー情報取得機能を実装
  - _Requirements: 2.1-2.12, 3.1-3.5, 4.1-4.7, 8.1-8.5, 9.1-9.5_

- [ ] 2.6 パスワードリセット機能の実装
  - パスワードリセット要求機能を実装（リセットトークン生成、メール送信）
  - リセットトークン検証機能を実装（24時間有効期限チェック）
  - パスワードリセット実行機能を実装（新パスワード設定、全リフレッシュトークン無効化）
  - パスワード変更機能を実装（現在のパスワード確認、履歴チェック、トークン無効化）
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8_

- [ ] 2.7 認証ミドルウェアの実装
  - JWTトークン検証ミドルウェアを実装（Authorizationヘッダー抽出、EdDSA検証、req.userへユーザー情報設定）
  - トークン期限切れエラーハンドリングを実装（TOKEN_EXPIREDレスポンス、WWW-Authenticateヘッダー）
  - _Requirements: 5.4, 5.5, 16.1, 16.2, 16.18_

- [ ] 2.8 セッション管理機能の実装
  - マルチデバイスセッション管理機能を実装（デバイスごとの独立したリフレッシュトークン）
  - セッション有効期限延長機能を実装（アクティブユーザーの自動延長）
  - セッション一覧取得機能を実装（ユーザーのデバイス別セッション一覧）
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 3. 認可システムの実装
- [ ] 3.1 ロール・権限データモデルの初期化
  - 事前定義ロール（システム管理者、一般ユーザー）を作成するシーディングスクリプトを実装
  - 事前定義権限（adr:*, user:*, role:*, permission:*, settings:*等）を作成するシーディングスクリプトを実装
  - ロールと権限の紐付けを設定（システム管理者: *:*、一般ユーザー: 基本権限）
  - 初期管理者アカウントを作成する機能を実装（環境変数またはシーディング）
  - _Requirements: 3.1, 3.2, 3.3, 6.3, 17（事前定義ロール）, 18（権限定義）_

- [ ] 3.2 RBAC権限チェックサービスの実装
  - ユーザーの権限チェック機能を実装（resource:action形式、ワイルドカード対応）
  - ユーザーの全権限取得機能を実装（複数ロールの権限統合、Prisma include + DataLoader）
  - リソースレベルの権限チェック機能を実装（所有者フィルタリング）
  - _Requirements: 6.1, 6.2, 6.4, 6.7, 6.8, 21.1-21.10_

- [ ] 3.3 ロール管理機能の実装
  - 動的ロール作成機能を実装（名前、説明、優先順位設定）
  - ロール更新機能を実装（監査ログ記録、変更履歴追跡）
  - ロール削除機能を実装（使用中チェック、システムロール保護）
  - ロール一覧取得機能を実装（割り当てユーザー数、権限数を含む）
  - _Requirements: 17.1-17.9_

- [ ] 3.4 権限管理機能の実装
  - 権限一覧取得機能を実装（リソースタイプ、アクション、説明）
  - カスタム権限作成機能を実装（resource:action形式の検証）
  - ワイルドカード権限評価機能を実装（*:read、adr:*、*:*）
  - _Requirements: 18.1-18.7_

- [ ] 3.5 ロール・権限割り当て機能の実装
  - ロールへの権限追加機能を実装（重複チェック、トランザクション管理）
  - ロールからの権限削除機能を実装（システム管理者保護）
  - ユーザーへのロール追加機能を実装（マルチロール対応、トランザクション管理）
  - ユーザーからのロール削除機能を実装（最後の管理者チェック）
  - _Requirements: 19.1-19.8, 20.1-20.9_

- [ ] 3.6 認可ミドルウェアの実装
  - 権限チェックミドルウェアを実装（RBACService統合、必要な権限の検証）
  - 権限不足時のエラーハンドリングを実装（403 Forbidden、監査ログ記録）
  - _Requirements: 6.1, 6.2, 21.1, 21.2, 21.7_

- [ ] 3.7 Redisキャッシング戦略の実装
  - ユーザー権限のRedisキャッシング機能を実装（Cache-Asideパターン、TTL: 15分）
  - キャッシュ無効化機能を実装（ロール・権限変更時、ユーザー・ロール変更時）
  - Graceful Degradation機能を実装（Redis障害時のDB fallback、警告ログ記録）
  - _Requirements: 23.4, 24.2, 24.7_

- [ ] 4. 二要素認証（2FA）の実装
- [ ] 4.1 二要素認証サービスの実装
  - TOTP秘密鍵生成機能を実装（RFC 6238準拠、32バイト暗号学的乱数）
  - 秘密鍵の暗号化・復号化機能を実装（AES-256-GCM、環境変数TWO_FACTOR_ENCRYPTION_KEY）
  - QRコード生成機能を実装（otpauth://totp/ArchiTrack:{email}形式）
  - バックアップコード生成機能を実装（10個、8文字英数字、Argon2idハッシュ）
  - _Requirements: 27.1, 27.2, 27.3, 27.4, 27.5, 27.6, 27.7, 27.8_

- [ ] 4.2 2FA検証機能の実装
  - TOTP検証機能を実装（30秒ウィンドウ、±1ステップ許容、otplib統合）
  - バックアップコード検証機能を実装（未使用コードとArgon2id比較、使用済みマーク）
  - 2FA有効化機能を実装（TOTP検証後、トランザクション管理）
  - 2FA無効化機能を実装（パスワード確認、秘密鍵・バックアップコード削除、全リフレッシュトークン無効化）
  - _Requirements: 27.9, 27.10, 27A.3, 27A.6, 27A.7, 27B.4, 27B.5, 27B.6_

- [ ] 4.3 2FAログインフローの統合
  - 2FA有効ユーザーのログイン処理を実装（メールアドレス・パスワード検証後、2FA_REQUIRED応答）
  - TOTP検証後のJWT発行機能を実装（アクセストークン + リフレッシュトークン）
  - 連続TOTP検証失敗時のアカウントロック機能を実装（5回失敗で5分間ロック）
  - _Requirements: 27A.1, 27A.2, 27A.4, 27A.8_

- [ ] 4.4 バックアップコード管理機能の実装
  - バックアップコード再生成機能を実装（既存コード削除、新規10個生成）
  - 使用済みバックアップコードの視覚化機能を実装（usedAtフィールド更新）
  - 残りバックアップコード数の警告機能を実装（3個以下で警告表示）
  - _Requirements: 27B.1, 27B.2, 27B.3_

- [ ] 5. 監査ログシステムの構築
- [ ] 5.1 監査ログサービスの実装
  - 監査ログ記録機能を実装（実行者、対象、アクション、タイムスタンプ、変更前後の値、メタデータ）
  - 監査ログ取得機能を実装（フィルタリング: ユーザー、日付範囲、アクションタイプ）
  - 監査ログエクスポート機能を実装（JSON形式ダウンロード）
  - _Requirements: 22.1-22.11_

- [ ] 5.2 監査ログアーカイブ機能の実装
  - 月次バッチジョブを実装（13ヶ月以上前のログをアーカイブ、JSON Lines形式、圧縮）
  - アーカイブストレージ統合を実装（S3/GCS、AES-256暗号化）
  - 8年以上前のアーカイブ削除機能を実装（自動削除ポリシー）
  - _Requirements: 22（保持期間・ローテーション）_

- [ ] 5.3 センシティブ操作のアラート機能の実装
  - システム管理者ロール変更時のアラート通知機能を実装
  - 権限変更時の監査ログ記録を実装（ロール作成・更新・削除、権限追加・削除、ユーザー・ロール変更）
  - 2FA有効化・無効化時の監査ログ記録を実装
  - _Requirements: 5.5, 6.5, 17.3, 19.5, 20.5, 22.9, 27C.6_

- [ ] 6. Frontend認証UIの実装
- [ ] 6.1 認証コンテキストとトークン管理の実装
  - React AuthContextを実装（認証状態管理、トークン管理、自動リフレッシュ）
  - TokenRefreshManagerクラスを実装（Race Condition対策、単一Promise共有、Broadcast Channel API統合）
  - Axios Interceptorを実装（Authorizationヘッダー追加、401エラーハンドリング、自動トークンリフレッシュ）
  - 自動リフレッシュスケジュール機能を実装（有効期限5分前に自動リフレッシュ）
  - マルチタブ同期機能を実装（Broadcast Channel APIでトークン更新通知）
  - _Requirements: 16.4, 16.5, 16.6, 16.10, 16.11, 16.12, 16.13, 16.16, 16.17, 16.19_

- [ ] 6.2 ログイン画面の実装
  - LoginFormコンポーネントを実装（メールアドレス、パスワード入力、パスワード表示/非表示切り替え）
  - リアルタイムバリデーション機能を実装（メールアドレス形式、必須フィールド）
  - ローディングスピナーとボタン無効化機能を実装
  - エラーメッセージ表示機能を実装（汎用的なエラーメッセージ、アカウントロック通知）
  - モバイル最適化レイアウトを実装（768px未満でレスポンシブ）
  - _Requirements: 11.1-11.11_

- [ ] 6.3 ユーザー登録画面の実装（招待リンク経由）
  - 招待トークン検証機能を実装（URLパラメータから自動検証）
  - RegisterFormコンポーネントを実装（表示名、パスワード、パスワード確認入力）
  - パスワード強度インジケーターを実装（zxcvbn統合、5段階評価）
  - パスワード要件チェックリストを実装（リアルタイム達成状況表示）
  - 利用規約・プライバシーポリシー同意確認を実装
  - モバイル最適化レイアウトを実装
  - _Requirements: 12.1-12.10_

- [ ] 6.4 管理者ユーザー招待画面の実装
  - 招待フォームを実装（メールアドレス入力、招待ボタン）
  - 招待一覧テーブルを実装（メールアドレス、招待日時、ステータス、有効期限、アクションボタン）
  - 招待URLコピーボタンを実装（クリップボードAPI、トーストメッセージ）
  - 招待取り消し機能を実装（確認ダイアログ、ステータス更新）
  - 招待再送信機能を実装
  - ページネーションまたは無限スクロールを実装（10件以上で有効化）
  - モバイルレイアウトを実装（テーブル→カード形式変換）
  - _Requirements: 13.1-13.11_

- [ ] 6.5 プロフィール画面の実装
  - ユーザー情報セクションを実装（メールアドレス読み取り専用、表示名編集可能、保存ボタン）
  - パスワード変更セクションを実装（現在のパスワード、新しいパスワード、確認入力）
  - パスワード強度インジケーターとチェックリストを統合
  - パスワード変更確認ダイアログを実装（「全デバイスからログアウトされます」通知）
  - 管理者ユーザー向け「ユーザー管理」リンクを実装
  - モバイル最適化レイアウトを実装
  - _Requirements: 14.1-14.10_

- [ ] 6.6 二要素認証（2FA）設定画面の実装
  - 3ステッププログレスバーを実装（QRコードスキャン → TOTP検証 → バックアップコード保存）
  - QRコード表示機能を実装（データURL形式、手動入力用Base32秘密鍵）
  - 6桁TOTP入力フィールドを実装（個別入力フィールド、自動タブ移動）
  - 30秒カウントダウンタイマーと視覚的プログレスバーを実装
  - バックアップコード表示機能を実装（ダウンロード、印刷、クリップボードコピー）
  - バックアップコード保存確認チェックボックスを実装（「完了」ボタンの有効化制御）
  - _Requirements: 27D.1-27D.6_

- [ ] 6.7 二要素認証（2FA）ログイン画面の実装
  - 2FA検証画面を実装（6桁TOTP入力フィールド）
  - 「バックアップコードを使用する」切り替え機能を実装
  - 30秒カウントダウンタイマーを実装
  - TOTP検証エラー表示機能を実装（aria-live対応）
  - _Requirements: 27A.1, 27A.2, 27A.5_

- [ ] 6.8 二要素認証（2FA）管理画面の実装
  - プロフィール画面でのバックアップコード表示機能を実装（使用済みグレーアウト・取り消し線）
  - 残りバックアップコード警告機能を実装（3個以下で警告メッセージと再生成リンク）
  - バックアップコード再生成機能を実装
  - 2FA無効化機能を実装（パスワード確認ダイアログ）
  - _Requirements: 27B.1, 27B.2, 27B.3, 27B.4_

- [ ] 6.9 セッション有効期限切れ時の自動リダイレクト実装
  - 401エラー自動検知機能を実装（Axios Interceptor）
  - 自動トークンリフレッシュ機能を実装（リフレッシュトークン使用、元リクエスト再実行）
  - ログイン画面への自動リダイレクト機能を実装（redirectUrlクエリパラメータ保存）
  - セッション有効期限切れメッセージ表示機能を実装（aria-live対応）
  - 再ログイン成功時の元URLへの自動リダイレクト機能を実装
  - _Requirements: 16.1-16.21_

- [ ] 6.10 共通UI/UXガイドラインの実装
  - レスポンシブデザインを実装（モバイル: 320px-767px、タブレット: 768px-1023px、デスクトップ: 1024px以上）
  - フォーム送信エラー時の自動スクロールとフォーカス機能を実装
  - キーボード操作サポートを実装（Tab、Enter、Space）
  - アクセシビリティ属性を実装（aria-label、aria-describedby、role、aria-live）
  - WCAG 2.1 AA準拠のコントラスト比を実装（最低4.5:1）
  - プログレスバーと進捗メッセージを実装（長時間処理時）
  - ネットワークエラーハンドリングを実装（エラーメッセージ + リトライボタン）
  - トーストメッセージの自動非表示機能を実装
  - モーダルダイアログのフォーカストラップとEscキー閉じ機能を実装
  - autocomplete属性を実装（email、current-password、new-password）
  - _Requirements: 15.1-15.13_

- [ ] 7. Backend API実装
- [ ] 7.1 認証関連APIエンドポイントの実装
  - POST /api/v1/auth/register（ユーザー登録、招待経由）
  - POST /api/v1/auth/login（ログイン）
  - POST /api/v1/auth/verify-2fa（2FA検証）
  - POST /api/v1/auth/logout（ログアウト）
  - POST /api/v1/auth/logout-all（全デバイスログアウト）
  - POST /api/v1/auth/refresh（トークンリフレッシュ）
  - GET /api/v1/users/me（現在のユーザー情報取得）
  - PATCH /api/v1/users/me（ユーザー情報更新）
  - _Requirements: 2, 4, 5, 8, 9, 27A_

- [ ] 7.2 二要素認証（2FA）関連APIエンドポイントの実装
  - POST /api/v1/auth/2fa/setup（2FA設定開始）
  - POST /api/v1/auth/2fa/enable（2FA有効化）
  - POST /api/v1/auth/2fa/disable（2FA無効化）
  - POST /api/v1/auth/2fa/backup-codes/regenerate（バックアップコード再生成）
  - _Requirements: 27, 27A, 27B_

- [ ] 7.3 招待関連APIエンドポイントの実装
  - POST /api/v1/invitations（招待作成）
  - GET /api/v1/invitations（招待一覧取得）
  - POST /api/v1/invitations/:id/revoke（招待取り消し）
  - POST /api/v1/invitations/:id/resend（招待再送信）
  - GET /api/v1/invitations/verify（招待検証）
  - _Requirements: 1_

- [ ] 7.4 パスワード関連APIエンドポイントの実装
  - POST /api/v1/auth/password/reset-request（パスワードリセット要求）
  - GET /api/v1/auth/password/verify-reset（リセットトークン検証）
  - POST /api/v1/auth/password/reset（パスワードリセット実行）
  - _Requirements: 7_

- [ ] 7.5 RBAC関連APIエンドポイントの実装
  - GET /api/v1/roles（ロール一覧取得）
  - POST /api/v1/roles（ロール作成）
  - PATCH /api/v1/roles/:id（ロール更新）
  - DELETE /api/v1/roles/:id（ロール削除）
  - POST /api/v1/roles/:id/permissions（ロールに権限追加）
  - DELETE /api/v1/roles/:id/permissions/:permissionId（ロールから権限削除）
  - GET /api/v1/permissions（権限一覧取得）
  - POST /api/v1/users/:id/roles（ユーザーにロール追加）
  - DELETE /api/v1/users/:id/roles/:roleId（ユーザーからロール削除）
  - _Requirements: 6, 17, 18, 19, 20_

- [ ] 7.6 監査ログ関連APIエンドポイントの実装
  - GET /api/v1/audit-logs（監査ログ取得、フィルタリング対応）
  - _Requirements: 22_

- [ ] 7.7 JWKSエンドポイントの実装
  - GET /.well-known/jwks.json（JWKS公開鍵エンドポイント）
  - _Requirements: 5.7_

- [ ] 8. テスト実装
- [ ] 8.1 Backend単体テストの実装（250+ tests）
  - TokenServiceテスト（15 tests: JWT生成、検証、デコード）
  - PasswordServiceテスト（20 tests: Argon2idハッシュ、検証、強度チェック、リセット）
  - AuthServiceテスト（30 tests: 登録、ログイン、ログアウト、トークンリフレッシュ）
  - InvitationServiceテスト（20 tests: 招待作成、検証、無効化、再送信）
  - RBACServiceテスト（30 tests: 権限チェック、ロール管理、権限管理）
  - SessionServiceテスト（15 tests: セッション作成、削除、検証）
  - TwoFactorServiceテスト（50 tests: TOTP生成・検証、バックアップコード管理）
  - EmailServiceテスト（10 tests: メール送信、キュー管理）
  - AuditLogServiceテスト（10 tests: 監査ログ記録、取得）
  - authenticateミドルウェアテスト（15 tests: トークン検証、エラーハンドリング）
  - authorizeミドルウェアテスト（15 tests: 権限チェック、ワイルドカード対応）
  - _Requirements: 全要件のBackend実装_

- [ ] 8.2 Frontend単体テストの実装（65+ tests）
  - AuthContextテスト（20 tests: ログイン、2FA検証、ログアウト、トークンリフレッシュ）
  - LoginFormテスト（10 tests: バリデーション、送信、エラーハンドリング）
  - RegisterFormテスト（10 tests: バリデーション、パスワード強度、送信）
  - TwoFactorSetupFormテスト（10 tests: QRコード表示、TOTP検証、バックアップコード保存）
  - TwoFactorVerificationFormテスト（5 tests: TOTP検証、バックアップコード検証）
  - PasswordStrengthIndicatorテスト（5 tests: 強度計算、表示）
  - PasswordRequirementsChecklistテスト（5 tests: 要件チェック、表示）
  - _Requirements: 全要件のFrontend実装_

- [ ] 8.3 Storybook実装（25+ stories）
  - LoginFormストーリー（5 stories: Default、With Email、With Error、Loading、Account Locked）
  - RegisterFormストーリー（5 stories: Default、With Weak Password、With Strong Password、Password Mismatch、Loading）
  - TwoFactorSetupFormストーリー（5 stories: QR Code Step、TOTP Verification Step、Backup Codes Step、Error State、Loading）
  - TwoFactorVerificationFormストーリー（4 stories: Default、With Countdown Timer、Backup Code Mode、Error State）
  - PasswordStrengthIndicatorストーリー（4 stories: Weak、Medium、Strong、Very Strong）
  - PasswordRequirementsChecklistストーリー（3 stories: All Failed、Partially Met、All Met）
  - アクセシビリティアドオン統合（@storybook/addon-a11y）
  - _Requirements: 全要件のUI/UX実装_

- [ ] 8.4 統合テストの実装（50 tests）
  - 認証フローテスト（20 tests: ユーザー登録、ログイン、2FAログイン、ログアウト、トークンリフレッシュ、パスワードリセット）
  - 権限チェックフローテスト（10 tests: 権限あり、権限なし、トークンなし、トークン期限切れ、マルチロール）
  - 招待フローテスト（10 tests: 招待作成、検証、取り消し、再送信）
  - 監査ログフローテスト（5 tests: ロール変更、権限変更、ユーザー・ロール変更、2FA有効化・無効化）
  - トランザクション整合性テスト（5 tests: ユーザー登録、パスワードリセット、2FA無効化、ロール割り当て）
  - _Requirements: 全要件の統合フロー_

- [ ] 8.5 E2Eテストの実装（30 tests）
  - 認証フローE2Eテスト（15 tests: 招待→登録→ログイン、2FA設定→ログイン、パスワードリセット、アカウントロック、セッション有効期限切れ、マルチタブ同期）
  - 権限チェックフローE2Eテスト（8 tests: 管理者アクセス、一般ユーザーアクセス、ロール変更、権限なしアクセス）
  - 招待管理フローE2Eテスト（5 tests: 招待作成、取り消し、再送信、URLコピー）
  - UI/UXフローE2Eテスト（2 tests: レスポンシブデザイン、アクセシビリティ）
  - _Requirements: 全要件のE2Eフロー_

- [ ] 8.6 パフォーマンステストの実装（3 tests）
  - ログインAPIパフォーマンステスト（目標: 95パーセンタイルで500ms以内、100同時接続、30秒）
  - 権限チェックAPIパフォーマンステスト（目標: 99パーセンタイルで100ms以内、200同時接続、30秒）
  - トークンリフレッシュAPIパフォーマンステスト（目標: 95パーセンタイルで300ms以内、100同時接続、30秒）
  - _Requirements: 23.1, 23.2, 23.6_

- [ ] 9. セキュリティ対策の実装
- [ ] 9.1 セキュリティヘッダーの実装
  - helmetミドルウェアを統合（Content-Security-Policy、X-Frame-Options、X-Content-Type-Options、Strict-Transport-Security）
  - HTTPS強制リダイレクトとHSTSヘッダーを実装（本番環境）
  - CSRFトークン検証を実装（状態変更API）
  - _Requirements: 26.3, 26.5, 26.6, 26.10_

- [ ] 9.2 レート制限の実装
  - ログインAPIレート制限を実装（10回/分/IP）
  - トークンリフレッシュAPIレート制限を実装（20回/分/IP）
  - 招待APIレート制限を実装（5回/分/ユーザー）
  - IPアドレスベースのブロック機能を実装（短時間の大量リクエスト検知）
  - _Requirements: 26.4, 26.12_

- [ ] 9.3 入力検証とエスケープ処理の実装
  - Zodスキーマによるリクエストバリデーションを実装（全APIエンドポイント）
  - SQLインジェクション対策を実装（Prismaパラメータ化クエリ）
  - XSS対策を実装（Frontendでの自動エスケープ処理）
  - _Requirements: 10.5, 26.1, 26.2_

- [ ] 9.4 機密情報保護の実装
  - ログマスキング処理を実装（パスワード、トークン、秘密鍵）
  - エラーメッセージの汎用化を実装（メールアドレス存在有無の隠蔽）
  - タイミング攻撃対策を実装（ログイン失敗時の一定時間遅延）
  - _Requirements: 10.1, 26.9, 26.11_

- [ ] 10. デプロイ準備と最終検証
- [ ] 10.1 環境変数とシークレット管理の最終確認
  - Railway環境変数を設定（JWT_PRIVATE_KEY、JWT_PUBLIC_KEY、TWO_FACTOR_ENCRYPTION_KEY等）
  - 開発環境と本番環境の環境変数差分を確認
  - シークレット値のローテーション手順を文書化
  - _Requirements: 全要件の環境変数_

- [ ] 10.2 Prismaマイグレーションの検証
  - 開発環境でマイグレーションを実行し、データベーススキーマを確認
  - マイグレーションのロールバック手順を検証
  - 本番環境デプロイ時の自動マイグレーション適用を確認
  - _Requirements: 1.1, 25（データ整合性）_

- [ ] 10.3 初期データシーディングの実装
  - 事前定義ロール・権限のシーディングスクリプトを実行
  - 初期管理者アカウントの作成を確認
  - シーディングの冪等性を検証（複数回実行しても安全）
  - _Requirements: 3.1-3.5, 17, 18_

- [ ] 10.4 監視とアラートの設定
  - Sentryエラートラッキング統合を確認（Backend/Frontend）
  - システム管理者ロール変更時のアラート通知を設定
  - ヘルスチェックエンドポイントの動作を確認
  - _Requirements: 22.9, 24.9_

- [ ] 10.5 ドキュメント更新
  - API仕様書を更新（OpenAPI 3.0、Swagger UI）
  - README.mdを更新（認証・認可機能の説明、環境変数リスト）
  - ステアリングドキュメントを更新（product.md、tech.md、structure.md）
  - _Requirements: 全要件のドキュメント_

- [ ] 10.6 全テストスイートの実行と検証
  - Backend単体テストを実行（250+ tests、カバレッジ80%以上確認）
  - Frontend単体テストを実行（65+ tests、カバレッジ80%以上確認）
  - 統合テストを実行（50 tests、全フロー確認）
  - E2Eテストを実行（30 tests、全シナリオ確認）
  - パフォーマンステストを実行（3 tests、性能要件達成確認）
  - _Requirements: 全要件のテストカバレッジ_

- [ ] 10.7 セキュリティレビューと脆弱性スキャン
  - npm auditでセキュリティ脆弱性をスキャン
  - OWASP Top 10チェックリストを検証
  - STRIDE脅威モデルを再確認
  - _Requirements: 10, 26（セキュリティ対策全般）_

- [ ] 10.8 本番環境デプロイとスモークテスト
  - Canary deployment戦略でデプロイ（5%→25%→100%）
  - デプロイ後のスモークテストを実行（ログイン、招待、2FA設定、権限チェック）
  - ロールバック手順を確認（Railway環境切り戻し、機能フラグ無効化）
  - _Requirements: 全要件の本番環境動作確認_

## 完了条件

すべてのタスクが完了し、以下の条件を満たすこと：

1. **機能要件**: requirements.mdの全32要件（27要件 + 5サブ要件）、583受入基準をすべて実装
2. **テストカバレッジ**: Backend 80%以上、Frontend 80%以上、統合テスト50件、E2Eテスト30件、パフォーマンステスト3件
3. **セキュリティ**: OWASP Top 10対策、STRIDE脅威モデル対策、EdDSA署名、Argon2idハッシュ、2FA/TOTP実装
4. **パフォーマンス**: ログインAPI 95パーセンタイルで500ms以内、権限チェックAPI 99パーセンタイルで100ms以内
5. **本番環境デプロイ**: Railway環境へのデプロイ成功、スモークテスト合格
6. **ドキュメント**: API仕様書、README.md、ステアリングドキュメント更新完了
