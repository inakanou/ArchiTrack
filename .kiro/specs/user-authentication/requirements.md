# 要件定義書

## はじめに

本ドキュメントは、ArchiTrackプロジェクトにおけるユーザー認証機能の要件を定義します。この機能により、管理者が承認したユーザーのみが安全にシステムへアクセスし、個人のアーキテクチャ決定記録（ADR）を管理できるようになります。

JWT（JSON Web Token）ベースの認証方式を採用し、招待制のユーザー登録とロールベースアクセス制御（RBAC）を組み合わせた、セキュアで拡張性の高い認証基盤を構築します。

**セキュリティポリシー:**
- ユーザー登録は管理者による招待制のみ
- 初期管理者アカウントはデータベースシーディングまたは管理コマンドで作成
- ロールベースアクセス制御により、管理者機能へのアクセスを制限

## 要件

### 要件1: 管理者によるユーザー招待

**目的:** 管理者として、新規ユーザーを招待したい。そうすることで、承認されたユーザーのみがシステムにアクセスできるようになる。

#### 受入基準

1. WHEN 管理者が有効なメールアドレスを提供する THEN Authentication Serviceは一意の招待トークンを生成しなければならない
2. WHEN 招待トークンが生成される THEN Authentication Serviceは有効期限（7日間）を設定しなければならない
3. WHEN 招待トークンが生成される THEN Authentication Serviceは招待メールを対象メールアドレスに送信しなければならない
4. IF 招待メールアドレスが既に登録済みである THEN Authentication Serviceはエラーメッセージを返さなければならない
5. IF リクエスト送信者が管理者ロールを持たない THEN Authentication Serviceは403 Forbiddenエラーを返さなければならない
6. WHEN 招待メールを送信する THEN Authentication Serviceは招待URL（トークン含む）をメール本文に含めなければならない
7. WHERE 管理者が招待一覧を取得する THE Authentication Serviceは招待ステータス（未使用、使用済み、期限切れ）を返さなければならない
8. WHEN 管理者が未使用の招待を取り消す THEN Authentication Serviceは招待を無効化しなければならない

### 要件2: 招待を受けたユーザーのアカウント作成

**目的:** 招待されたユーザーとして、アカウントを作成したい。そうすることで、システムを利用してADRを管理できるようになる。

#### 受入基準

1. WHEN ユーザーが有効な招待トークン、パスワード、表示名を提供する THEN Authentication Serviceは新しいユーザーアカウントを作成しなければならない
2. IF 招待トークンが無効または存在しない THEN Authentication Serviceはエラーメッセージを返さなければならない
3. IF 招待トークンが期限切れ（7日以上経過）である THEN Authentication Serviceはエラーメッセージを返さなければならない
4. IF 招待トークンが既に使用済みである THEN Authentication Serviceはエラーメッセージを返さなければならない
5. IF パスワードが8文字未満である THEN Authentication Serviceは登録を拒否しなければならない
6. IF パスワードが英数字と特殊文字を含まない THEN Authentication Serviceは登録を拒否しなければならない
7. WHEN ユーザー登録が成功する THEN Authentication Serviceはパスワードをbcryptでハッシュ化して保存しなければならない
8. WHEN ユーザー登録が成功する THEN Authentication Serviceは招待トークンを使用済みとしてマークしなければならない
9. WHEN ユーザー登録が成功する THEN Authentication Serviceはアクセストークンとリフレッシュトークンを発行しなければならない
10. WHEN ユーザー登録が成功する THEN Authentication Serviceはユーザーロール（user）を割り当てなければならない

### 要件3: 初期管理者アカウントのセットアップ

**目的:** システム管理者として、初回セットアップ時に管理者アカウントを作成したい。そうすることで、招待制システムを開始できるようになる。

#### 受入基準

1. WHEN システムが初回起動される AND 環境変数に初期管理者情報が設定されている THEN Authentication Serviceは管理者アカウントを自動作成しなければならない
2. WHEN データベースシーディングコマンドが実行される THEN Authentication Serviceは管理者アカウントを作成しなければならない
3. WHERE 初期管理者を作成する THE Authentication Serviceは管理者ロール（admin）を割り当てなければならない
4. IF 初期管理者のメールアドレスが既に登録済みである THEN Authentication Serviceはスキップしなければならない
5. WHEN 初期管理者が作成される THEN Authentication Serviceはログに記録しなければならない

### 要件4: ログイン

**目的:** 登録済みユーザーとして、システムにログインしたい。そうすることで、自分のADRにアクセスできるようになる。

#### 受入基準

1. WHEN ユーザーが有効なメールアドレスとパスワードを提供する THEN Authentication Serviceはアクセストークンとリフレッシュトークンを発行しなければならない
2. IF メールアドレスが登録されていない THEN Authentication Serviceは認証エラーを返さなければならない
3. IF パスワードが正しくない THEN Authentication Serviceは認証エラーを返さなければならない
4. WHEN ログインが成功する THEN Authentication Serviceはアクセストークン（有効期限15分）を発行しなければならない
5. WHEN ログインが成功する THEN Authentication Serviceはリフレッシュトークン（有効期限7日）を発行しなければならない
6. WHEN 連続して5回ログインに失敗する THEN Authentication Serviceはアカウントを15分間ロックしなければならない
7. WHEN トークンを発行する THEN Authentication Serviceはユーザーロール情報をトークンペイロードに含めなければならない

### 要件5: トークン管理

**目的:** システムユーザーとして、セキュアなトークンベースの認証を利用したい。そうすることで、安全にAPIにアクセスできるようになる。

#### 受入基準

1. WHEN アクセストークンの有効期限が切れる THEN Authentication Serviceはリフレッシュトークンを使用して新しいアクセストークンを発行しなければならない
2. IF リフレッシュトークンが無効または期限切れである THEN Authentication Serviceは再ログインを要求しなければならない
3. WHEN ユーザーがログアウトする THEN Authentication Serviceはリフレッシュトークンを無効化しなければならない
4. WHERE 保護されたAPIエンドポイントにアクセスする THE Authentication Serviceは有効なアクセストークンを検証しなければならない
5. IF アクセストークンが改ざんされている THEN Authentication Serviceはリクエストを拒否しなければならない
6. WHEN トークンにユーザー情報を含める THEN Authentication ServiceはユーザーID、メールアドレス、ロール（admin/user）を含めなければならない

### 要件6: ロールベースアクセス制御（RBAC）

**目的:** システムとして、ロールに基づいてアクセス権限を制御したい。そうすることで、管理機能への不正アクセスを防止できるようになる。

#### 受入基準

1. WHERE 管理者専用APIエンドポイントにアクセスする THE Authentication Serviceはユーザーが管理者ロール（admin）を持つことを検証しなければならない
2. IF ユーザーが必要なロールを持たない THEN Authentication Serviceは403 Forbiddenエラーを返さなければならない
3. WHEN ユーザーアカウントが作成される THEN Authentication Serviceはデフォルトで一般ユーザーロール（user）を割り当てなければならない
4. WHERE 管理者が他のユーザーのロールを変更する THE Authentication Serviceはロール変更をログに記録しなければならない
5. IF 最後の管理者アカウントのロールを変更しようとする THEN Authentication Serviceは変更を拒否しなければならない

### 要件7: パスワード管理

**目的:** ユーザーとして、パスワードを安全に管理したい。そうすることで、アカウントのセキュリティを維持できるようになる。

#### 受入基準

1. WHEN ユーザーがパスワードリセットを要求する THEN Authentication Serviceはメールアドレスにリセットトークンを送信しなければならない
2. WHEN ユーザーが有効なリセットトークンと新しいパスワードを提供する THEN Authentication Serviceはパスワードを更新しなければならない
3. IF リセットトークンが30分以上経過している THEN Authentication Serviceはトークンを無効として扱わなければならない
4. WHEN ユーザーがパスワードを変更する THEN Authentication Serviceは現在のパスワードの確認を要求しなければならない
5. WHEN パスワードが更新される THEN Authentication Serviceは全ての既存リフレッシュトークンを無効化しなければならない

### 要件8: セッション管理

**目的:** システム管理者として、ユーザーのセッションを管理したい。そうすることで、セキュリティとユーザー体験を最適化できるようになる。

#### 受入基準

1. WHEN ユーザーがログインする THEN Authentication Serviceはセッション情報をRedisに保存しなければならない
2. WHILE ユーザーがアクティブである THE Authentication Serviceはセッションの有効期限を延長しなければならない
3. WHEN ユーザーが複数デバイスからログインする THEN Authentication Serviceは各デバイスで独立したセッションを管理しなければならない
4. WHEN ユーザーがログアウトする THEN Authentication Serviceは対象デバイスのセッションのみを削除しなければならない
5. WHERE 管理者が全デバイスログアウト機能を使用する THE Authentication Serviceは全てのセッションを削除しなければならない

### 要件9: ユーザー情報取得・管理

**目的:** 認証済みユーザーとして、自分のプロフィール情報を取得したい。そうすることで、アカウント情報を確認・更新できるようになる。

#### 受入基準

1. WHEN 認証済みユーザーがプロフィール取得APIを呼び出す THEN Authentication Serviceはユーザーの基本情報（ID、メールアドレス、表示名、ロール、作成日時）を返さなければならない
2. IF アクセストークンが無効または期限切れである THEN Authentication Serviceは401 Unauthorizedエラーを返さなければならない
3. WHEN ユーザーが表示名を更新する THEN Authentication Serviceは更新後の情報を返さなければならない
4. WHERE 管理者がユーザー一覧を取得する THE Authentication Serviceは全ユーザーの情報（パスワードを除く）を返さなければならない
5. IF 一般ユーザーがユーザー一覧取得を試みる THEN Authentication Serviceは403 Forbiddenエラーを返さなければならない

### 要件10: セキュリティとエラーハンドリング

**目的:** システム全体として、セキュアで堅牢な認証システムを提供したい。そうすることで、ユーザーデータを保護し、信頼性の高いサービスを実現できるようになる。

#### 受入基準

1. WHEN 認証エラーが発生する THEN Authentication Serviceは詳細なエラー情報（メールアドレスの存在有無など）を返してはならない
2. WHERE パスワードを保存する THE Authentication Serviceはbcryptアルゴリズム（saltラウンド10以上）を使用しなければならない
3. WHEN JWTトークンを生成する THEN Authentication ServiceはHS256アルゴリズムを使用しなければならない
4. IF データベース接続エラーが発生する THEN Authentication Serviceは適切なエラーメッセージとHTTPステータス500を返さなければならない
5. WHEN APIリクエストのバリデーションが失敗する THEN Authentication Serviceは詳細なバリデーションエラーメッセージを返さなければならない
6. WHERE センシティブな操作（パスワード変更、ロール変更、ユーザー招待）を実行する THE Authentication Serviceはログに記録しなければならない
7. WHEN 招待トークンまたはリセットトークンを生成する THEN Authentication Serviceは暗号学的に安全なランダム文字列（32バイト以上）を使用しなければならない

## UI/UX要件

### 要件11: ログイン画面のUI/UX

**目的:** ユーザーとして、直感的で使いやすいログイン画面を利用したい。そうすることで、スムーズにシステムにアクセスできるようになる。

#### 受入基準

1. WHEN ログイン画面が表示される THEN UIはメールアドレス入力フィールド、パスワード入力フィールド、ログインボタンを表示しなければならない
2. WHERE パスワード入力フィールドがある THE UIはパスワードの表示/非表示切り替えボタンを提供しなければならない
3. WHEN ユーザーが入力フィールドにフォーカスする THEN UIは視覚的なフィードバック（アウトライン表示）を提供しなければならない
4. IF メールアドレス形式が無効である THEN UIはリアルタイムバリデーションエラーを表示しなければならない
5. WHEN ログインボタンがクリックされる AND フォームが未入力である THEN UIは必須フィールドエラーを表示しなければならない
6. WHILE ログインAPIリクエストが処理中である THE UIはローディングスピナーとボタンの無効化を表示しなければならない
7. IF ログインに失敗する THEN UIは汎用的なエラーメッセージ（「メールアドレスまたはパスワードが正しくありません」）を表示しなければならない
8. WHERE アカウントがロックされている THE UIはロック解除までの残り時間を表示しなければならない
9. WHEN ログイン画面が表示される THEN UIは「パスワードを忘れた場合」リンクを提供しなければならない
10. WHERE デバイス画面幅が768px未満である THE UIはモバイル最適化されたレイアウトを表示しなければならない
11. WHEN ログイン画面が読み込まれる THEN UIはメールアドレスフィールドに自動フォーカスしなければならない

### 要件12: ユーザー登録画面のUI/UX（招待リンク経由）

**目的:** 招待されたユーザーとして、わかりやすい登録画面でアカウントを作成したい。そうすることで、簡単にシステムを利用開始できるようになる。

#### 受入基準

1. WHEN 招待URLにアクセスする THEN UIは招待トークンを自動的に検証し、結果を表示しなければならない
2. IF 招待トークンが無効または期限切れである THEN UIはエラーメッセージと管理者への連絡手段を表示しなければならない
3. WHEN 有効な招待トークンが確認される THEN UIは招待者のメールアドレス（読み取り専用）、表示名入力フィールド、パスワード入力フィールド、パスワード確認フィールド、登録ボタンを表示しなければならない
4. WHERE パスワード入力フィールドに入力される THE UIはパスワード強度インジケーター（弱い/普通/強い）を表示しなければならない
5. WHEN パスワードが入力される THEN UIはパスワード要件（8文字以上、英数字、特殊文字）の達成状況をチェックリストで表示しなければならない
6. IF パスワードとパスワード確認が一致しない THEN UIはリアルタイムバリデーションエラーを表示しなければならない
7. WHEN 登録ボタンがクリックされる THEN UIは利用規約とプライバシーポリシーへの同意確認を要求しなければならない
8. WHILE 登録APIリクエストが処理中である THE UIはローディングスピナーとボタンの無効化を表示しなければならない
9. WHEN 登録が成功する THEN UIは成功メッセージを表示し、3秒後に自動的にダッシュボードへリダイレクトしなければならない
10. WHERE デバイス画面幅が768px未満である THE UIはモバイル最適化されたレイアウトを表示しなければならない

### 要件13: 管理者ユーザー招待画面のUI/UX

**目的:** 管理者として、効率的に新規ユーザーを招待し、招待状況を管理したい。そうすることで、チームメンバーの追加をスムーズに行えるようになる。

#### 受入基準

1. WHEN 招待画面が表示される THEN UIは招待フォーム（メールアドレス入力、招待ボタン）と招待一覧テーブルを表示しなければならない
2. WHERE 招待一覧テーブルがある THE UIは招待メールアドレス、招待日時、ステータス（未使用/使用済み/期限切れ）、有効期限、アクションボタン（取り消し/再送信）を表示しなければならない
3. WHEN 招待ボタンがクリックされる AND メールアドレスが有効である THEN UIは招待成功メッセージと招待URLのコピーボタンを表示しなければならない
4. IF 招待メールアドレスが既に登録済みである THEN UIはエラーメッセージ（「このメールアドレスは既に登録されています」）を表示しなければならない
5. WHEN 招待URLコピーボタンがクリックされる THEN UIはクリップボードにURLをコピーし、「コピーしました」というトーストメッセージを表示しなければならない
6. WHERE 招待ステータスが「未使用」である THE UIは「取り消し」ボタンを有効化しなければならない
7. WHERE 招待ステータスが「期限切れ」である THE UIは「再送信」ボタンを有効化しなければならない
8. WHEN 取り消しボタンがクリックされる THEN UIは確認ダイアログを表示しなければならない
9. WHERE 招待一覧が10件以上ある THE UIはページネーションまたは無限スクロールを提供しなければならない
10. WHEN 招待一覧が読み込まれる THEN UIは招待ステータスに応じた視覚的な区別（色、アイコン）を提供しなければならない
11. WHERE デバイス画面幅が768px未満である THE UIはテーブルをカード形式のレイアウトに変換しなければならない

### 要件14: プロフィール画面のUI/UX

**目的:** ユーザーとして、自分のプロフィール情報を確認・編集したい。そうすることで、アカウント情報を最新の状態に保てるようになる。

#### 受入基準

1. WHEN プロフィール画面が表示される THEN UIはユーザー情報セクション（メールアドレス、表示名、ロール、作成日時）とパスワード変更セクションを表示しなければならない
2. WHERE ユーザー情報セクションがある THE UIはメールアドレス（読み取り専用）、表示名（編集可能）、保存ボタンを表示しなければならない
3. WHEN 表示名が変更される THEN UIは保存ボタンを有効化しなければならない
4. WHEN 保存ボタンがクリックされる THEN UIは更新成功のトーストメッセージを表示しなければならない
5. WHERE パスワード変更セクションがある THE UIは現在のパスワード、新しいパスワード、パスワード確認の入力フィールドを表示しなければならない
6. WHEN 新しいパスワードが入力される THEN UIはパスワード強度インジケーターとパスワード要件チェックリストを表示しなければならない
7. WHEN パスワード変更ボタンがクリックされる THEN UIは確認ダイアログ（「全デバイスからログアウトされます」）を表示しなければならない
8. IF パスワード変更が成功する THEN UIは成功メッセージを表示し、5秒後にログイン画面へリダイレクトしなければならない
9. WHERE 管理者ユーザーがプロフィール画面にアクセスする THE UIは「ユーザー管理」リンクを表示しなければならない
10. WHERE デバイス画面幅が768px未満である THE UIはモバイル最適化されたレイアウトを表示しなければならない

### 要件15: 共通UI/UXガイドライン

**目的:** 全画面で一貫性のある、アクセシブルなユーザー体験を提供したい。そうすることで、ユーザビリティとアクセシビリティを向上できるようになる。

#### 受入基準

1. WHERE 全ての画面がある THE UIはレスポンシブデザイン（モバイル: 320px-767px、タブレット: 768px-1023px、デスクトップ: 1024px以上）を実装しなければならない
2. WHEN フォーム送信エラーが発生する THEN UIは最初のエラーフィールドにスクロールし、フォーカスしなければならない
3. WHERE 全てのボタンとリンクがある THE UIはキーボード操作（Tab、Enter、Space）をサポートしなければならない
4. WHEN ページが読み込まれる THEN UIは適切なaria-label、aria-describedby、role属性を提供しなければならない
5. WHERE カラー情報を使用する THE UIは色だけに依存せず、テキストやアイコンで補完しなければならない
6. WHEN フォームバリデーションエラーが発生する THEN UIはエラーメッセージをaria-liveリージョンで通知しなければならない
7. WHERE 全ての画面がある THE UIは最低コントラスト比4.5:1（WCAG 2.1 AA準拠）を維持しなければならない
8. WHEN APIリクエストが5秒以上かかる THEN UIはプログレスバーまたは進捗メッセージを表示しなければならない
9. IF APIリクエストがネットワークエラーで失敗する THEN UIは「ネットワーク接続を確認してください」というエラーメッセージとリトライボタンを表示しなければならない
10. WHERE トーストメッセージが表示される THE UIは3-5秒後に自動的に非表示にしなければならない
11. WHEN モーダルダイアログが開かれる THEN UIはフォーカストラップを実装し、Escキーで閉じられるようにしなければならない
12. WHERE 全ての入力フィールドがある THE UIは適切なautocomplete属性（email、current-password、new-password）を設定しなければならない
13. WHEN セッションが期限切れになる THEN UIは自動的にログイン画面へリダイレクトし、「セッションの期限が切れました」というメッセージを表示しなければならない

### 要件16: Storybookによるビジュアル要件管理

**目的:** 開発チームとステークホルダーとして、実装前にUIコンポーネントを視覚的に確認・検証したい。そうすることで、要件の認識齟齬を早期に発見し、効率的な開発を実現できるようになる。

#### 受入基準

1. WHERE 全ての認証画面コンポーネントがある THE Storybookは個別のストーリーを提供しなければならない
2. WHEN ログインフォームストーリーが表示される THEN Storybookは以下の状態バリアントを提供しなければならない
   - デフォルト状態（空のフォーム）
   - 入力中状態（フォーカス、入力値あり）
   - バリデーションエラー状態（メール形式エラー、必須フィールドエラー）
   - ローディング状態（ログイン処理中）
   - 認証エラー状態（ログイン失敗）
   - アカウントロック状態（ロック解除までの時間表示）
3. WHEN ユーザー登録フォームストーリーが表示される THEN Storybookは以下の状態バリアントを提供しなければならない
   - 招待トークン検証中
   - 招待トークン有効（フォーム表示）
   - 招待トークン無効/期限切れ
   - パスワード強度表示（弱い/普通/強い）
   - パスワード要件チェックリスト
   - バリデーションエラー状態
   - 登録処理中
   - 登録成功
4. WHEN 管理者招待画面ストーリーが表示される THEN Storybookは以下の状態バリアントを提供しなければならない
   - 招待一覧（0件、1-9件、10件以上）
   - 招待ステータス別表示（未使用、使用済み、期限切れ）
   - 招待成功モーダル（URLコピー機能付き）
   - 招待エラー状態
   - 取り消し確認ダイアログ
5. WHEN プロフィール画面ストーリーが表示される THEN Storybookは以下の状態バリアントを提供しなければならない
   - 一般ユーザー表示
   - 管理者ユーザー表示
   - 編集モード
   - パスワード変更モード
   - 更新処理中
6. WHERE 全てのストーリーがある THE Storybookはインタラクティブコントロール（Controls addon）を提供しなければならない
7. WHEN Storybookコントロールが提供される THEN 以下のプロパティを調整可能にしなければならない
   - テキスト入力値
   - ローディング状態（true/false）
   - エラーメッセージ
   - ユーザーロール（admin/user）
   - ブレークポイント（モバイル/タブレット/デスクトップ）
8. WHERE 全てのストーリーがある THE Storybookはアクセシビリティアドオン（a11y addon）を有効化しなければならない
9. WHEN a11yアドオンが実行される THEN 以下の項目を自動検証しなければならない
   - コントラスト比（最低4.5:1）
   - ARIA属性の適切性
   - キーボードナビゲーション
   - フォーカス管理
   - セマンティックHTML
10. WHERE Storybookドキュメントがある THE 各ストーリーは対応する要件番号と受入基準を明記しなければならない
11. WHEN ストーリーがレンダリングされる THEN レスポンシブデザインを検証するためのビューポートアドオンを提供しなければならない
12. WHERE ビューポートアドオンがある THE 以下のプリセットを提供しなければならない
    - モバイル（375px）
    - タブレット（768px）
    - デスクトップ（1280px）
13. WHEN コンポーネントの視覚的な変更が発生する THEN Storybookはビジュアルリグレッションテスト用のスナップショットを生成できなければならない
14. WHERE 全てのフォームコンポーネントがある THE Storybookはユーザーインタラクションをシミュレートする「Play function」を提供しなければならない
15. WHEN Play functionが実行される THEN 以下のユーザーアクションをシミュレートしなければならない
    - フォーム入力
    - バリデーショントリガー
    - ボタンクリック
    - キーボード操作（Tab、Enter、Escape）

#### ストーリー構成例

各画面コンポーネントは以下の構造でストーリーを定義します：

**ログインフォーム (`LoginForm.stories.tsx`)**
- Default - デフォルト状態
- Filled - 入力済み状態
- ValidationError - バリデーションエラー
- Loading - ローディング中
- AuthenticationError - 認証エラー
- AccountLocked - アカウントロック

**ユーザー登録フォーム (`SignupForm.stories.tsx`)**
- ValidatingToken - トークン検証中
- ValidToken - 有効なトークン
- InvalidToken - 無効なトークン
- ExpiredToken - 期限切れトークン
- WeakPassword - 弱いパスワード
- StrongPassword - 強いパスワード
- ValidationError - バリデーションエラー
- Submitting - 送信中
- Success - 登録成功

**管理者招待画面 (`InvitationManager.stories.tsx`)**
- EmptyList - 招待なし
- WithInvitations - 招待あり
- PendingInvitations - 未使用の招待
- UsedInvitations - 使用済みの招待
- ExpiredInvitations - 期限切れの招待
- SuccessModal - 招待成功モーダル
- CancelDialog - 取り消し確認ダイアログ

**プロフィール画面 (`ProfilePage.stories.tsx`)**
- UserProfile - 一般ユーザー
- AdminProfile - 管理者
- EditMode - 編集モード
- PasswordChangeMode - パスワード変更モード
- Updating - 更新中

#### ベストプラクティス

1. **Component Story Format (CSF) 3.0** を使用して、TypeScriptで型安全なストーリーを定義
2. **Storybook Docs** を活用して、要件定義とストーリーを自動的にドキュメント化
3. **Interaction Testing** により、ユーザーインタラクションを自動テスト
4. **Visual Regression Testing** により、意図しないビジュアル変更を検出
5. **Accessibility Testing** により、WCAG 2.1 AA準拠を自動検証
