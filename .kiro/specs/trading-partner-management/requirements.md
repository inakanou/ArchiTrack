# Requirements Document

## Introduction

取引先管理機能は、ArchiTrackにおける取引先（顧客および協力業者）の情報を一元管理するための機能です。取引先はプロジェクト管理機能において顧客として選択される候補となり、プロジェクトとの紐付けを通じて業務フローを支援します。

本機能により、ユーザーは取引先の登録・参照・更新・削除を効率的に行い、プロジェクト管理との連携を実現します。

## Requirements

### Requirement 1: 取引先一覧表示

**Objective:** As a ユーザー, I want 登録済みの取引先を一覧で確認したい, so that 取引先の全体像を把握し、必要な取引先を素早く見つけることができる

#### Acceptance Criteria

1. When ユーザーが取引先一覧ページにアクセスしたとき, the 取引先管理サービス shall 登録済みの取引先をテーブル形式で表示する
2. The 取引先管理サービス shall 取引先名、部課/支店/支社名、代表者名、取引先種別（顧客/協力業者）、住所、電話番号、登録日を一覧に表示する
3. When ユーザーが検索条件を入力したとき, the 取引先管理サービス shall 取引先名またはフリガナによる部分一致検索を実行する
3.1. When ユーザーがフリガナで検索するとき, the 取引先管理サービス shall ひらがな入力とカタカナ入力の両方を許容し、同一の検索結果を返却する
4. When ユーザーがフィルター条件を選択したとき, the 取引先管理サービス shall 取引先種別（顧客/協力業者）でのフィルタリングを実行する
5. The 取引先管理サービス shall ページネーションを提供し、1ページあたりの表示件数を選択可能とする
6. When ユーザーがソート列をクリックしたとき, the 取引先管理サービス shall 指定された列（取引先名、フリガナ、登録日等）で昇順または降順にソートする
7. If 取引先データが存在しない場合, then the 取引先管理サービス shall 「取引先が登録されていません」というメッセージを表示する
8. The 取引先管理サービス shall 取引先一覧のデフォルトソート順をフリガナの昇順とする

### Requirement 2: 取引先新規作成

**Objective:** As a ユーザー, I want 新しい取引先を登録したい, so that プロジェクトに紐付ける顧客や協力業者を管理できる

#### Acceptance Criteria

1. When ユーザーが「新規作成」ボタンをクリックしたとき, the 取引先管理サービス shall 取引先作成フォームを表示する
2. The 取引先管理サービス shall 以下の必須入力欄を提供する: 名前、フリガナ、種別（顧客/協力業者、複数選択可）、住所
3. The 取引先管理サービス shall 以下の任意入力欄を提供する: 部課/支店/支社名、代表者名、電話番号、FAX番号、メールアドレス、請求締日、支払日、備考
4. The 取引先管理サービス shall 請求締日として1日〜31日および「末日」の計32オプションをドロップダウンで提供する
5. The 取引先管理サービス shall 支払日として月選択（翌月/翌々月/3ヶ月後）と日選択（1日〜31日および「末日」）の組み合わせをドロップダウンで提供する
6. The 取引先管理サービス shall 種別選択肢として「顧客」と「協力業者」をチェックボックスで提供し、複数選択を可能とする
7. When ユーザーが有効なデータを入力して保存ボタンをクリックしたとき, the 取引先管理サービス shall 新しい取引先レコードをデータベースに作成する
8. When 取引先の作成に成功したとき, the 取引先管理サービス shall 成功メッセージを表示し、取引先一覧ページに遷移する
9. If 必須項目（名前、フリガナ、種別、住所）が未入力の場合, then the 取引先管理サービス shall バリデーションエラーメッセージを各項目に表示する
10. If メールアドレスが入力されており形式が不正な場合, then the 取引先管理サービス shall 「有効なメールアドレスを入力してください」というエラーを表示する
11. If 同一の取引先名が既に存在する場合, then the 取引先管理サービス shall 「この取引先名は既に登録されています」というエラーを表示する

### Requirement 3: 取引先詳細表示

**Objective:** As a ユーザー, I want 取引先の詳細情報を確認したい, so that 取引先の連絡先やその他の情報を把握できる

#### Acceptance Criteria

1. When ユーザーが一覧から取引先を選択したとき, the 取引先管理サービス shall 取引先詳細ページを表示する
2. The 取引先管理サービス shall 以下の情報を詳細ページに表示する: 名前、フリガナ、部課/支店/支社名、代表者名、種別、住所、電話番号、FAX番号、メールアドレス、請求締日、支払日、備考、登録日、更新日
3. The 取引先管理サービス shall 編集ボタンと削除ボタンを詳細ページに表示する
4. Where プロジェクト管理機能が有効なとき, the 取引先管理サービス shall 当該取引先に紐付くプロジェクト一覧を表示する

### Requirement 4: 取引先編集

**Objective:** As a ユーザー, I want 取引先の情報を更新したい, so that 最新の連絡先情報や変更を反映できる

#### Acceptance Criteria

1. When ユーザーが編集ボタンをクリックしたとき, the 取引先管理サービス shall 現在の取引先情報がプリセットされた編集フォームを表示する
2. The 取引先管理サービス shall 新規作成時と同じ必須項目（名前、フリガナ、種別、住所）と任意項目（部課/支店/支社名、代表者名、電話番号、FAX番号、メールアドレス、請求締日、支払日、備考）の編集を可能とする
3. The 取引先管理サービス shall 請求締日として1日〜31日および「末日」の計32オプションをドロップダウンで提供する
4. The 取引先管理サービス shall 支払日として月選択（翌月/翌々月/3ヶ月後）と日選択（1日〜31日および「末日」）の組み合わせをドロップダウンで提供する
5. When ユーザーが変更を保存したとき, the 取引先管理サービス shall 取引先レコードを更新する
6. When 更新に成功したとき, the 取引先管理サービス shall 成功メッセージを表示し、取引先詳細ページに遷移する
7. If 必須項目が未入力の場合, then the 取引先管理サービス shall バリデーションエラーメッセージを表示する
8. If 別の取引先と重複する取引先名に変更しようとした場合, then the 取引先管理サービス shall 「この取引先名は既に登録されています」というエラーを表示する
9. The 取引先管理サービス shall 楽観的排他制御（バージョン管理）を実装し、同時更新による競合を検出する
10. If 楽観的排他制御で競合が検出された場合, then the 取引先管理サービス shall 「他のユーザーによって更新されました。画面を更新してください」というエラーを表示する

### Requirement 5: 取引先削除

**Objective:** As a ユーザー, I want 不要になった取引先を削除したい, so that 取引先一覧を整理できる

#### Acceptance Criteria

1. When ユーザーが削除ボタンをクリックしたとき, the 取引先管理サービス shall 削除確認ダイアログを表示する
2. When ユーザーが削除を確認したとき, the 取引先管理サービス shall 取引先レコードを論理削除する
3. When ユーザーが削除確認ダイアログでキャンセルをクリックしたとき, the 取引先管理サービス shall ダイアログを閉じ、削除処理を中止する
4. When 削除に成功したとき, the 取引先管理サービス shall 成功メッセージを表示し、取引先一覧ページに遷移する
5. If 取引先がプロジェクトに紐付いている場合, then the 取引先管理サービス shall 削除を拒否し、「この取引先は現在プロジェクトに使用されているため削除できません」というエラーを表示する

### Requirement 6: 取引先種別管理

**Objective:** As a システム管理者, I want 取引先種別を定義したい, so that 取引先を適切に分類できる

#### Acceptance Criteria

1. The 取引先管理サービス shall 「顧客」と「協力業者」の2種類の取引先種別をシステムで提供する
2. The 取引先管理サービス shall 取引先種別を取引先登録時の必須選択項目として提供する
3. The 取引先管理サービス shall 取引先種別の複数選択を許可し、1つの取引先が「顧客」と「協力業者」の両方であることを可能とする
4. When ユーザーが取引先を登録または編集するとき, the 取引先管理サービス shall 取引先種別をチェックボックスで選択させる

### Requirement 7: アクセス制御

**Objective:** As a システム管理者, I want 取引先管理機能へのアクセスを制御したい, so that 適切な権限を持つユーザーのみが操作できる

#### Acceptance Criteria

1. The 取引先管理サービス shall 認証済みユーザーのみに取引先一覧・詳細の閲覧を許可する
2. The 取引先管理サービス shall 取引先の作成・編集・削除操作に対して適切な権限チェックを実行する
3. If 権限のないユーザーが操作を試みた場合, then the 取引先管理サービス shall 403 Forbiddenエラーを返却する
4. The 取引先管理サービス shall すべての取引先操作を監査ログに記録する
5. The 取引先管理サービス shall 「trading-partner:create」「trading-partner:read」「trading-partner:update」「trading-partner:delete」の権限をシステムに定義する
6. The 取引先管理サービス shall 監査ログに記録する操作として取引先作成、更新、削除を含める

### Requirement 8: エラー回復とフィードバック

**Objective:** As a ユーザー, I want エラー発生時に適切なフィードバックを受けたい, so that 問題を理解し対処できる

#### Acceptance Criteria

1. If ネットワークエラーが発生した場合, then the 取引先管理サービス shall 「通信エラーが発生しました。再試行してください。」というエラーメッセージと再試行ボタンを表示する
2. If サーバーエラー（5xx）が発生した場合, then the 取引先管理サービス shall 「システムエラーが発生しました。しばらくしてからお試しください。」というエラーメッセージを表示する
3. If セッションが期限切れの場合, then the 取引先管理サービス shall ログインページにリダイレクトする
4. When エラーメッセージを表示するとき, the 取引先管理サービス shall ToastNotificationコンポーネントを使用してエラーを通知する

### Requirement 9: パフォーマンス

**Objective:** As a ユーザー, I want 画面が素早く表示される, so that ストレスなく業務を遂行できる

#### Acceptance Criteria

1. The 取引先管理サービス shall 取引先一覧画面の初期表示を2秒以内に完了する
2. The 取引先管理サービス shall 取引先詳細画面の初期表示を1秒以内に完了する
3. The 取引先管理サービス shall 取引先作成・更新・削除操作のAPI応答を500ミリ秒以内に完了する
4. The 取引先管理サービス shall 検索・フィルタリング操作の結果表示を1秒以内に完了する
5. The 取引先管理サービス shall 大量データ（1000件以上）でもページネーションにより一覧表示のパフォーマンスを維持する

### Requirement 10: 取引先検索API（オートコンプリート対応）

**Objective:** As a 他システム, I want 取引先をAPIで検索したい, so that プロジェクト管理機能から取引先候補を取得できる

#### Acceptance Criteria

1. The 取引先管理サービス shall `GET /api/trading-partners/search` エンドポイントで取引先検索機能を提供する
2. When 検索クエリが1文字以上の場合, the 取引先管理サービス shall 取引先名またはフリガナで部分一致検索を実行する
3. The 取引先管理サービス shall 検索結果を最大10件まで返却する
4. The 取引先管理サービス shall 検索結果に取引先ID、取引先名、フリガナ、種別を含める
5. When クエリパラメータで種別フィルタ（type=customer）が指定された場合, the 取引先管理サービス shall 指定された種別を含む取引先のみを返却する
6. The 取引先管理サービス shall 検索APIのレスポンス時間を500ミリ秒以内とする
7. If 検索結果が0件の場合, then the 取引先管理サービス shall 空配列を返却する

### Requirement 11: データインテグリティ

**Objective:** As a システム運用者, I want 取引先データの整合性を保ちたい, so that 信頼性の高いデータ管理を実現できる

#### Acceptance Criteria

1. The 取引先管理サービス shall 取引先名（名前）の最大文字数を200文字に制限する
2. The 取引先管理サービス shall フリガナの最大文字数を200文字に制限し、カタカナのみを許可する
3. The 取引先管理サービス shall 部課/支店/支社名の最大文字数を100文字に制限する
4. The 取引先管理サービス shall 代表者名の最大文字数を100文字に制限する
5. The 取引先管理サービス shall 電話番号の形式バリデーション（数字、ハイフン、括弧のみ許可）を実行する
6. The 取引先管理サービス shall FAX番号の形式バリデーション（数字、ハイフン、括弧のみ許可）を実行する
7. The 取引先管理サービス shall メールアドレスの形式バリデーションを実行する
8. The 取引先管理サービス shall 住所の最大文字数を500文字に制限する
9. The 取引先管理サービス shall 請求締日を1〜31の整数値または「末日」（計32オプション）として管理する
10. The 取引先管理サービス shall 支払日を月オフセット（1=翌月、2=翌々月、3=3ヶ月後）と日（1〜31または「末日」）の組み合わせとして管理する
11. The 取引先管理サービス shall 備考の最大文字数を2000文字に制限する
12. The 取引先管理サービス shall 各取引先レコードに作成日時と更新日時を自動記録する

### Requirement 12: 画面遷移・ナビゲーション

**Objective:** As a ユーザー, I want 取引先管理機能に素早くアクセスしたい, so that 効率的に取引先情報を管理できる

#### Acceptance Criteria

##### ヘッダーナビゲーション

1. The 取引先管理サービス shall AppHeaderのメインナビゲーションに「取引先」リンクを表示する
2. When 認証済みユーザーがAppHeaderの「取引先」リンクをクリックしたとき, the 取引先管理サービス shall 取引先一覧ページ（/trading-partners）に遷移する
3. The 取引先管理サービス shall 「取引先」リンクにアイコン（ビルディングまたはユーザーグループアイコン）を付与して視認性を高める
4. The 取引先管理サービス shall 「取引先」リンクを「プロジェクト」リンクの次に配置する

##### ダッシュボードクイックアクセス

5. The 取引先管理サービス shall ダッシュボードのクイックアクセスセクションに「取引先管理」カードを表示する
6. When ユーザーがダッシュボードの「取引先管理」カードをクリックしたとき, the 取引先管理サービス shall 取引先一覧ページ（/trading-partners）に遷移する
7. The 取引先管理サービス shall 「取引先管理」カードに「顧客・協力業者の登録・管理」という説明を表示する
8. The 取引先管理サービス shall 「取引先管理」カードを「プロジェクト管理」カードの次に配置する

##### URL構造

9. The 取引先管理サービス shall 取引先一覧ページを `/trading-partners` のURLで提供する
10. The 取引先管理サービス shall 取引先新規作成ページを `/trading-partners/new` のURLで提供する
11. The 取引先管理サービス shall 取引先詳細ページを `/trading-partners/:id` のURLで提供する
12. The 取引先管理サービス shall 取引先編集ページを `/trading-partners/:id/edit` のURLで提供する
13. When ユーザーが存在しない取引先IDにアクセスしたとき, the 取引先管理サービス shall 「取引先が見つかりません」というエラーメッセージを表示し、取引先一覧への戻るリンクを提供する

##### パンくずナビゲーション

14. The 取引先管理サービス shall 取引先一覧ページに「ダッシュボード > 取引先」のパンくずナビゲーションを表示する
15. The 取引先管理サービス shall 取引先詳細ページに「ダッシュボード > 取引先 > [取引先名]」のパンくずナビゲーションを表示する
16. The 取引先管理サービス shall 取引先新規作成ページに「ダッシュボード > 取引先 > 新規作成」のパンくずナビゲーションを表示する
17. The 取引先管理サービス shall 取引先編集ページに「ダッシュボード > 取引先 > [取引先名] > 編集」のパンくずナビゲーションを表示する
18. When ユーザーがパンくずナビゲーションの任意の階層をクリックしたとき, the 取引先管理サービス shall 該当ページに遷移する

##### 画面間遷移

19. When ユーザーが取引先一覧から取引先を選択したとき, the 取引先管理サービス shall 取引先詳細ページに遷移する
20. When ユーザーが取引先一覧で「新規作成」ボタンをクリックしたとき, the 取引先管理サービス shall 取引先新規作成ページに遷移する
21. When ユーザーが取引先詳細ページで「編集」ボタンをクリックしたとき, the 取引先管理サービス shall 取引先編集画面を表示する
22. When 取引先作成に成功したとき, the 取引先管理サービス shall 取引先一覧ページに遷移する
23. When 取引先更新に成功したとき, the 取引先管理サービス shall 取引先詳細ページに遷移する
24. When 取引先削除に成功したとき, the 取引先管理サービス shall 取引先一覧ページに遷移する

##### アクセス制御とルート保護

25. The 取引先管理サービス shall 取引先管理ページ群をProtectedRouteで保護し、認証済みユーザーのみアクセスを許可する
26. The 取引先管理サービス shall 取引先管理ページ群にProtectedLayout（AppHeader付き）を適用する
27. If 未認証ユーザーが取引先管理ページにアクセスした場合, then the 取引先管理サービス shall ログインページにリダイレクトする
28. When ログイン後, the 取引先管理サービス shall 元のページ（リダイレクト元の取引先ページ）に遷移する
