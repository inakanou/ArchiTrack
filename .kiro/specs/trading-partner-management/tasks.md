# Implementation Plan

## Task Overview

取引先管理機能の実装タスク一覧です。本機能は、取引先（顧客/協力業者）のCRUD操作、検索・フィルタリング、アクセス制御、監査ログ記録を提供します。

---

## Tasks

- [x] 1. データベーススキーマとモデルの実装
- [x] 1.1 (P) 取引先データモデルの作成
  - 取引先エンティティ（名前、フリガナ、住所等の必須項目と任意項目）をPrismaスキーマで定義
  - 請求締日（1-31または末日）と支払日（月オフセット＋日）の整数フィールド設計
  - 論理削除用のdeletedAtフィールドと楽観的排他制御用のupdatedAtを含める
  - 取引先名の一意制約（deletedAt=nullの範囲内）をユニークインデックスで実装
  - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.10, 11.11, 11.12, 11.13, 11.14_

- [x] 1.2 (P) 取引先種別マッピングテーブルの作成
  - 顧客/協力業者の種別Enumを定義
  - 取引先と種別の多対多関係を表現するジョイントテーブルを作成
  - カスケード削除設定とインデックス最適化を適用
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 1.3 データベースマイグレーションの実行
  - Prismaマイグレーションを作成・適用
  - フリガナ検索用、論理削除フィルタ用、作成日ソート用のインデックスを追加
  - 種別フィルタ用のインデックスを追加
  - タスク1.1, 1.2で定義したスキーマに依存
  - _Requirements: 9.5, 11.14_

- [x] 2. 権限とアクセス制御の実装
- [x] 2.1 取引先管理権限のシード登録
  - 取引先の作成・閲覧・更新・削除権限をシステムに定義
  - 適切なロールへの権限割り当てを設定
  - _Requirements: 7.5_

- [x] 2.2 取引先操作の監査ログイベント定義
  - 作成・更新・削除操作の監査ログイベントタイプを定義
  - 監査ログサービスとの連携インターフェースを準備
  - _Requirements: 7.4, 7.6_

- [x] 3. バックエンドバリデーションスキーマの実装
- [x] 3.1 (P) 取引先作成スキーマの実装
  - 必須項目（名前、フリガナ、種別、住所）のバリデーション
  - フリガナのカタカナ制約を正規表現で検証
  - 電話番号・FAX番号の形式バリデーション（数字、ハイフン、括弧のみ）
  - メールアドレス形式の検証
  - 各フィールドの最大文字数制限を適用
  - _Requirements: 2.2, 2.3, 2.4, 2.5, 2.6, 2.9, 2.10, 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8, 11.9, 11.10, 11.11, 11.12, 11.13_

- [x] 3.2 (P) 取引先更新スキーマの実装
  - 作成スキーマと同様の必須・任意項目バリデーション
  - 楽観的排他制御用のexpectedUpdatedAtフィールドを含める
  - 部分更新に対応したスキーマ設計
  - _Requirements: 4.2, 4.3, 4.4, 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8, 11.9, 11.10, 11.11, 11.12, 11.13_

- [x] 3.3 (P) 検索・一覧取得クエリスキーマの実装
  - ページネーションパラメータ（page, limit）の検証
  - 検索キーワード、種別フィルター、ソート条件のバリデーション
  - オートコンプリート検索クエリのバリデーション
  - _Requirements: 1.3, 1.4, 1.5, 1.6, 10.2, 10.5_

- [ ] 4. バックエンドエラークラスの実装
- [ ] 4.1 取引先ドメイン固有エラーの定義
  - 取引先が見つからないエラー（404）
  - バリデーションエラー（400）
  - 取引先名重複エラー（409）
  - プロジェクト紐付け中の削除拒否エラー（409）
  - 楽観的排他制御の競合エラー（409）
  - _Requirements: 2.11, 4.8, 4.10, 5.5, 8.1, 8.2_

- [ ] 5. 取引先サービス層の実装
- [ ] 5.1 取引先作成機能の実装
  - 入力データのバリデーションとデータベースへの保存
  - 取引先名の重複チェック（同名の未削除レコード確認）
  - 種別マッピングのトランザクション内作成
  - 作成成功時の監査ログ記録
  - _Requirements: 2.7, 2.8, 2.11_

- [ ] 5.2 取引先一覧取得機能の実装
  - ページネーション付きの一覧取得
  - 取引先名またはフリガナによる部分一致検索
  - 種別フィルタリング
  - 指定列でのソート（フリガナ昇順をデフォルト）
  - データが存在しない場合の空結果返却
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8_

- [ ] 5.3 取引先詳細取得機能の実装
  - IDによる単一取引先の詳細情報取得
  - 全フィールドと種別情報の返却
  - 紐付くプロジェクト一覧の取得（将来の連携用インターフェース準備）
  - _Requirements: 3.1, 3.2, 3.4_

- [ ] 5.4 取引先更新機能の実装
  - 既存データの更新とバリデーション
  - 楽観的排他制御による同時更新の競合検出
  - 取引先名変更時の重複チェック（自身を除く）
  - 種別マッピングの更新
  - 更新成功時の監査ログ記録
  - _Requirements: 4.1, 4.5, 4.6, 4.7, 4.8, 4.9, 4.10_

- [ ] 5.5 取引先削除機能の実装
  - 論理削除の実行（deletedAtの設定）
  - プロジェクト紐付け確認と削除拒否判定
  - 削除成功時の監査ログ記録
  - _Requirements: 5.2, 5.4, 5.5_

- [ ] 5.6 取引先検索API機能の実装
  - クエリ1文字以上での部分一致検索
  - 種別フィルターによる絞り込み
  - 最大10件までの結果制限
  - ID、名前、フリガナ、種別を含む検索結果の返却
  - 結果0件時の空配列返却
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 10.7_

- [ ] 6. 取引先APIルートの実装
- [ ] 6.1 取引先CRUDエンドポイントの実装
  - 一覧取得、詳細取得、作成、更新、削除の各エンドポイント
  - 認証ミドルウェアの適用
  - 権限チェックミドルウェアの適用（閲覧・作成・更新・削除権限）
  - リクエストバリデーションの適用
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 6.2 取引先検索エンドポイントの実装
  - オートコンプリート用検索APIの実装
  - 認証・権限チェックの適用
  - レスポンス時間の最適化（500ms以内目標）
  - _Requirements: 10.1, 10.6_

- [ ] 7. フロントエンド共通コンポーネントの実装
- [ ] 7.1 (P) 取引先種別選択コンポーネントの実装
  - 顧客/協力業者をチェックボックスで選択可能に
  - 複数選択に対応した状態管理
  - _Requirements: 2.6, 6.4_

- [ ] 7.2 (P) 請求締日・支払日選択コンポーネントの実装
  - 請求締日ドロップダウン（1日〜31日、末日の32オプション）
  - 支払日の月選択（翌月/翌々月/3ヶ月後）と日選択の組み合わせUI
  - _Requirements: 2.4, 2.5, 4.3, 4.4_

- [ ] 8. 取引先フォームの実装
- [ ] 8.1 取引先作成・編集フォームの実装
  - 必須項目（名前、フリガナ、種別、住所）の入力欄
  - 任意項目（部課/支店/支社名、代表者名等）の入力欄
  - フリガナ入力時のカタカナ以外警告表示
  - クライアントサイドバリデーションとエラー表示
  - 編集時の既存データプリセット
  - _Requirements: 2.1, 2.2, 2.3, 2.9, 2.10, 4.1, 4.2, 4.7_

- [ ] 8.2 フォーム送信とエラーハンドリングの実装
  - 作成・更新APIの呼び出し
  - 成功時のメッセージ表示と画面遷移
  - バリデーションエラー、重複エラー、競合エラーの表示
  - ネットワークエラー時の再試行ボタン表示
  - _Requirements: 2.7, 2.8, 2.11, 4.5, 4.6, 4.8, 8.1, 8.2, 8.4_

- [ ] 9. 取引先一覧画面の実装
- [ ] 9.1 取引先一覧テーブルの実装
  - 取引先名、フリガナ、部課/支店/支社名、代表者名、種別、住所、電話番号、登録日の列表示
  - フリガナ昇順のデフォルトソート
  - 列ヘッダークリックによるソート切り替え
  - 取引先が存在しない場合のメッセージ表示
  - _Requirements: 1.1, 1.2, 1.6, 1.7, 1.8_

- [ ] 9.2 検索・フィルター機能の実装
  - 取引先名またはフリガナでの検索入力欄
  - 種別フィルターの選択UI
  - 検索条件変更時の一覧再取得
  - _Requirements: 1.3, 1.4_

- [ ] 9.3 ページネーション機能の実装
  - ページ番号と総ページ数の表示
  - 1ページあたり表示件数の選択
  - ページ切り替え時のデータ再取得
  - _Requirements: 1.5_

- [ ] 9.4 一覧画面のエラーハンドリング
  - ネットワークエラー、サーバーエラー時のメッセージ表示
  - セッション期限切れ時のログインページリダイレクト
  - _Requirements: 8.1, 8.2, 8.3_

- [ ] 10. 取引先詳細画面の実装
- [ ] 10.1 取引先詳細表示コンポーネントの実装
  - 全フィールドの表示（名前、フリガナ、部課/支店/支社名等）
  - 請求締日と支払日の日本語表記変換
  - 登録日・更新日の表示
  - 編集ボタン、削除ボタンの配置
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 10.2 削除確認ダイアログの実装
  - 削除ボタンクリック時の確認ダイアログ表示
  - 確認後の削除API呼び出し
  - キャンセル時のダイアログ閉じ処理
  - プロジェクト紐付けエラー時のメッセージ表示
  - 削除成功時の一覧画面遷移
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 11. パフォーマンス最適化の実装
- [ ] 11.1 一覧・詳細画面のパフォーマンス最適化
  - 一覧画面の初期表示を2秒以内に完了
  - 詳細画面の初期表示を1秒以内に完了
  - 検索・フィルタリング操作の結果表示を1秒以内に完了
  - 大量データでもページネーションによるパフォーマンス維持
  - _Requirements: 9.1, 9.2, 9.4, 9.5_

- [ ] 11.2 API応答時間の最適化
  - 作成・更新・削除操作のAPI応答を500ms以内に完了
  - 検索APIのレスポンス時間を500ms以内に維持
  - _Requirements: 9.3, 10.6_

- [ ] 12. 単体テストの実装
- [ ] 12.1 (P) バリデーションスキーマのテスト
  - 必須項目、形式、文字数制限のバリデーションテスト
  - カタカナ制約、電話番号形式、メールアドレス形式のテスト
  - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8, 11.9_

- [ ] 12.2 (P) サービス層のテスト
  - CRUD操作のロジックテスト
  - 重複チェック、プロジェクト紐付け確認のテスト
  - 楽観的排他制御のテスト
  - 監査ログ記録のテスト
  - _Requirements: 2.7, 2.11, 4.9, 4.10, 5.5, 7.4_

- [ ] 12.3 (P) エラークラスのテスト
  - 各エラークラスのHTTPステータスコード・エラーコード検証
  - _Requirements: 8.1, 8.2_

- [ ] 13. 統合テストの実装
- [ ] 13.1 APIエンドポイントの統合テスト
  - 認証・認可ミドルウェアの動作確認
  - 各エンドポイントのレスポンス検証
  - エラーレスポンスの検証（401, 403, 404, 409）
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 13.2 データベーストランザクションのテスト
  - 取引先作成時の種別マッピング整合性テスト
  - 更新・削除時のトランザクション整合性テスト
  - _Requirements: 6.3_

- [ ] 14. E2Eテストの実装
- [ ] 14.1 取引先CRUDフローのE2Eテスト
  - 取引先作成→詳細表示→編集→削除の一連のフローテスト
  - バリデーションエラー、重複エラー、競合エラーの表示テスト
  - _Requirements: 2.1, 2.8, 2.11, 4.1, 4.6, 4.10, 5.1, 5.4_

- [ ] 14.2 一覧画面機能のE2Eテスト
  - ページネーション、検索、フィルタリング、ソートの動作テスト
  - 空データ時のメッセージ表示テスト
  - _Requirements: 1.1, 1.3, 1.4, 1.5, 1.6, 1.7_

- [ ]\* 14.3 パフォーマンステスト
  - 一覧画面初期表示時間の計測（2秒以内）
  - 詳細画面初期表示時間の計測（1秒以内）
  - API応答時間の計測（500ms以内）
  - 1000件以上のデータでのページネーションパフォーマンス確認
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5, 10.6_

---

## Requirements Coverage

| 要件                                                    | タスク                             |
| ------------------------------------------------------- | ---------------------------------- |
| 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8                  | 5.2, 9.1, 9.2, 9.3, 14.2           |
| 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10, 2.11 | 3.1, 5.1, 7.1, 7.2, 8.1, 8.2, 14.1 |
| 3.1, 3.2, 3.3, 3.4                                      | 5.3, 10.1                          |
| 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9, 4.10       | 3.2, 5.4, 7.2, 8.1, 8.2, 14.1      |
| 5.1, 5.2, 5.3, 5.4, 5.5                                 | 4.1, 5.5, 10.2, 12.2, 14.1         |
| 6.1, 6.2, 6.3, 6.4                                      | 1.2, 7.1, 13.2                     |
| 7.1, 7.2, 7.3, 7.4, 7.5, 7.6                            | 2.1, 2.2, 6.1, 12.2, 13.1          |
| 8.1, 8.2, 8.3, 8.4                                      | 4.1, 8.2, 9.4, 12.3                |
| 9.1, 9.2, 9.3, 9.4, 9.5                                 | 1.3, 11.1, 11.2, 14.3              |
| 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7                | 3.3, 5.6, 6.2                      |
| 11.1-11.14                                              | 1.1, 3.1, 3.2, 12.1                |
