# Implementation Plan

## Task Overview

自社情報登録機能の実装タスク。TradingPartner実装パターンを踏襲し、TDD（テスト駆動開発）手法で実装を進める。

**総タスク数**: 7メジャータスク、22サブタスク
**要件カバレッジ**: 9要件、43受入基準すべてをカバー

---

## Tasks

- [x] 1. データベース層の実装
- [x] 1.1 (P) Prismaスキーマの定義とマイグレーション実行
  - CompanyInfoモデルをschema.prismaに追加（シングルトンパターン）
  - 楽観的排他制御用のversionフィールドを含める
  - マイグレーションを作成・適用してテーブルを生成
  - _Requirements: 2.7, 9.7_

- [x] 1.2 (P) 権限定義のシードデータ追加
  - company_info:read権限とcompany_info:update権限をseed-helpers.tsに追加
  - adminロールとuserロールに権限を割り当て
  - シードデータの実行で権限が正しく登録されることを確認
  - _Requirements: 6.6, 6.7, 6.8_

---

- [x] 2. バックエンドバリデーション層の実装
- [x] 2.1 Zodスキーマのテスト作成
  - 必須フィールド（会社名、住所、代表者）のバリデーションテストを作成
  - 文字数制限バリデーションのテストを作成（会社名200、住所500、代表者100、電話番号20、FAX20、メール254）
  - 電話番号・FAX番号形式のバリデーションテスト（数字、ハイフン、括弧のみ許可）を作成
  - メールアドレス形式のバリデーションテストを作成
  - 適格請求書発行事業者登録番号形式のバリデーションテスト（T+13桁数字）を作成
  - versionフィールドのバリデーションテストを作成
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9, 4.10_

- [x] 2.2 Zodスキーマの実装
  - テストが通過するようにcompany-info.schema.tsを実装
  - updateCompanyInfoSchemaをexportしてルート層で使用可能にする
  - バリデーションエラーメッセージを日本語で定義
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9, 4.10_

---

- [x] 3. バックエンドサービス層の実装
- [x] 3.1 サービス層のテスト作成
  - getCompanyInfo: 登録済みデータの取得成功テストを作成
  - getCompanyInfo: 未登録時にnullを返却するテストを作成
  - upsertCompanyInfo: 新規作成成功のテストを作成
  - upsertCompanyInfo: 更新成功のテストを作成
  - upsertCompanyInfo: 楽観的排他制御で競合検出時のエラーテストを作成
  - 監査ログ記録のテストを作成（company_info_created、company_info_updated）
  - _Requirements: 2.1, 2.2, 2.3, 2.7, 2.8, 6.10_

- [x] 3.2 サービス層の実装
  - テストが通過するようにcompany-info.service.tsを実装
  - Prismaのupsertを使用してシングルトンパターンを実現
  - versionフィールドによる楽観的排他制御を実装
  - 監査ログサービスと連携して操作を記録
  - ConflictError（409）を適切に送出
  - _Requirements: 2.1, 2.2, 2.3, 2.7, 2.8, 6.10_

---

- [ ] 4. バックエンドAPI層の実装
- [ ] 4.1 APIルートのテスト作成
  - GET /api/company-info: 認証チェックテストを作成
  - GET /api/company-info: 権限チェックテスト（company_info:read）を作成
  - GET /api/company-info: 登録済みデータ取得成功テストを作成
  - GET /api/company-info: 未登録時に空オブジェクト返却テストを作成
  - PUT /api/company-info: 認証チェックテストを作成
  - PUT /api/company-info: 権限チェックテスト（company_info:update）を作成
  - PUT /api/company-info: バリデーションエラーテスト（400）を作成
  - PUT /api/company-info: 新規作成成功テストを作成
  - PUT /api/company-info: 更新成功テストを作成
  - PUT /api/company-info: 楽観的排他制御競合テスト（409）を作成
  - 未認証アクセス時の401テストを作成
  - 権限不足時の403テストを作成
  - _Requirements: 6.1, 6.2, 6.4, 6.7, 6.8, 6.9, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8, 9.9, 9.10_

- [ ] 4.2 APIルートの実装
  - テストが通過するようにcompany-info.routes.tsを実装
  - authenticateミドルウェアで認証を検証
  - requirePermissionミドルウェアで権限を検証
  - validateミドルウェアでリクエストボディを検証
  - GETエンドポイントで自社情報を取得（未登録時は空オブジェクト）
  - PUTエンドポイントで自社情報を作成・更新
  - DELETEエンドポイントは提供しない
  - Express Routerをapp.tsに登録
  - _Requirements: 6.1, 6.2, 6.4, 6.7, 6.8, 6.9, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8, 9.9, 9.10_

---

- [ ] 5. フロントエンドAPIクライアント・バリデーションの実装
- [ ] 5.1 (P) APIクライアントの実装
  - getCompanyInfo関数を実装（GET /api/company-info）
  - updateCompanyInfo関数を実装（PUT /api/company-info）
  - エラーハンドリング（401、403、409、ネットワークエラー）を実装
  - _Requirements: 9.1, 9.4, 7.1, 7.2, 7.3_

- [ ] 5.2 (P) フロントエンドバリデーションスキーマの実装
  - バックエンドと同一のZodスキーマをフロントエンド用に作成
  - フォーム入力時のリアルタイムバリデーションで使用
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9, 4.10_

---

- [ ] 6. フロントエンドUI層の実装
- [ ] 6.1 CompanyInfoFormコンポーネントのテスト作成
  - 空のフォーム表示テストを作成
  - プリセットデータ表示テストを作成
  - 必須フィールドのバリデーションエラー表示テストを作成
  - 形式バリデーションエラー表示テストを作成
  - 保存ボタンクリック時の保存処理テストを作成
  - リセットボタンクリック時のリセット処理テストを作成
  - ローディング状態でのボタン無効化テストを作成
  - isDirty状態管理テストを作成
  - _Requirements: 1.2, 1.3, 1.4, 2.4, 2.5, 2.6, 3.1, 3.2, 3.3_

- [ ] 6.2 CompanyInfoFormコンポーネントの実装
  - テストが通過するようにCompanyInfoForm.tsxを実装
  - TradingPartnerFormパターンを踏襲したフォームレイアウト
  - 各入力フィールドのバリデーションエラー表示
  - 保存ボタン・リセットボタンの配置と動作
  - ローディング中のインジケーター表示とボタン無効化
  - フォーム変更状態（isDirty）の追跡
  - _Requirements: 1.2, 1.3, 1.4, 2.4, 2.5, 2.6, 3.1, 3.2, 3.3_

- [ ] 6.3 CompanyInfoPageコンポーネントのテスト作成
  - 初期データ取得テストを作成
  - ローディング状態表示テストを作成
  - エラー状態表示テストを作成
  - パンくずナビゲーション表示テストを作成
  - 保存成功時のToast表示テストを作成
  - 楽観的排他制御競合時のエラーメッセージ表示テストを作成
  - ネットワークエラー時のエラーメッセージと再試行ボタン表示テストを作成
  - _Requirements: 1.1, 1.5, 2.4, 2.8, 5.5, 5.6, 7.1, 7.2, 7.4_

- [ ] 6.4 CompanyInfoPageコンポーネントの実装
  - テストが通過するようにCompanyInfoPage.tsxを実装
  - useEffectで初期データを取得
  - ローディング状態・エラー状態の管理
  - パンくずナビゲーション（ダッシュボード > 自社情報）の表示
  - ToastNotificationによる成功・エラーメッセージ表示
  - 楽観的排他制御競合時の「他のユーザーによって更新されました」メッセージ
  - ネットワークエラー時の再試行ボタン表示
  - _Requirements: 1.1, 1.5, 2.4, 2.8, 5.5, 5.6, 7.1, 7.2, 7.4_

- [ ] 6.5 未保存確認ダイアログの実装
  - useBlockerを使用したページ離脱検出テストを作成
  - 確認ダイアログ表示テストを作成
  - テストが通過するように未保存確認ダイアログを実装
  - フォームに未保存の変更がある場合のみダイアログを表示
  - _Requirements: 3.4_

---

- [ ] 7. ナビゲーション・ルーティング・E2Eテストの実装
- [ ] 7.1 AppHeader修正のテスト作成
  - 「自社情報」リンク表示テストを作成
  - リンク位置テスト（取引先の右側）を作成
  - ビルディングアイコン表示テストを作成
  - リンククリック時の遷移テストを作成
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 7.2 AppHeaderの修正実装
  - テストが通過するようにAppHeader.tsxを修正
  - 「自社情報」リンクを「取引先」リンクの右側に追加
  - ビルディングアイコンを付与
  - /company-infoへのNavLinkを設定
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 7.3 ルーティング設定
  - routes.tsxに/company-infoルートを追加
  - ProtectedRouteでルートを保護
  - ProtectedLayout（AppHeader付き）を適用
  - _Requirements: 5.7, 6.2, 6.3, 6.5_

- [ ] 7.4 E2Eテストの作成と実行
  - 自社情報ページ表示テスト（未登録時・登録済み）を作成
  - 新規登録フローテスト（入力 → 保存 → 成功Toast）を作成
  - 更新フローテスト（編集 → 保存 → 成功Toast）を作成
  - バリデーションエラー表示テストを作成
  - AppHeaderナビゲーションテストを作成
  - パンくずナビゲーションテストを作成
  - 未保存確認ダイアログテストを作成
  - 未認証アクセス時のリダイレクトテストを作成
  - ログイン後の元ページ遷移テストを作成
  - パフォーマンステスト（初期表示1秒以内、API応答500ms以内）を作成
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.4, 3.4, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 6.4, 6.5, 8.1, 8.2_

---

## Requirements Coverage Matrix

| 要件ID | 要件概要 | カバータスク |
|--------|----------|--------------|
| 1.1 | 自社情報フォーム表示 | 6.3, 6.4, 7.4 |
| 1.2 | 入力欄の提供 | 6.1, 6.2, 7.4 |
| 1.3 | 登録済み情報のプリセット | 6.1, 6.2, 7.4 |
| 1.4 | 未登録時の空フォーム | 6.1, 6.2, 7.4 |
| 1.5 | 見出し「自社情報」表示 | 6.3, 6.4, 7.4 |
| 2.1 | 有効データの保存 | 3.1, 3.2, 7.4 |
| 2.2 | 未登録時の新規作成 | 3.1, 3.2 |
| 2.3 | 登録済み時の更新 | 3.1, 3.2 |
| 2.4 | 成功Toast表示 | 6.3, 6.4, 7.4 |
| 2.5 | バリデーションエラー表示 | 6.1, 6.2 |
| 2.6 | ローディング表示とボタン無効化 | 6.1, 6.2 |
| 2.7 | 楽観的排他制御実装 | 1.1, 3.1, 3.2 |
| 2.8 | 競合検出時のエラー表示 | 3.1, 3.2, 6.3, 6.4 |
| 3.1 | リセットボタン表示 | 6.1, 6.2 |
| 3.2 | リセット時の復元 | 6.1, 6.2 |
| 3.3 | 未登録時のリセット | 6.1, 6.2 |
| 3.4 | 未保存確認ダイアログ | 6.5, 7.4 |
| 4.1 | 会社名最大200文字 | 2.1, 2.2, 5.2 |
| 4.2 | 住所最大500文字 | 2.1, 2.2, 5.2 |
| 4.3 | 代表者最大100文字 | 2.1, 2.2, 5.2 |
| 4.4 | 電話番号形式バリデーション | 2.1, 2.2, 5.2 |
| 4.5 | FAX番号形式バリデーション | 2.1, 2.2, 5.2 |
| 4.6 | メールアドレス形式バリデーション | 2.1, 2.2, 5.2 |
| 4.7 | メールアドレス形式エラー表示 | 2.1, 2.2, 5.2 |
| 4.8 | メールアドレス最大254文字 | 2.1, 2.2, 5.2 |
| 4.9 | 適格請求書番号形式バリデーション | 2.1, 2.2, 5.2 |
| 4.10 | 適格請求書番号形式エラー表示 | 2.1, 2.2, 5.2 |
| 5.1 | AppHeader「自社情報」リンク表示 | 7.1, 7.2, 7.4 |
| 5.2 | リンク位置（取引先の右側） | 7.1, 7.2, 7.4 |
| 5.3 | リンククリック時の遷移 | 7.1, 7.2, 7.4 |
| 5.4 | ビルディングアイコン | 7.1, 7.2, 7.4 |
| 5.5 | パンくずナビゲーション表示 | 6.3, 6.4, 7.4 |
| 5.6 | パンくずダッシュボードリンク | 6.3, 6.4, 7.4 |
| 5.7 | /company-info URL提供 | 7.3, 7.4 |
| 6.1 | 認証済みユーザーのみアクセス許可 | 4.1, 4.2 |
| 6.2 | ProtectedRoute保護 | 7.3 |
| 6.3 | ProtectedLayout適用 | 7.3 |
| 6.4 | 未認証時のリダイレクト | 4.1, 4.2, 7.4 |
| 6.5 | ログイン後の元ページ遷移 | 7.4 |
| 6.6 | 権限定義 | 1.2 |
| 6.7 | 閲覧権限要求 | 1.2, 4.1, 4.2 |
| 6.8 | 保存権限要求 | 1.2, 4.1, 4.2 |
| 6.9 | 権限不足時の403エラー | 4.1, 4.2 |
| 6.10 | 監査ログ記録 | 3.1, 3.2 |
| 7.1 | ネットワークエラー表示 | 5.1, 6.3, 6.4 |
| 7.2 | サーバーエラー表示 | 5.1, 6.3, 6.4 |
| 7.3 | セッション期限切れリダイレクト | 5.1 |
| 7.4 | ToastNotification使用 | 6.3, 6.4 |
| 8.1 | 初期表示1秒以内 | 7.4 |
| 8.2 | API応答500ms以内 | 7.4 |
| 9.1 | GET /api/company-info提供 | 4.1, 4.2, 5.1 |
| 9.2 | 登録済みデータ返却 | 4.1, 4.2 |
| 9.3 | 未登録時空オブジェクト返却 | 4.1, 4.2 |
| 9.4 | PUT /api/company-info提供 | 4.1, 4.2, 5.1 |
| 9.5 | 未存在時の新規作成 | 4.1, 4.2 |
| 9.6 | 存在時の更新 | 4.1, 4.2 |
| 9.7 | レスポンスフィールド | 1.1, 4.1, 4.2 |
| 9.8 | versionによる楽観的排他制御 | 4.1, 4.2 |
| 9.9 | version不一致時の409 Conflict | 4.1, 4.2 |
| 9.10 | 削除API非提供 | 4.1, 4.2 |
