# Requirements Document

## Introduction

本ドキュメントは「内訳書作成機能」の要件定義書です。本機能は、プロジェクト配下に実装済みの数量表機能の項目を集計し、指定した分類軸でピボット集計した内訳書を作成します。内訳書は作成時点の数量表スナップショットを保持し、以降の数量表更新による自動再計算は行いません。

## Requirements

### Requirement 1: 内訳書の新規作成

**Objective:** As a プロジェクト担当者, I want プロジェクト詳細画面から数量表を指定して内訳書を作成する, so that 数量拾い出し結果を分類別に集計した帳票を得られる

#### Acceptance Criteria

1. When ユーザーが内訳書セクションの新規作成ボタンをクリックする, the 内訳書作成フォーム shall 当該プロジェクトに紐づく数量表の選択リストを表示する
2. When ユーザーが数量表を1つ以上選択する, the 内訳書作成フォーム shall 選択された数量表の合計項目数を表示する
3. When ユーザーが内訳書名を入力して作成を確定する, the システム shall 選択された数量表の全項目を集計して内訳書レコードを作成する
4. If 数量表が1つも選択されていない状態で作成を試行する, then the システム shall 「数量表を選択してください」エラーメッセージを表示する
5. If 内訳書名が未入力の状態で作成を試行する, then the システム shall 「内訳書名を入力してください」エラーメッセージを表示する
6. The 内訳書名フィールド shall 最大200文字の入力制限を適用する
7. When プロジェクトに数量表が存在しない場合, the 内訳書作成ボタン shall 無効化される

### Requirement 2: ピボット集計ロジック

**Objective:** As a システム, I want 数量表項目を分類軸でグループ化して数量を合計する, so that 同一分類の項目が1行に集約された内訳書が生成される

#### Acceptance Criteria

1. When 内訳書が作成される, the システム shall 「任意分類」「工種」「名称」「規格」「単位」の5項目の組み合わせをキーとしてグループ化する
2. When 同一キーの項目が複数存在する, the システム shall 該当項目の「数量」フィールドの値を合計する
3. When グループ化を行う, the システム shall null または空文字の値を同一グループとして扱う
4. The 合計数量 shall 小数点以下4桁の精度で計算する
5. When 数量の合計結果がオーバーフローする場合, the システム shall エラーを発生させ内訳書作成を中止する

### Requirement 3: 内訳書一覧表示

**Objective:** As a プロジェクト担当者, I want プロジェクト詳細画面で作成済み内訳書の一覧を確認する, so that 必要な内訳書に素早くアクセスできる

#### Acceptance Criteria

1. The プロジェクト詳細画面 shall 数量表セクションの下に内訳書セクションを表示する
2. The 内訳書セクション shall 作成済み内訳書を作成日時の降順で一覧表示する
3. When 内訳書が存在しない場合, the 内訳書セクション shall 「内訳書はまだ作成されていません」メッセージを表示する
4. The 内訳書一覧の各行 shall 内訳書名、作成日時、集計元数量表数、合計項目数を表示する
5. When ユーザーが内訳書行をクリックする, the システム shall 内訳書詳細画面に遷移する

### Requirement 4: 内訳書詳細画面

**Objective:** As a プロジェクト担当者, I want 内訳書の集計結果を一覧で確認する, so that 分類別の数量を把握できる

#### Acceptance Criteria

1. The 内訳書詳細画面 shall 集計結果をテーブル形式で表示する
2. The テーブル shall 「任意分類」「工種」「名称」「規格」「単位」「数量」のカラムを表示する
3. The 数量カラム shall 小数点以下4桁まで表示し、不要な末尾ゼロは省略する
4. While 内訳書詳細画面を表示中, the システム shall パンくずナビゲーションでプロジェクト詳細画面への戻りリンクを提供する
5. The 内訳書詳細画面 shall 内訳書名と作成日時をヘッダーに表示する

### Requirement 5: 内訳項目の並び替え

**Objective:** As a プロジェクト担当者, I want 内訳書の項目を任意の順序で並び替える, so that 用途に応じた表示順で確認できる

#### Acceptance Criteria

1. The 内訳書詳細画面 shall 各カラムヘッダーにソートボタンを表示する
2. When ユーザーがカラムヘッダーをクリックする, the テーブル shall 当該カラムで昇順ソートする
3. When ユーザーが同じカラムヘッダーを再度クリックする, the テーブル shall 当該カラムで降順ソートに切り替える
4. When ソートが適用されている, the カラムヘッダー shall 現在のソート方向を示すアイコンを表示する
5. The デフォルトのソート順 shall 「任意分類」「工種」「名称」「規格」「単位」の優先度で昇順とする

### Requirement 6: 内訳項目のフィルタリング

**Objective:** As a プロジェクト担当者, I want 内訳書の項目を条件で絞り込む, so that 必要な項目のみを表示できる

#### Acceptance Criteria

1. The 内訳書詳細画面 shall フィルタ入力エリアを提供する
2. When ユーザーが「任意分類」フィルタに値を入力する, the テーブル shall 任意分類が部分一致する項目のみを表示する
3. When ユーザーが「工種」フィルタに値を入力する, the テーブル shall 工種が部分一致する項目のみを表示する
4. When 複数のフィルタが設定されている, the テーブル shall 全条件をAND結合して絞り込む
5. When フィルタ結果が0件の場合, the テーブル shall 「該当する項目はありません」メッセージを表示する
6. The フィルタ shall クリアボタンで全フィルタを一括解除できる

### Requirement 7: 内訳書の削除

**Objective:** As a プロジェクト担当者, I want 不要な内訳書を削除する, so that 内訳書一覧を整理できる

#### Acceptance Criteria

1. The 内訳書詳細画面 shall 削除ボタンを表示する
2. When ユーザーが削除ボタンをクリックする, the システム shall 確認ダイアログを表示する
3. When ユーザーが確認ダイアログで削除を確定する, the システム shall 内訳書を論理削除してプロジェクト詳細画面に遷移する
4. If 削除処理中にエラーが発生する, then the システム shall エラーメッセージを表示し内訳書を削除しない

### Requirement 8: スナップショット独立性

**Objective:** As a システム, I want 内訳書を元データから独立したスナップショットとして保持する, so that 数量表の変更が既存内訳書に影響しない

#### Acceptance Criteria

1. When 内訳書が作成される, the システム shall 集計時点の数量項目データを内訳書に保存する
2. When 元の数量表が更新される, the 作成済み内訳書 shall 影響を受けない
3. When 元の数量表が削除される, the 作成済み内訳書 shall 影響を受けない
4. The 内訳書詳細画面 shall 集計元の数量表名を参照情報として表示する

### Requirement 9: パンくずナビゲーション

**Objective:** As a ユーザー, I want パンくずナビゲーションで現在位置を把握し上位階層に移動する, so that 画面間のナビゲーションがスムーズになる

#### Acceptance Criteria

1. The 内訳書詳細画面 shall パンくずナビゲーションを表示する
2. The パンくず shall 「プロジェクト一覧 > {プロジェクト名} > 内訳書 > {内訳書名}」形式で表示する
3. When ユーザーがパンくずの「プロジェクト名」をクリックする, the システム shall プロジェクト詳細画面に遷移する
4. When ユーザーがパンくずの「プロジェクト一覧」をクリックする, the システム shall プロジェクト一覧画面に遷移する

### Requirement 10: 楽観的排他制御

**Objective:** As a システム, I want 同時編集時のデータ競合を検知する, so that データの整合性が保たれる

#### Acceptance Criteria

1. The 内訳書 shall updatedAtフィールドを持つ
2. When 削除リクエストを受信する, the システム shall リクエストのupdatedAtと現在値を比較する
3. If updatedAtが一致しない, then the システム shall 409 Conflictエラーを返却する
4. When 409エラーが返却される, the クライアント shall 「他のユーザーにより更新されました。画面を再読み込みしてください」メッセージを表示する

### Requirement 11: プロジェクト詳細画面への統合

**Objective:** As a ユーザー, I want プロジェクト詳細画面から内訳書機能にアクセスする, so that 数量表機能と同じ操作感で内訳書を管理できる

#### Acceptance Criteria

1. The プロジェクト詳細画面 shall 数量表セクションの下に内訳書セクションを配置する
2. The 内訳書セクション shall 数量表セクションと同様のカードレイアウトを使用する
3. The 内訳書セクション shall 新規作成ボタンを表示する
4. The 内訳書セクション shall 作成済み内訳書へのリンクをリスト表示する
5. The 内訳書セクション shall 一覧画面へのリンクを表示する
