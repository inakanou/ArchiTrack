# Implementation Plan

## Task 1: データベーススキーマとマイグレーション

- [x] 1. (P) 内訳書データモデルの構築
  - ItemizedStatementテーブルを作成し、プロジェクトとの関連付け、内訳書名、集計元数量表参照情報（ID・名称スナップショット）、タイムスタンプを定義する
  - ItemizedStatementItemテーブルを作成し、内訳書への外部キー、任意分類・工種・名称・規格・単位の分類項目、数量（小数点以下2桁精度）、表示順序を定義する
  - 同一プロジェクト内での内訳書名重複を防ぐ部分一意制約（論理削除されていないレコードのみ）をインデックスで実装する
  - 検索・ソート用のインデックス（projectId、deletedAt、createdAt）を追加する
  - カスケード削除を設定し、プロジェクト削除時に内訳書も連動して削除されるようにする
  - _Requirements: 8.1, 10.1_

## Task 2: バックエンドサービス層

- [x] 2.1 (P) ピボット集計サービスの実装
  - 数量表の項目を取得し、任意分類・工種・名称・規格・単位の5項目をキーとしてグループ化するロジックを実装する
  - 同一キーのグループに対して数量を合計する処理を実装する
  - null値と空文字を同一グループとして扱うキー生成ロジックを実装する
  - Decimal.jsを使用して小数点以下2桁の精度で計算を行う
  - 合計値が許容範囲（-999999.99から9999999.99）を超えた場合にオーバーフローエラーをスローする
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2.2 内訳書CRUDサービスの実装
  - 内訳書作成処理を実装し、プロジェクトと数量表の存在確認、同名内訳書の重複チェック、項目数0件チェックを行う
  - ピボット集計サービスを呼び出して集計結果を取得し、トランザクション内で内訳書と項目を一括保存する
  - 作成時点の数量表名をスナップショットとして保存し、元データの変更に影響されないようにする
  - 内訳書詳細取得処理を実装し、プロジェクト情報と項目一覧を含むレスポンスを返す
  - プロジェクト別の内訳書一覧取得処理を実装し、作成日時降順でページネーション対応する
  - プロジェクト詳細画面用の最新内訳書サマリー取得処理を実装する
  - 論理削除処理を実装し、楽観的排他制御（updatedAt比較）を適用する
  - 監査ログサービスと連携して作成・削除操作を記録する
  - _Requirements: 1.3, 1.9, 1.10, 3.2, 3.4, 7.3, 8.1, 8.2, 8.3, 10.1, 10.2, 10.3_

## Task 3: バックエンドAPI層

- [x] 3.1 内訳書APIエンドポイントの実装
  - POST /api/projects/:projectId/itemized-statementsエンドポイントを実装し、作成リクエストを受け付ける
  - 作成リクエストのZodバリデーションスキーマを定義する（内訳書名必須・最大200文字、数量表ID必須・UUID形式）
  - GET /api/projects/:projectId/itemized-statementsエンドポイントを実装し、ページネーション・検索パラメータを受け付ける
  - GET /api/projects/:projectId/itemized-statements/latestエンドポイントを実装し、プロジェクト詳細画面用のサマリーを返す
  - GET /api/itemized-statements/:idエンドポイントを実装し、詳細情報と全項目を返す
  - DELETE /api/itemized-statements/:idエンドポイントを実装し、updatedAtによる楽観的排他制御を適用する
  - _Requirements: 1.1, 1.4, 1.5, 1.6, 1.7, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 7.1, 7.2, 7.4, 10.2, 10.3, 10.4_

- [x] 3.2 (P) エラーハンドリングの実装
  - 数量表未発見エラー（404）のレスポンス形式を定義する
  - 同名内訳書重複エラー（409）のレスポンス形式を定義する
  - 楽観的排他制御エラー（409）のレスポンス形式を定義する
  - オーバーフローエラー（422）のレスポンス形式を定義する
  - 空の数量表エラー（400）のレスポンス形式を定義する
  - _Requirements: 1.4, 1.9, 1.10, 2.5, 10.3, 10.4_

## Task 4: フロントエンド基盤

- [x] 4.1 (P) APIクライアントの実装
  - 内訳書作成APIの呼び出し関数を実装する
  - 内訳書一覧取得APIの呼び出し関数を実装する
  - 内訳書詳細取得APIの呼び出し関数を実装する
  - 内訳書削除APIの呼び出し関数を実装する
  - プロジェクト詳細用の最新内訳書サマリー取得関数を実装する
  - エラーレスポンスの型定義と変換処理を実装する
  - _Requirements: 1.3, 3.4, 3.5, 4.1, 7.3, 10.4_

- [x] 4.2 (P) 型定義とバリデーションの実装
  - 内訳書情報の型定義を作成する（ItemizedStatementInfo、ItemizedStatementDetail、ItemizedStatementItem）
  - 作成フォームの状態管理用型定義を作成する
  - フィルタリング・ソート状態の型定義を作成する
  - ページネーション状態の型定義を作成する
  - _Requirements: 4.2, 5.4, 6.2_

## Task 5: 内訳書作成フォーム

- [x] 5.1 内訳書作成フォームコンポーネントの実装
  - 数量表選択ドロップダウンを実装し、プロジェクトに紐づく数量表一覧を表示する
  - 数量表選択時に選択された数量表の項目数を表示する
  - 内訳書名入力フィールドを実装し、最大200文字の入力制限を適用する
  - 数量表未選択時の「数量表を選択してください」エラーメッセージを表示する
  - 内訳書名未入力時の「内訳書名を入力してください」エラーメッセージを表示する
  - 作成ボタンとキャンセルボタンを配置し、送信状態の管理を行う
  - 数量表がない場合は新規作成ボタンを無効化する
  - _Requirements: 1.1, 1.2, 1.4, 1.5, 1.6, 1.7, 1.8_

- [x] 5.2 作成フォームのエラー表示とローディング
  - 選択された数量表の項目数が0件の場合に「選択された数量表に項目がありません」エラーメッセージを表示する
  - 同名の内訳書が存在する場合に「同名の内訳書が既に存在します」エラーメッセージを表示する
  - オーバーフローエラー発生時のエラーメッセージを表示する
  - 集計処理中のローディングインジケーターを表示し、操作ボタンを無効化する
  - ローディング完了時にインジケーターを非表示にする
  - _Requirements: 1.9, 1.10, 2.5, 12.1, 12.4, 12.5_

## Task 6: プロジェクト詳細画面への統合

- [x] 6. 内訳書セクションカードの実装
  - プロジェクト詳細画面に数量表セクションの下に内訳書セクションカードを配置する
  - 数量表セクションと同様のカードレイアウトを使用してUIの一貫性を保つ
  - 新規作成ボタンを表示し、クリック時に作成フォームを開く
  - 数量表が存在しない場合は新規作成ボタンを無効化する
  - 作成済み内訳書を作成日時の降順でリスト表示し、各行に内訳書名、作成日時、集計元数量表名、合計項目数を表示する
  - 内訳書が存在しない場合は「内訳書はまだ作成されていません」メッセージを表示する
  - 各内訳書行をクリック可能にし、詳細画面へのナビゲーションを実装する
  - 一覧画面へのリンクを表示する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 11.1, 11.2, 11.3, 11.4, 11.5_

## Task 7: 内訳書詳細画面

- [x] 7.1 詳細画面の基本レイアウト
  - 内訳書詳細ページコンポーネントを作成する
  - ヘッダーに内訳書名と作成日時を表示する
  - 集計元の数量表名を参照情報として表示する
  - パンくずナビゲーションを「プロジェクト一覧 > {プロジェクト名} > 内訳書 > {内訳書名}」形式で表示する
  - プロジェクト一覧とプロジェクト名のリンクをクリック可能にする
  - 削除ボタンを配置する
  - データ取得中のローディングインジケーターを表示し、取得完了後に非表示にする
  - _Requirements: 4.4, 4.5, 8.4, 9.1, 9.2, 9.3, 9.4, 12.2, 12.5_

- [x] 7.2 内訳項目テーブルの実装
  - 集計結果をテーブル形式で表示し、任意分類・工種・名称・規格・数量・単位の順でカラムを配置する
  - 数量カラムを小数点以下2桁で表示し、桁が足りない場合は0で埋める
  - 最大2000件の内訳項目を表示可能にする
  - 内訳項目が50件を超える場合にページネーションを表示する
  - ページネーションで1ページあたり50件を表示し、現在のページ番号と総ページ数を表示する
  - _Requirements: 4.1, 4.2, 4.3, 4.6, 4.7, 4.8, 4.9_

## Task 8: ソート機能

- [x] 8. 内訳項目のソート機能実装
  - 各カラムヘッダーにソートボタンを表示する
  - カラムヘッダークリック時に該当カラムで昇順ソートを適用する
  - 同じカラムヘッダーを再度クリックした場合に降順ソートに切り替える
  - ソートが適用されているカラムヘッダーに現在のソート方向を示すアイコンを表示する
  - デフォルトのソート順として任意分類・工種・名称・規格の優先度で昇順を適用する
  - クライアントサイドでのソート処理を実装する（最大2000件のため）
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

## Task 9: フィルタリング機能

- [x] 9. 内訳項目のフィルタリング機能実装
  - フィルタ入力エリアを内訳書詳細画面に配置する
  - 任意分類・工種・名称・規格・単位の全カラムに対応するフィルタ入力フィールドを実装する
  - フィルタ値入力時に該当カラムで部分一致する項目のみを表示する
  - 複数のフィルタが設定されている場合に全条件をAND結合して絞り込む
  - フィルタ結果が0件の場合に「該当する項目はありません」メッセージを表示する
  - クリアボタンで全フィルタを一括解除できるようにする
  - フィルタが適用されている状態でページネーションを使用する場合、フィルタ結果に対してページネーションを適用する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_

## Task 10: 削除機能

- [ ] 10. 内訳書削除機能の実装
  - 削除ボタンクリック時に確認ダイアログを表示する
  - 確認ダイアログで削除を確定した場合に論理削除APIを呼び出す
  - 削除処理中のローディングインジケーターを表示し、操作ボタンを無効化する
  - 削除成功時にプロジェクト詳細画面に遷移する
  - 削除処理中にエラーが発生した場合にエラーメッセージを表示し内訳書を削除しない
  - 楽観的排他制御エラー（409）発生時に「他のユーザーにより更新されました。画面を再読み込みしてください」メッセージを表示する
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 10.2, 10.3, 10.4, 12.3, 12.4, 12.5_

## Task 11: ルーティングとナビゲーション

- [ ] 11. (P) 内訳書機能のルーティング設定
  - 内訳書詳細画面へのルートを追加する
  - プロジェクト詳細画面から内訳書詳細画面へのナビゲーションを実装する
  - 内訳書詳細画面からプロジェクト詳細画面への戻り遷移を実装する
  - 内訳書作成成功時に詳細画面への自動遷移を実装する
  - _Requirements: 3.5, 4.4, 7.3, 9.3, 9.4_

## Task 12: 単体テスト

- [ ] 12.1 (P) バックエンドサービス層の単体テスト
  - ピボット集計サービスのグループ化ロジックをテストする
  - 数量合計処理の精度（小数点以下2桁）をテストする
  - null/空文字の同一グループ扱いをテストする
  - オーバーフロー検出をテストする
  - 内訳書CRUDサービスの作成・取得・削除処理をテストする
  - 楽観的排他制御の動作をテストする
  - 重複名チェック、項目数0件チェックをテストする
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 1.9, 1.10, 10.2, 10.3_

- [ ] 12.2 (P) バックエンドAPI層の単体テスト
  - 各エンドポイントの正常系レスポンスをテストする
  - バリデーションエラー（400）のレスポンスをテストする
  - リソース未発見エラー（404）のレスポンスをテストする
  - 競合エラー（409）のレスポンスをテストする
  - _Requirements: 1.4, 1.6, 1.9, 1.10, 10.4_

- [ ] 12.3 (P) フロントエンドコンポーネントの単体テスト
  - 内訳書作成フォームのバリデーション動作をテストする
  - 内訳書セクションカードの表示状態をテストする
  - ソート・フィルタリング機能の動作をテストする
  - ページネーションの動作をテストする
  - _Requirements: 1.4, 1.6, 5.2, 5.3, 6.3, 6.4, 4.7, 4.8_

## Task 13: 統合テストとE2Eテスト

- [ ] 13.1 バックエンド統合テスト
  - 内訳書作成APIの一連のフローをテストする（数量表選択→集計→保存）
  - 内訳書一覧取得のページネーション・ソートをテストする
  - 内訳書削除と楽観的排他制御をテストする
  - スナップショット独立性（元データ変更後も内訳書が影響を受けないこと）をテストする
  - _Requirements: 1.3, 3.2, 7.3, 8.1, 8.2, 8.3, 10.2, 10.3_

- [ ] 13.2 E2Eテスト
  - 内訳書作成フローをテストする（プロジェクト詳細画面→数量表選択→名前入力→作成→詳細画面表示）
  - 内訳書一覧表示をテストする（プロジェクト詳細からの遷移、ページネーション）
  - 内訳書詳細操作をテストする（ソート、フィルタリング、削除）
  - エラーケースをテストする（重複名、空の数量表、楽観的排他制御エラー）
  - ローディング表示をテストする（作成時、詳細取得時、削除時）
  - パンくずナビゲーションの遷移をテストする
  - _Requirements: 1.1, 1.2, 1.3, 1.9, 1.10, 3.5, 4.7, 5.2, 6.3, 7.2, 9.3, 9.4, 10.4, 12.1, 12.2, 12.3_
