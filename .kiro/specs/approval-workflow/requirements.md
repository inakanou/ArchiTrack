# 要件定義書

## はじめに

本ドキュメントは、ArchiTrackプロジェクトにおける決裁ワークフロー機能の要件を定義します。この機能により、組織の承認プロセスを効率化し、適切な意思決定階層を維持できるようになります。

業務別の決裁ルート（見積もり、購買、支払い、現場変更）を実装し、金額閾値に応じた自動承認ルーティング、並列/直列承認、代理承認、承認履歴管理をサポートします。

**前提条件:**
- 本機能は `user-authentication` 仕様で定義されたRBACシステムに依存します
- 事前定義ロール（経営、営業、積算担当、購買担当、現場担当、経理担当）が利用可能であることを前提とします

## 要件

### 要件1: 決裁ワークフロー設計

**目的:** システムとして、業務別の決裁ワークフローを実装したい。そうすることで、組織の承認プロセスを効率化し、適切な意思決定階層を維持できるようになる。

#### 受入基準

1. WHEN システムが初期化される THEN Workflow Serviceは事前定義の決裁ルート（見積もり、購買、支払い）を自動作成しなければならない
2. WHERE 決裁ワークフローを定義する THE Workflow Serviceはワークフロータイプ、承認ステップ、金額閾値を保存しなければならない
3. WHEN 承認ステップを定義する THEN Workflow Serviceは必要なロール、承認順序、並列/直列の区別を含めなければならない
4. IF 金額が閾値を超える THEN Workflow Serviceは自動的に上位承認者（経営層）を追加しなければならない
5. WHERE ワークフローを実行する THE Workflow Serviceは現在のステップ、承認状態、次の承認者を追跡しなければならない
6. WHEN 全ての承認ステップが完了する THEN Workflow Serviceはワークフローを「承認済み」としてマークしなければならない
7. IF 任意のステップで差し戻しが発生する THEN Workflow Serviceはワークフローを「差し戻し」状態にし、起案者に通知しなければならない
8. WHERE 並列承認ステップがある THE Workflow Serviceは全ての並列承認者の承認を待たなければならない
9. WHEN ワークフローが開始される THEN Workflow Serviceは全承認者に通知を送信しなければならない
10. IF 承認が一定期間（例: 3日）行われない THEN Workflow Serviceはリマインダー通知を送信しなければならない

#### 決裁ワークフローの種類

**見積もりワークフロー:**
- **500万円未満**: 営業 → 積算担当
- **500万円以上1,000万円未満**: 営業 → 積算担当 → 購買担当
- **1,000万円以上**: 営業 → 積算担当 → 購買担当 → 経営

**購買ワークフロー:**
- **300万円未満**: 購買担当
- **300万円以上500万円未満**: 購買担当 → 積算担当
- **500万円以上**: 購買担当 → 積算担当 → 経営

**支払いワークフロー:**
- **100万円未満**: 経理担当
- **100万円以上500万円未満**: 経理担当 → 積算担当
- **500万円以上**: 経理担当 → 積算担当 → 経営

**現場変更承認ワークフロー:**
- **軽微な変更（予算影響なし）**: 現場担当
- **中程度の変更（予算影響あり）**: 現場担当 → 積算担当
- **重大な変更（予算10%以上）**: 現場担当 → 積算担当 → 経営

### 要件2: 決裁承認機能

**目的:** 承認者として、決裁ワークフローを承認・差し戻ししたい。そうすることで、組織のガバナンスを維持できるようになる。

#### 受入基準

1. WHEN 承認者がワークフローを承認する THEN Workflow Serviceは承認を記録し、次のステップに進めなければならない
2. IF 承認者が現在のステップの承認権限を持たない THEN Workflow Serviceは403 Forbiddenエラーを返さなければならない
3. WHEN 承認者がワークフローを差し戻す THEN Workflow Serviceは差し戻し理由を記録し、起案者に通知しなければならない
4. WHERE 承認者が代理承認権限を持つ THE Workflow Serviceは他の承認者の代わりに承認できなければならない
5. WHEN 承認が記録される THEN Workflow Serviceは承認者、承認日時、コメントを保存しなければならない
6. IF ワークフローが既に承認済みまたは差し戻し済みである THEN Workflow Serviceは重複承認を拒否しなければならない
7. WHERE 並列承認ステップがある THE Workflow Serviceは各承認者が独立して承認できなければならない
8. WHEN 承認者がコメントを追加する THEN Workflow Serviceはコメントを承認履歴に記録しなければならない
9. IF 承認者が不在である AND 代理承認者が設定されている THEN Workflow Serviceは代理承認者に通知しなければならない
10. WHERE 経営層の承認が必要な場合 THE Workflow Serviceは金額情報、リスク評価、関連ドキュメントを承認画面に表示しなければならない

#### 承認履歴の構造

```json
{
  "workflowId": "uuid",
  "workflowType": "見積もり | 購買 | 支払い | 現場変更",
  "currentStep": 2,
  "totalSteps": 3,
  "status": "進行中 | 承認済み | 差し戻し | キャンセル",
  "approvalHistory": [
    {
      "stepNumber": 1,
      "approver": {
        "userId": "uuid",
        "name": "山田太郎",
        "role": "営業"
      },
      "action": "承認 | 差し戻し",
      "timestamp": "ISO 8601",
      "comment": "承認します。見積もり内容を確認しました。",
      "delegatedBy": null
    },
    {
      "stepNumber": 2,
      "approver": {
        "userId": "uuid",
        "name": "佐藤花子",
        "role": "積算担当"
      },
      "action": "承認",
      "timestamp": "ISO 8601",
      "comment": "原価計算を確認しました。問題ありません。",
      "delegatedBy": null
    }
  ],
  "nextApprovers": [
    {
      "userId": "uuid",
      "name": "鈴木一郎",
      "role": "経営"
    }
  ]
}
```

### 要件3: 業務別決裁ルートの最適化

**目的:** システム管理者として、業務実態に合わせて決裁ルートを最適化したい。そうすることで、効率的かつ適切なガバナンスを実現できるようになる。

#### 受入基準

1. WHEN システム管理者がカスタム決裁ルートを作成する THEN Workflow Serviceはルート名、適用条件（ワークフロータイプ、金額範囲）、承認ステップを保存しなければならない
2. IF カスタムルートが事前定義ルートと競合する THEN Workflow Serviceはカスタムルートを優先しなければならない
3. WHERE 決裁ルートを評価する THE Workflow Serviceは最も具体的な条件にマッチするルートを選択しなければならない
4. WHEN 決裁ルートを更新する THEN Workflow Serviceは既存の進行中ワークフローには影響を与えてはならない
5. IF システム管理者が決裁ルートを削除する AND ルートが進行中のワークフローで使用されている THEN Workflow Serviceは削除を拒否しなければならない
6. WHERE システム管理者が決裁ルート一覧を取得する THE Workflow Serviceは全てのルート（事前定義、カスタム）を返さなければならない
7. WHEN 決裁ルートを作成する THEN Workflow Serviceは承認ステップの循環参照をチェックしなければならない
8. IF 承認ステップに無効なロールが含まれる THEN Workflow Serviceはバリデーションエラーを返さなければならない

#### 業務別ベストプラクティス

**経営:**
- 最終意思決定者として、高額案件（1,000万円以上）の最終承認を担当
- 全ADRへのアクセス権限により、組織全体の状況を把握
- 承認権限の委譲により、不在時も業務継続を保証

**営業:**
- 顧客との接点として、見積もりADRを起案
- 見積もりワークフローの最初の承認者として、顧客要件の妥当性をチェック
- 売上レポート閲覧により、営業実績を追跡

**積算担当:**
- 原価計算の専門家として、見積もりの技術的妥当性を承認
- 中程度の金額（500万円以下）の見積もりを最終承認
- 購買担当と連携し、資材コストを最適化

**購買担当:**
- ベンダー管理の専門家として、購買ADRを起案・承認
- 中程度の金額（300万円以下）の購買を単独で承認
- 積算担当と連携し、資材調達計画を策定

**現場担当:**
- 現場の実態を反映し、進捗報告と変更承認を担当
- リソースレベルの権限チェックにより、自分が担当するプロジェクトのみアクセス
- 軽微な変更（予算影響なし）を単独で承認

**経理担当:**
- 財務管理の専門家として、全ADRの閲覧と支払い承認を担当
- 中程度の金額（100万円以下）の支払いを単独で承認
- 経理レポートのエクスポートにより、外部監査に対応

#### マルチロール対応のベストプラクティス

1. **兼務の例**: 小規模組織では、積算担当と購買担当を兼務するケースがある。マルチロール対応により、両方の権限を一人のユーザーに割り当て可能。
2. **職務変更**: 営業から積算担当への異動時、段階的にロールを追加・削除することで、スムーズな引き継ぎを実現。
3. **代理承認**: 経営層が不在時、積算担当に一時的に経営ロールを追加し、高額案件の承認を継続。
4. **権限の統合**: 複数のロールを持つユーザーは、全てのロールの権限をOR演算で統合。例: 営業 + 積算担当 = 見積もり起案 + 見積もり承認。

### 要件4: 承認待ち一覧とダッシュボード

**目的:** 承認者として、自分が承認すべきワークフローを効率的に確認したい。そうすることで、承認業務を迅速に処理できるようになる。

#### 受入基準

1. WHEN 承認者がダッシュボードにアクセスする THEN Workflow Serviceは自分が承認者となっているワークフロー一覧を返さなければならない
2. WHERE 承認待ち一覧を表示する THE Workflow Serviceはワークフローのタイプ、起案者、金額、起案日時、緊急度を含めなければならない
3. WHEN 承認者が緊急度順にソートする THEN Workflow Serviceは起案日時が古い順、金額が高い順で並び替えなければならない
4. IF ワークフローが3日以上未承認である THEN Workflow Serviceは「緊急」フラグを設定しなければならない
5. WHERE 承認待ち一覧をフィルタリングする THE Workflow Serviceはワークフロータイプ、金額範囲、日付範囲でフィルタリングをサポートしなければならない
6. WHEN 承認者がワークフローの詳細を表示する THEN Workflow Serviceは承認履歴、関連ドキュメント、ADR詳細を返さなければならない
7. IF ワークフローに添付ファイルがある THEN Workflow Serviceは添付ファイルのダウンロードリンクを提供しなければならない
8. WHERE 承認者が複数のロールを持つ THE Workflow Serviceは全てのロールに関連するワークフローを統合して表示しなければならない

### 要件5: ワークフロー通知機能

**目的:** ユーザーとして、ワークフローの進捗状況をタイムリーに知りたい。そうすることで、適切なタイミングで対応できるようになる。

#### 受入基準

1. WHEN ワークフローが開始される THEN Notification Serviceは全承認者にメール通知を送信しなければならない
2. WHEN ワークフローが承認される THEN Notification Serviceは起案者と次の承認者に通知を送信しなければならない
3. WHEN ワークフローが差し戻される THEN Notification Serviceは起案者に差し戻し理由を含めて通知しなければならない
4. WHEN ワークフローが最終承認される THEN Notification Serviceは起案者と全承認者に完了通知を送信しなければならない
5. IF ワークフローが3日以上未承認である THEN Notification Serviceはリマインダー通知を承認者に送信しなければならない
6. WHERE 承認者が不在設定をしている THE Notification Serviceは代理承認者に通知を送信しなければならない
7. WHEN ユーザーが通知設定を変更する THEN Notification Serviceは通知方法（メール、アプリ内通知、SMS）を更新しなければならない
8. IF ユーザーが通知を無効化している THEN Notification Serviceは緊急度が高いワークフローのみ通知しなければならない
9. WHERE アプリ内通知を表示する THE Notification Serviceは未読件数をバッジで表示しなければならない
10. WHEN ユーザーが通知を既読にする THEN Notification Serviceは既読フラグを更新しなければならない

### 要件6: ワークフロー履歴とレポート

**目的:** システム管理者として、ワークフローの統計情報を分析したい。そうすることで、業務プロセスを改善できるようになる。

#### 受入基準

1. WHEN システム管理者がワークフロー履歴を取得する THEN Reporting Serviceは全てのワークフロー（進行中、承認済み、差し戻し、キャンセル）を返さなければならない
2. WHERE ワークフロー履歴をフィルタリングする THE Reporting Serviceはワークフロータイプ、ステータス、日付範囲、承認者、起案者でフィルタリングをサポートしなければならない
3. WHEN システム管理者がレポートを生成する THEN Reporting Serviceは以下の統計情報を含めなければならない
   - ワークフロータイプ別の件数
   - 平均承認時間
   - 承認者別の処理件数
   - 差し戻し率
   - 金額帯別の分布
4. IF レポートをエクスポートする THEN Reporting ServiceはCSV、Excel、PDF形式をサポートしなければならない
5. WHERE ダッシュボードで統計を表示する THE Reporting Serviceはグラフ（棒グラフ、円グラフ、折れ線グラフ）形式でデータを提供しなければならない
6. WHEN 承認時間が組織の目標（例: 2日以内）を超える THEN Reporting Serviceはアラートを表示しなければならない
7. IF 差し戻し率が閾値（例: 20%）を超える THEN Reporting Serviceは業務プロセス改善の推奨を表示しなければならない
8. WHERE 経営層がレポートにアクセスする THE Reporting Serviceは組織全体のKPI（承認効率、ボトルネック、リスク案件）を表示しなければならない

## UI/UX要件

### 要件7: 承認画面のUI/UX

**目的:** 承認者として、直感的で効率的な承認画面を利用したい。そうすることで、迅速に承認業務を処理できるようになる。

#### 受入基準

1. WHEN 承認画面が表示される THEN UIはワークフロー詳細（タイプ、起案者、金額、起案日時）、承認履歴、関連ドキュメント、承認/差し戻しボタンを表示しなければならない
2. WHERE 承認履歴を表示する THE UIは各ステップの承認者、承認日時、コメント、アクション（承認/差し戻し）を時系列で表示しなければならない
3. WHEN 承認者がコメントを入力する THEN UIはリッチテキストエディタ（太字、リスト、リンク）を提供しなければならない
4. IF 差し戻しボタンがクリックされる THEN UIは差し戻し理由の入力を必須にしなければならない
5. WHEN 承認ボタンがクリックされる THEN UIは確認ダイアログ（「承認してもよろしいですか？」）を表示しなければならない
6. WHERE 関連ドキュメントがある THE UIはプレビュー機能（PDF、画像）とダウンロードボタンを提供しなければならない
7. WHEN ワークフローが金額閾値を超える THEN UIは警告メッセージ（「高額案件のため、経営承認が必要です」）を表示しなければならない
8. IF ワークフローが緊急度「高」である THEN UIは赤色のバッジと「緊急」ラベルを表示しなければならない
9. WHERE 並列承認ステップがある THE UIは他の承認者の承認状況を表示しなければならない
10. WHEN 承認が完了する THEN UIは成功メッセージを表示し、承認待ち一覧へリダイレクトしなければならない
11. WHERE デバイス画面幅が768px未満である THE UIはモバイル最適化されたレイアウトを表示しなければならない

### 要件8: ワークフロー起案画面のUI/UX

**目的:** 起案者として、簡単にワークフローを開始したい。そうすることで、承認プロセスをスムーズに進められるようになる。

#### 受入基準

1. WHEN ワークフロー起案画面が表示される THEN UIはワークフロータイプ選択、金額入力、説明入力、添付ファイルアップロード、起案ボタンを表示しなければならない
2. WHERE ワークフロータイプを選択する THE UIは選択したタイプに応じた承認ルートプレビューを表示しなければならない
3. WHEN 金額を入力する THEN UIは金額に応じた承認者を動的に表示しなければならない
4. IF 金額が閾値を超える THEN UIは「経営承認が必要です」という警告を表示しなければならない
5. WHERE 添付ファイルをアップロードする THE UIはドラッグ&ドロップをサポートしなければならない
6. WHEN ファイルサイズが10MBを超える THEN UIはエラーメッセージを表示しなければならない
7. IF 起案ボタンがクリックされる AND 必須フィールドが未入力である THEN UIはバリデーションエラーを表示しなければならない
8. WHEN ワークフローが起案される THEN UIは成功メッセージと起案番号を表示しなければならない
9. WHERE 起案者が過去の起案を参照する THE UIはテンプレート機能（過去の起案をコピー）を提供しなければならない
10. WHERE デバイス画面幅が768px未満である THE UIはモバイル最適化されたレイアウトを表示しなければならない

### 要件9: ワークフローダッシュボードのUI/UX

**目的:** ユーザーとして、自分に関連するワークフローを一目で確認したい。そうすることで、効率的にタスクを管理できるようになる。

#### 受入基準

1. WHEN ダッシュボードが表示される THEN UIは承認待ち一覧、自分が起案したワークフロー一覧、統計サマリーを表示しなければならない
2. WHERE 承認待ち一覧を表示する THE UIはワークフロータイプ、起案者、金額、起案日時、緊急度をテーブル形式で表示しなければならない
3. WHEN ユーザーがテーブルのヘッダーをクリックする THEN UIはソート順を切り替えなければならない
4. WHERE 統計サマリーを表示する THE UIは承認待ち件数、今月の承認件数、平均承認時間をカード形式で表示しなければならない
5. IF 承認待ちが10件以上ある THEN UIは緊急度が高い順に並び替え、上位5件をハイライト表示しなければならない
6. WHEN ユーザーがワークフローをクリックする THEN UIは詳細画面へ遷移しなければならない
7. WHERE フィルタリング機能がある THE UIはワークフロータイプ、緊急度、日付範囲でフィルタリングをサポートしなければならない
8. WHEN ユーザーがダッシュボードをリフレッシュする THEN UIは最新のデータを取得し、未読通知をバッジで表示しなければならない
9. WHERE デバイス画面幅が768px未満である THE UIはテーブルをカード形式のレイアウトに変換しなければならない
10. WHEN 承認待ちが0件である THEN UIは「承認待ちのワークフローはありません」というメッセージを表示しなければならない

### 要件10: 共通UI/UXガイドライン（ワークフロー）

**目的:** ワークフロー機能全体で一貫性のあるユーザー体験を提供したい。そうすることで、ユーザビリティとアクセシビリティを向上できるようになる。

#### 受入基準

1. WHERE 全てのワークフロー画面がある THE UIはレスポンシブデザイン（モバイル: 320px-767px、タブレット: 768px-1023px、デスクトップ: 1024px以上）を実装しなければならない
2. WHEN ワークフローのステータスを表示する THEN UIは色コード（進行中: 青、承認済み: 緑、差し戻し: 赤、キャンセル: グレー）とアイコンを使用しなければならない
3. WHERE 緊急度を表示する THE UIはバッジ（緊急: 赤、通常: グレー）を使用しなければならない
4. WHEN フォーム送信エラーが発生する THEN UIは最初のエラーフィールドにスクロールし、フォーカスしなければならない
5. WHERE 全てのボタンとリンクがある THE UIはキーボード操作（Tab、Enter、Space）をサポートしなければならない
6. WHEN ページが読み込まれる THEN UIは適切なaria-label、aria-describedby、role属性を提供しなければならない
7. WHERE カラー情報を使用する THE UIは色だけに依存せず、テキストやアイコンで補完しなければならない
8. WHEN フォームバリデーションエラーが発生する THEN UIはエラーメッセージをaria-liveリージョンで通知しなければならない
9. WHERE 全ての画面がある THE UIは最低コントラスト比4.5:1（WCAG 2.1 AA準拠）を維持しなければならない
10. WHEN APIリクエストが5秒以上かかる THEN UIはプログレスバーまたは進捗メッセージを表示しなければならない
11. WHERE トーストメッセージが表示される THE UIは3-5秒後に自動的に非表示にしなければならない
12. WHEN モーダルダイアログが開かれる THEN UIはフォーカストラップを実装し、Escキーで閉じられるようにしなければならない

## テスト戦略

### 要件11: Storybookによるビジュアル要件管理

**目的:** 開発チームとステークホルダーとして、実装前にワークフローUIコンポーネントを視覚的に確認・検証したい。そうすることで、要件の認識齟齬を早期に発見し、効率的な開発を実現できるようになる。

#### 受入基準

1. WHERE 全てのワークフロー画面コンポーネントがある THE Storybookは個別のストーリーを提供しなければならない
2. WHEN 承認画面ストーリーが表示される THEN Storybookは以下の状態バリアントを提供しなければならない
   - デフォルト状態（承認待ち）
   - 承認履歴表示状態
   - コメント入力状態
   - 承認確認ダイアログ
   - 差し戻し確認ダイアログ
   - 承認完了状態
3. WHEN ワークフロー起案画面ストーリーが表示される THEN Storybookは以下の状態バリアントを提供しなければならない
   - デフォルト状態（空のフォーム）
   - ワークフロータイプ選択状態
   - 承認ルートプレビュー
   - 添付ファイルアップロード状態
   - バリデーションエラー状態
   - 起案処理中
   - 起案成功
4. WHEN ダッシュボードストーリーが表示される THEN Storybookは以下の状態バリアントを提供しなければならない
   - 承認待ち0件
   - 承認待ち1-9件
   - 承認待ち10件以上
   - 緊急度別フィルタリング
   - ソート機能（日付、金額、緊急度）
5. WHERE 全てのストーリーがある THE Storybookはインタラクティブコントロール（Controls addon）を提供しなければならない
6. WHEN Storybookコントロールが提供される THEN 以下のプロパティを調整可能にしなければならない
   - ワークフロータイプ
   - ワークフローステータス（進行中、承認済み、差し戻し）
   - 緊急度（緊急、通常）
   - 金額
   - 起案日時
7. WHERE 全てのストーリーがある THE Storybookはアクセシビリティアドオン（a11y addon）を有効化しなければならない
8. WHERE Storybookドキュメントがある THE 各ストーリーは対応する要件番号と受入基準を明記しなければならない
9. WHEN ストーリーがレンダリングされる THEN レスポンシブデザインを検証するためのビューポートアドオンを提供しなければならない
10. WHERE 全てのワークフローコンポーネントがある THE Storybookはユーザーインタラクションをシミュレートする「Play function」を提供しなければならない

## 依存関係

本仕様は以下の仕様に依存します：

- **user-authentication**: 認証・認可機能
  - RBACシステム（ロール、権限、ユーザー・ロール紐付け）を利用
  - 事前定義ロール（システム管理者、経営、営業、積算担当、購買担当、現場担当、経理担当、一般ユーザー）を活用
  - 権限チェック機能（`adr:approve`, `adr:delegate`, `adr:reject`）を利用
  - 監査ログ機能を利用してワークフロー操作を記録
