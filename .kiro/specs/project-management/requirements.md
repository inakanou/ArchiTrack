# Requirements Document

## Introduction

本ドキュメントは、ArchiTrackシステムにおけるプロジェクト機能の要件を定義します。プロジェクトとは、工事の案件が発生した際に最初に作成されるエンティティであり、当該工事における現場調査や見積などの業務は、プロジェクト配下にぶら下がる形で管理されます。

プロジェクト機能は、以下の2つの画面で構成されます：
- **プロジェクト一覧画面**: 全プロジェクトの閲覧・検索・フィルタリング
- **プロジェクト詳細画面**: 個別プロジェクトの詳細情報表示・編集・関連データの管理

### 既存機能との連携

本機能は、ArchiTrackの既存実装を活用します：
- **認証・認可**: 既存のJWT認証（EdDSA署名）およびRBACサービス（`rbac.service.ts`）を使用
- **監査ログ**: 既存の監査ログサービス（`audit-log.service.ts`）を使用してプロジェクト操作を記録
- **ユーザー管理**: 既存のユーザーテーブルおよびAPIを使用して担当者選択を実装
- **UIコンポーネント**: 既存の`AppHeader`、`ProtectedLayout`、`ToastNotification`等を使用

### Data Entities（概要）

- **Project**: プロジェクトの基本情報（ID、名前、顧客名、担当者、ステータス等）
- **ProjectStatusHistory**: ステータス変更の履歴（変更前後のステータス、変更日時、変更者）

## Requirements

### Requirement 1: プロジェクト作成

**Objective:** As a ユーザー, I want 新規プロジェクトを作成する, so that 工事案件の管理を開始できる

#### Acceptance Criteria

1. When ユーザーがプロジェクト一覧画面で「新規作成」ボタンをクリックする, the システム shall プロジェクト作成フォームを表示する
2. The システム shall プロジェクト作成フォームに以下の入力フィールドを表示する: プロジェクト名（必須）、顧客名（必須）、営業担当者（必須）、工事担当者（任意）、現場住所（任意）、概要（任意）
3. When ユーザーが顧客名フィールドにテキストを入力する, the システム shall 取引先管理機能で登録された取引先名をオートコンプリート候補として表示する
4. When ユーザーがオートコンプリート候補から取引先を選択する, the システム shall 選択された取引先名を顧客名フィールドに設定する
5. The システム shall 営業担当者フィールドのデフォルト値としてログインユーザーの表示名を設定する
6. The システム shall 工事担当者フィールドのデフォルト値としてログインユーザーの表示名を設定する
7. When ユーザーが必須項目（プロジェクト名、顧客名、営業担当者）を入力して「作成」ボタンをクリックする, the システム shall 新規プロジェクトをデータベースに保存し、プロジェクト詳細画面に遷移する
8. If ユーザーが必須項目を入力せずに「作成」ボタンをクリックする, then the システム shall 入力エラーメッセージを該当フィールドに表示する
9. If プロジェクト名が未入力の場合, then the システム shall 「プロジェクト名は必須です」というバリデーションエラーを表示する
10. If プロジェクト名が255文字を超える場合, then the システム shall 「プロジェクト名は255文字以内で入力してください」というバリデーションエラーを表示する
11. If 顧客名が未入力の場合, then the システム shall 「顧客名は必須です」というバリデーションエラーを表示する
12. If 営業担当者が未選択の場合, then the システム shall 「営業担当者は必須です」というバリデーションエラーを表示する
13. When プロジェクトが正常に作成される, the システム shall 作成日時と作成者を自動的に記録する
14. The システム shall プロジェクトに一意のIDを自動付与する

### Requirement 2: プロジェクト一覧表示

**Objective:** As a ユーザー, I want プロジェクト一覧を閲覧する, so that 管理しているプロジェクトの全体像を把握できる

#### Acceptance Criteria

1. When ユーザーがプロジェクト一覧画面にアクセスする, the システム shall 認可されたプロジェクトの一覧をテーブル形式で表示する
2. The システム shall 各プロジェクトのID、プロジェクト名、顧客名、ステータス、作成日、更新日を一覧に表示する（列順序: ID、プロジェクト名、顧客名、ステータス、作成日、更新日）
3. When ユーザーがプロジェクト行をクリックする, the システム shall 該当プロジェクトの詳細画面に遷移する
4. While プロジェクト一覧のデータを取得中, the システム shall ローディングインジケータを表示する
5. If プロジェクトが0件の場合, then the システム shall 「プロジェクトがありません。新規作成してください。」というメッセージを表示する
6. The システム shall プロジェクト一覧を更新日時の降順でデフォルト表示する

### Requirement 3: プロジェクト一覧のページネーション

**Objective:** As a ユーザー, I want プロジェクト一覧をページ分割して閲覧する, so that 大量のプロジェクトを効率的に閲覧できる

#### Acceptance Criteria

1. The システム shall 1ページあたりのデフォルト表示件数を20件とする
2. When プロジェクト総数がページサイズを超える場合, the システム shall ページネーションコントロールを表示する
3. When ユーザーがページ番号をクリックする, the システム shall 該当ページのプロジェクトを表示する
4. The システム shall 現在のページ番号、総ページ数、総プロジェクト数を表示する
5. When ユーザーが表示件数を変更する, the システム shall 選択された件数で一覧を再表示する

### Requirement 4: プロジェクト検索

**Objective:** As a ユーザー, I want プロジェクトを検索する, so that 目的のプロジェクトを素早く見つけられる

#### Acceptance Criteria

1. When ユーザーが検索フィールドにキーワードを入力してEnterキーを押すまたは検索ボタンをクリックする, the システム shall プロジェクト名と顧客名を対象に部分一致検索を実行する
2. When 検索結果が0件の場合, the システム shall 「該当するプロジェクトが見つかりませんでした。」というメッセージを表示する
3. When ユーザーが検索キーワードをクリアする, the システム shall 全プロジェクト一覧を再表示する
4. The システム shall 検索キーワードは2文字以上で検索を実行する
5. If 検索キーワードが1文字以下の場合, then the システム shall 「2文字以上で入力してください」というメッセージを表示する

### Requirement 5: プロジェクトフィルタリング

**Objective:** As a ユーザー, I want プロジェクトをステータスや期間でフィルタリングする, so that 必要なプロジェクトのみを効率的に表示できる

#### Acceptance Criteria

1. When ユーザーがステータスフィルタで値を選択する, the システム shall 選択されたステータスのプロジェクトのみを表示する
2. The システム shall 期間フィルタで「作成日」を基準とした日付範囲フィルタリングを提供する
3. When ユーザーが期間フィルタで日付範囲を指定する, the システム shall 指定された期間内に作成されたプロジェクトのみを表示する
4. When ユーザーが複数のフィルタを適用する, the システム shall AND条件で絞り込みを実行する
5. When ユーザーが「フィルタをクリア」をクリックする, the システム shall すべてのフィルタを解除し、全プロジェクトを表示する
6. The システム shall フィルタの選択状態をURLパラメータに反映する

### Requirement 6: プロジェクト一覧のソート

**Objective:** As a ユーザー, I want プロジェクト一覧をソートする, so that 目的に応じた順序でプロジェクトを確認できる

#### Acceptance Criteria

1. When ユーザーがテーブルヘッダーをクリックする, the システム shall 該当カラムで昇順ソートを実行する
2. When ユーザーが同じテーブルヘッダーを再度クリックする, the システム shall 降順ソートに切り替える
3. The システム shall 現在のソート状態をヘッダーにアイコン（昇順: ↑、降順: ↓）で表示する
4. The システム shall ソート対象外のカラムヘッダーにはソートアイコンを表示しない
5. The システム shall ID、プロジェクト名、顧客名、ステータス、作成日、更新日のカラムでソート可能とする

### Requirement 7: プロジェクト詳細表示

**Objective:** As a ユーザー, I want プロジェクトの詳細情報を閲覧する, so that プロジェクトの現状を正確に把握できる

#### Acceptance Criteria

1. When ユーザーがプロジェクト詳細画面にアクセスする, the システム shall プロジェクトの全情報（プロジェクト名、顧客名、営業担当者、工事担当者、説明、ステータス、住所、作成日、更新日）を表示する
2. While プロジェクト詳細データを取得中, the システム shall ローディングインジケータを表示する
3. If 指定されたプロジェクトIDが存在しない, then the システム shall 404エラーページを表示する
4. If ユーザーがプロジェクトへのアクセス権限を持たない, then the システム shall 403エラーページを表示する
5. The システム shall プロジェクト詳細画面に「一覧に戻る」リンクを表示する
6. The システム shall 営業担当者フィールドにユーザーの表示名を表示する
7. If 工事担当者が設定されている場合, then the システム shall 工事担当者フィールドにユーザーの表示名を表示する

### Requirement 8: プロジェクト編集

**Objective:** As a ユーザー, I want プロジェクト情報を編集する, so that プロジェクトの最新情報を維持できる

#### Acceptance Criteria

1. When ユーザーがプロジェクト詳細画面で「編集」ボタンをクリックする, the システム shall プロジェクト編集フォームを表示する
2. When ユーザーがフォームを編集して「保存」ボタンをクリックする, the システム shall 変更内容をデータベースに保存する
3. When プロジェクトが正常に更新される, the システム shall 更新日時を自動的に記録し、成功メッセージを表示する
4. If バリデーションエラーが発生した場合, then the システム shall エラーメッセージを該当フィールドに表示する
5. When ユーザーが「キャンセル」ボタンをクリックする, the システム shall 編集内容を破棄し、詳細表示に戻る
6. If 編集中に他のユーザーがプロジェクトを更新した場合, then the システム shall 競合エラーを表示し、最新データの確認を促す

### Requirement 9: プロジェクト削除

**Objective:** As a ユーザー, I want 不要なプロジェクトを削除する, so that 管理対象を整理できる

#### Acceptance Criteria

1. When ユーザーがプロジェクト詳細画面で「削除」ボタンをクリックする, the システム shall 削除確認ダイアログを表示する
2. When ユーザーが削除確認ダイアログで「削除」を選択する, the システム shall プロジェクトを論理削除し、プロジェクト一覧画面に遷移する
3. When プロジェクトが正常に削除される, the システム shall 「プロジェクトを削除しました」という成功メッセージを表示する
4. When ユーザーが削除確認ダイアログで「キャンセル」を選択する, the システム shall ダイアログを閉じ、詳細画面に留まる
5. If プロジェクトに関連データ（現場調査、見積書等）が存在する, then the システム shall 「関連データがあります。本当に削除しますか？」という警告メッセージを表示し、「削除する」「キャンセル」の選択肢を提供する
6. When ユーザーが関連データ警告ダイアログで「削除する」を選択する, the システム shall 関連データを含めてプロジェクトを論理削除する
7. The システム shall 削除されたプロジェクトは一覧に表示しない

### Requirement 10: プロジェクトステータス管理

**Objective:** As a ユーザー, I want プロジェクトのステータスを管理する, so that プロジェクトの進捗を追跡できる

#### Acceptance Criteria

1. The システム shall プロジェクトステータスとして以下の12種類を提供する: 「準備中」「調査中」「見積中」「決裁待ち」「契約中」「工事中」「引渡中」「請求中」「入金待ち」「完了」「中止」「失注」
2. The システム shall 新規作成時のデフォルトステータスを「準備中」とする
3. The システム shall 以下のメインワークフロー遷移を許可する: 準備中 → 調査中 → 見積中 → 決裁待ち → 契約中 → 工事中 → 引渡中 → 請求中 → 入金待ち → 完了
4. The システム shall 以下の中止遷移を許可する: 準備中 → 中止、調査中 → 中止、見積中 → 中止
5. The システム shall 以下の失注遷移を許可する: 決裁待ち → 失注、契約中 → 失注
6. When ユーザーが許可されたステータス遷移を実行する, the システム shall 新しいステータスをデータベースに保存する
7. If ユーザーが許可されていないステータス遷移を実行しようとする, then the システム shall エラーメッセージを表示し、遷移を拒否する
8. When ステータスが変更される, the システム shall ステータス変更履歴（変更前ステータス、変更後ステータス、変更日時、変更したユーザー）を記録する
9. The システム shall 各ステータスを視覚的に区別できる色分けで表示する
10. The システム shall ステータス変更履歴をプロジェクト詳細画面で閲覧可能にする

### Requirement 11: プロジェクト関連データの参照

**Objective:** As a ユーザー, I want プロジェクトに関連するデータを参照する, so that プロジェクト全体の状況を把握できる

#### Acceptance Criteria

1. When ユーザーがプロジェクト詳細画面にアクセスする, the システム shall 関連する現場調査の件数を表示する
2. When ユーザーがプロジェクト詳細画面にアクセスする, the システム shall 関連する見積書の件数を表示する
3. When ユーザーが「現場調査一覧」リンクをクリックする, the システム shall 該当プロジェクトの現場調査一覧画面に遷移する
4. When ユーザーが「見積書一覧」リンクをクリックする, the システム shall 該当プロジェクトの見積書一覧画面に遷移する
5. The システム shall 関連データがない場合は「0件」と表示する

### Requirement 12: アクセス制御

**Objective:** As a システム管理者, I want プロジェクトへのアクセスを制御する, so that 情報セキュリティを確保できる

**既存実装の活用:** 本要件は既存の認証・認可基盤（`authenticate.middleware.ts`、`authorize.middleware.ts`、`rbac.service.ts`）および監査ログ基盤（`audit-log.service.ts`）を活用して実装する。

#### Acceptance Criteria

1. The システム shall 既存のJWT認証ミドルウェアを使用して認証済みユーザーのみがプロジェクト機能にアクセスできるようにする
2. The システム shall 既存のRBACサービスを使用してプロジェクトへのアクセス権限を判定する
3. When ユーザーが権限のない操作を実行しようとする, the システム shall 既存のauthorizeミドルウェアを通じて403 Forbiddenエラーを返却する
4. The システム shall 既存の監査ログサービスを使用してプロジェクト操作を記録する
5. The システム shall 「project:create」「project:read」「project:update」「project:delete」の権限を既存のPermissionテーブルに追加する
6. The システム shall 監査ログに記録する操作を以下とする: プロジェクト作成、更新、削除、ステータス変更

### Requirement 13: データバリデーション

**Objective:** As a 開発者, I want 入力データのバリデーションを実装する, so that データの整合性を確保できる

#### Acceptance Criteria

1. The システム shall プロジェクト名を必須かつ1〜255文字とする
2. The システム shall 顧客名を必須かつ1〜255文字とする
3. The システム shall 営業担当者を必須とする
4. The システム shall 営業担当者の値がadmin以外の有効なユーザーIDであることを検証する
5. The システム shall 工事担当者を任意とする
6. If 工事担当者が指定された場合, then the システム shall 工事担当者の値がadmin以外の有効なユーザーIDであることを検証する
7. The システム shall 現場住所を任意かつ最大500文字とする
8. The システム shall 概要を任意かつ最大5000文字とする
9. If 顧客名に取引先として登録されていない名前が入力された場合, then the システム shall 入力を許可する（取引先外の顧客も入力可能）
10. If フロントエンドでバリデーションエラーが発生する, then the システム shall エラーメッセージを即座に表示する
11. If バックエンドでバリデーションエラーが発生する, then the システム shall 400 Bad Requestエラーとエラー詳細を返却する

### Requirement 14: APIエンドポイント

**Objective:** As a 開発者, I want RESTful APIを通じてプロジェクトデータにアクセスする, so that フロントエンドとバックエンドを分離できる

#### Acceptance Criteria

1. The システム shall `GET /api/projects` エンドポイントでプロジェクト一覧を取得できるようにする
2. The システム shall `GET /api/projects/:id` エンドポイントでプロジェクト詳細を取得できるようにする
3. The システム shall `POST /api/projects` エンドポイントでプロジェクトを作成できるようにする
4. The システム shall `PUT /api/projects/:id` エンドポイントでプロジェクトを更新できるようにする
5. The システム shall `DELETE /api/projects/:id` エンドポイントでプロジェクトを削除できるようにする
6. The システム shall 一覧取得APIでページネーション、検索、フィルタリング、ソートのクエリパラメータをサポートする
7. The システム shall すべてのAPIエンドポイントをOpenAPI仕様書に文書化する

### Requirement 15: レスポンシブデザイン

**Objective:** As a ユーザー, I want さまざまなデバイスでプロジェクト機能を使用する, so that 場所を選ばず業務を遂行できる

#### Acceptance Criteria

1. The システム shall プロジェクト一覧画面をデスクトップ、タブレット、モバイルに対応する
2. The システム shall プロジェクト詳細画面をデスクトップ、タブレット、モバイルに対応する
3. While モバイル表示時, the システム shall テーブルをカード形式に切り替えて表示する
4. The システム shall タッチ操作に最適化されたUIを提供する
5. The システム shall 320px〜1920pxの画面幅に対応する

### Requirement 16: 取引先オートコンプリート連携

**Objective:** As a ユーザー, I want 顧客名入力時に取引先候補が自動表示される, so that 既存の取引先を素早く正確に選択できる

#### Acceptance Criteria

1. When ユーザーが顧客名フィールドに1文字以上入力する, the システム shall 取引先管理機能から該当する取引先候補を検索する
2. The システム shall 入力文字列に前方一致または部分一致する取引先をオートコンプリート候補として表示する
3. While 取引先候補を検索中, the システム shall ローディングインジケータを表示する
4. If 該当する取引先候補が存在しない場合, then the システム shall 「該当する取引先がありません」というメッセージを表示する
5. The システム shall オートコンプリート候補を最大10件まで表示する
6. When ユーザーがキーボードの上下キーで候補を選択してEnterキーを押す, the システム shall 選択された取引先名を顧客名フィールドに設定する
7. When ユーザーがマウスで候補をクリックする, the システム shall 選択された取引先名を顧客名フィールドに設定する
8. When ユーザーがオートコンプリート候補以外の場所をクリックする, the システム shall オートコンプリート候補リストを閉じる
9. The システム shall ユーザーが取引先候補を選択せずに任意の顧客名を直接入力することを許可する
10. The システム shall オートコンプリートAPIのレスポンス時間を500ミリ秒以内とする

### Requirement 17: 担当者ユーザー選択

**Objective:** As a ユーザー, I want 営業担当者・工事担当者を選択できる, so that プロジェクトに適切な担当者を割り当てられる

#### Acceptance Criteria

1. The システム shall 営業担当者フィールドにドロップダウン選択UIを提供する
2. The システム shall 工事担当者フィールドにドロップダウン選択UIを提供する
3. When ユーザーが営業担当者ドロップダウンを開く, the システム shall admin以外の有効なユーザー一覧を候補として表示する
4. When ユーザーが工事担当者ドロップダウンを開く, the システム shall admin以外の有効なユーザー一覧を候補として表示する
5. The システム shall 各ユーザー候補にユーザーの表示名を表示する
6. The システム shall 営業担当者フィールドのデフォルト選択値としてログインユーザーを設定する
7. The システム shall 工事担当者フィールドのデフォルト選択値としてログインユーザーを設定する
8. When ユーザーがドロップダウンから担当者を選択する, the システム shall 選択されたユーザーIDをフォームに設定する
9. The システム shall 担当者選択APIのレスポンス時間を500ミリ秒以内とする
10. While 担当者候補を取得中, the システム shall ローディングインジケータを表示する
11. If 有効なユーザーが存在しない場合, then the システム shall 「選択可能なユーザーがありません」というメッセージを表示する
12. The システム shall `GET /api/users/assignable` エンドポイントでadmin以外の有効なユーザー一覧を取得できるようにする

### Requirement 18: エラー回復とフィードバック

**Objective:** As a ユーザー, I want エラー発生時に適切なフィードバックと回復手段を得る, so that 操作を中断せずに業務を継続できる

#### Acceptance Criteria

1. If ネットワークエラーが発生した場合, then the システム shall 「通信エラーが発生しました。再試行してください。」というエラーメッセージと再試行ボタンを表示する
2. When ユーザーが再試行ボタンをクリックする, the システム shall 失敗したリクエストを再実行する
3. If サーバーエラー（5xx）が発生した場合, then the システム shall 「システムエラーが発生しました。しばらくしてからお試しください。」というエラーメッセージを表示する
4. The システム shall 操作成功時に既存のToastNotificationコンポーネントを使用して成功メッセージを表示する
5. The システム shall 操作失敗時に既存のToastNotificationコンポーネントを使用してエラーメッセージを表示する
6. If セッションが期限切れの場合, then the システム shall ログインページにリダイレクトし、「セッションが期限切れになりました。再度ログインしてください。」というメッセージを表示する

### Requirement 19: パフォーマンス

**Objective:** As a ユーザー, I want 画面が素早く表示される, so that ストレスなく業務を遂行できる

#### Acceptance Criteria

1. The システム shall プロジェクト一覧画面の初期表示を2秒以内に完了する
2. The システム shall プロジェクト詳細画面の初期表示を1秒以内に完了する
3. The システム shall プロジェクト作成・更新・削除操作のAPI応答を500ミリ秒以内に完了する
4. The システム shall 検索・フィルタリング操作の結果表示を1秒以内に完了する
5. The システム shall 大量データ（1000件以上）でもページネーションにより一覧表示のパフォーマンスを維持する

### Requirement 20: アクセシビリティ

**Objective:** As a ユーザー, I want キーボードやスクリーンリーダーでプロジェクト機能を操作できる, so that 多様な操作方法で業務を遂行できる

#### Acceptance Criteria

1. The システム shall すべての操作をキーボードのみで実行可能にする
2. The システム shall フォーム要素にaria-label属性を適切に設定する
3. The システム shall エラーメッセージをaria-live属性でスクリーンリーダーに通知する
4. The システム shall フォーカス状態を視覚的に明確に表示する
5. The システム shall WCAG 2.1 Level AA準拠のコントラスト比を維持する
6. The システム shall テーブルヘッダーとデータセルの関連付けを適切に行う
