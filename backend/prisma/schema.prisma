// Prisma Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===== User Authentication Data Models =====

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  displayName          String
  passwordHash         String
  twoFactorEnabled     Boolean   @default(false)
  twoFactorSecret      String? // AES-256-GCM暗号化済み（Base32エンコードされたTOTP秘密鍵）
  isLocked             Boolean   @default(false)
  lockedUntil          DateTime?
  loginFailures        Int       @default(0)
  twoFactorFailures    Int       @default(0)
  twoFactorLockedUntil DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  userRoles             UserRole[]
  refreshTokens         RefreshToken[]
  invitationsSent       Invitation[]          @relation("InviterToInvitations")
  invitation            Invitation?           @relation("InvitationToUser")
  passwordResetRequests PasswordResetToken[]
  passwordHistories     PasswordHistory[]
  twoFactorBackupCodes  TwoFactorBackupCode[]
  auditLogsAsActor      AuditLog[]            @relation("ActorAuditLogs")

  // Project Management リレーション
  salesPersonProjects        Project[]              @relation("SalesPersonProjects")
  constructionPersonProjects Project[]              @relation("ConstructionPersonProjects")
  createdProjects            Project[]              @relation("CreatedProjects")
  statusChangedHistories     ProjectStatusHistory[] @relation("StatusChangedByUser")

  @@index([email])
  @@index([isLocked])
  @@map("users")
}

model Invitation {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  inviterId String
  status    String    @default("pending") // pending, used, expired, revoked
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  userId    String?   @unique

  inviter User  @relation("InviterToInvitations", fields: [inviterId], references: [id])
  user    User? @relation("InvitationToUser", fields: [userId], references: [id])

  @@index([token])
  @@index([email])
  @@index([status])
  @@index([expiresAt])
  @@map("invitations")
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  token      String   @unique
  deviceInfo String? // User-Agent情報（オプション）
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  priority    Int      @default(0) // 高い値が高優先度
  isSystem    Boolean  @default(false) // システムロール（削除不可）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@index([name])
  @@index([priority])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String // adr, user, role, permission, project, report, settings
  action      String // create, read, update, delete, manage, approve, reject, delegate, export
  description String
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([action])
  @@map("permissions")
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  assignedAt   DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model PasswordHistory {
  id           String   @id @default(uuid())
  userId       String
  passwordHash String // Argon2idハッシュ
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("password_histories")
}

model TwoFactorBackupCode {
  id        String    @id @default(uuid())
  userId    String
  codeHash  String // Argon2idハッシュ（8文字の英数字コード）
  usedAt    DateTime? // 使用済み追跡（1回限り使用）
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([usedAt])
  @@map("two_factor_backup_codes")
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String // ROLE_CREATED, ROLE_UPDATED, ROLE_DELETED, PERMISSION_ASSIGNED, PERMISSION_REVOKED, USER_ROLE_ASSIGNED, USER_ROLE_REVOKED, PERMISSION_CHECK_FAILED, TWO_FACTOR_ENABLED, TWO_FACTOR_DISABLED
  actorId    String
  targetType String // User, Role, Permission, UserRole, RolePermission
  targetId   String
  before     Json? // 変更前の値（JSON形式）
  after      Json? // 変更後の値（JSON形式）
  metadata   Json? // IPアドレス、ユーザーエージェント、リクエストID
  createdAt  DateTime @default(now())

  actor User @relation("ActorAuditLogs", fields: [actorId], references: [id], onDelete: Cascade)
  // Note: targetIdは多態的なフィールドで、targetTypeに応じてUser/Role/Permission等を参照
  // 外部キー制約は設けず、アプリケーションレベルで整合性を管理

  @@index([actorId])
  @@index([targetId])
  @@index([targetType, targetId])
  @@index([actorId, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

// ===== Project Management Data Models =====

/**
 * プロジェクトステータス
 * ワークフロー順: 準備中 → 調査中 → 見積中 → 決裁待ち → 契約中 → 工事中 → 引渡中 → 請求中 → 入金待ち → 完了
 * 終端ステータス: 完了、中止、失注
 * Requirements: 10.1
 */
enum ProjectStatus {
  PREPARING // 準備中
  SURVEYING // 調査中
  ESTIMATING // 見積中
  APPROVING // 決裁待ち
  CONTRACTING // 契約中
  CONSTRUCTING // 工事中
  DELIVERING // 引渡中
  BILLING // 請求中
  AWAITING // 入金待ち
  COMPLETED // 完了
  CANCELLED // 中止
  LOST // 失注
}

/**
 * ステータス遷移種別
 * Requirements: 10.11
 */
enum TransitionType {
  initial // 初期遷移（プロジェクト作成時、fromStatusなし）
  forward // 順方向遷移（ワークフロー進行）
  backward // 差し戻し遷移（1つ前のステータスへ戻る）
  terminate // 終端遷移（完了・中止・失注）
}

/**
 * プロジェクトモデル
 * プロジェクトは工事案件が発生した際に最初に作成されるエンティティ。
 * 当該工事における現場調査や見積などの業務は、プロジェクト配下にぶら下がる形で管理される。
 * Requirements: 1.14, 1.15, 9.7, 13.1, 13.2, 13.3, 13.5, 13.7, 13.8
 */
model Project {
  id                   String        @id @default(uuid())
  name                 String // プロジェクト名（必須、1-255文字）
  tradingPartnerId     String? // 取引先ID（任意、外部キー）
  salesPersonId        String // 営業担当者ID（必須）
  constructionPersonId String? // 工事担当者ID（任意）
  siteAddress          String? // 現場住所（任意、最大500文字）
  description          String? // 概要（任意、最大5000文字）
  status               ProjectStatus @default(PREPARING)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  deletedAt            DateTime? // 論理削除フィールド
  createdById          String // 作成者ID

  // リレーション
  tradingPartner     TradingPartner?        @relation(fields: [tradingPartnerId], references: [id])
  salesPerson        User                   @relation("SalesPersonProjects", fields: [salesPersonId], references: [id])
  constructionPerson User?                  @relation("ConstructionPersonProjects", fields: [constructionPersonId], references: [id])
  createdBy          User                   @relation("CreatedProjects", fields: [createdById], references: [id])
  statusHistory      ProjectStatusHistory[]
  siteSurveys        SiteSurvey[] // 現場調査リレーション

  // 検索・フィルタリング・ソート用インデックス
  @@index([name])
  @@index([tradingPartnerId])
  @@index([status])
  @@index([salesPersonId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([deletedAt])
  @@map("projects")
}

/**
 * プロジェクトステータス変更履歴
 * ステータス変更の履歴を記録し、遷移種別と差し戻し理由を含む
 * フィールド:
 * - id: 履歴レコードの一意ID（UUID）
 * - projectId: 対象プロジェクトID（外部キー、カスケード削除）
 * - fromStatus: 変更前のステータス（nullable: 初期遷移時はnull）
 * - toStatus: 変更後のステータス（必須）
 * - transitionType: 遷移種別（initial/forward/backward/terminate）
 * - reason: 差し戻し理由（backward遷移時は必須、他は任意）
 * - changedById: 変更実行者ID（外部キー）
 * - changedAt: 変更日時（自動設定）
 * インデックス:
 * - projectId: プロジェクト単位での履歴検索用
 * - changedAt: タイムライン検索用
 * - transitionType: 遷移種別によるフィルタリング用
 * Requirements: 10.10, 10.11, 10.15
 */
model ProjectStatusHistory {
  id             String         @id @default(uuid())
  projectId      String
  fromStatus     ProjectStatus? // nullable: initial遷移時はnull
  toStatus       ProjectStatus
  transitionType TransitionType
  reason         String? // 差し戻し理由（backward遷移時は必須）
  changedById    String
  changedAt      DateTime       @default(now())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  changedBy User    @relation("StatusChangedByUser", fields: [changedById], references: [id])

  @@index([projectId])
  @@index([changedAt])
  @@index([transitionType])
  @@map("project_status_histories")
}

// ===== Trading Partner Management Data Models =====

/**
 * 取引先種別
 * Requirements: 6.1, 6.2, 6.3
 */
enum TradingPartnerType {
  CUSTOMER // 顧客
  SUBCONTRACTOR // 協力業者
}

/**
 * 取引先モデル
 * 取引先（顧客および協力業者）の情報を一元管理する。
 * フィールド:
 * - id: 取引先の一意ID（UUID）
 * - name: 取引先名（必須、最大200文字）
 * - nameKana: フリガナ（必須、最大200文字、カタカナのみ）
 * - branchName: 部課/支店/支社名（任意、最大100文字）
 * - representativeName: 代表者名（任意、最大100文字）
 * - address: 住所（必須、最大500文字）
 * - phoneNumber: 電話番号（任意）
 * - faxNumber: FAX番号（任意）
 * - email: メールアドレス（任意）
 * - billingClosingDay: 請求締日（1-31 or 99=末日）
 * - paymentMonthOffset: 支払月オフセット（1=翌月, 2=翌々月, 3=3ヶ月後）
 * - paymentDay: 支払日（1-31 or 99=末日）
 * - notes: 備考（最大2000文字）
 * - createdAt: 作成日時
 * - updatedAt: 更新日時（楽観的排他制御用）
 * - deletedAt: 論理削除日時
 * Requirements: 11.1, 11.2, 11.3, 11.5, 11.10, 11.11, 11.12, 11.13, 11.14
 */
model TradingPartner {
  id                 String    @id @default(uuid())
  name               String // 取引先名（必須、最大200文字）
  nameKana           String // フリガナ（必須、最大200文字、カタカナのみ）
  branchName         String? // 部課/支店/支社名（任意、最大100文字）
  representativeName String? // 代表者名（任意、最大100文字）
  address            String // 住所（必須、最大500文字）
  phoneNumber        String? // 電話番号（任意）
  faxNumber          String? // FAX番号（任意）
  email              String? // メールアドレス（任意）
  billingClosingDay  Int? // 請求締日（1-31 or 99=末日）
  paymentMonthOffset Int? // 支払月オフセット（1=翌月, 2=翌々月, 3=3ヶ月後）
  paymentDay         Int? // 支払日（1-31 or 99=末日）
  notes              String? // 備考（最大2000文字）
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime? // 論理削除

  // リレーション
  types    TradingPartnerTypeMapping[]
  projects Project[] // この取引先に紐付くプロジェクト

  // インデックス
  // Requirements: 2.11, 4.8 - 同一の取引先名+支店名の重複を防ぐ複合一意制約
  @@unique([name, branchName, deletedAt], name: "name_branchName_deletedAt")
  @@index([nameKana])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("trading_partners")
}

/**
 * 取引先種別マッピング（多対多の代替としてのジョイントテーブル）
 * 1つの取引先は「顧客」「協力業者」またはその両方を持つことができる。
 * Requirements: 6.1, 6.2, 6.3
 */
model TradingPartnerTypeMapping {
  id               String             @id @default(uuid())
  tradingPartnerId String
  type             TradingPartnerType

  tradingPartner TradingPartner @relation(fields: [tradingPartnerId], references: [id], onDelete: Cascade)

  @@unique([tradingPartnerId, type], name: "tradingPartnerId_type")
  @@index([tradingPartnerId])
  @@index([type])
  @@map("trading_partner_type_mappings")
}

// ===== Site Survey Management Data Models =====

/**
 * 現場調査モデル
 * プロジェクトに紐付く現場調査データを管理する。
 * 現場調査時に撮影した写真や図面に対して、寸法・マーキング・コメント等の注釈を追加し、
 * 工事計画の基礎資料として活用する。
 * フィールド:
 * - id: 現場調査の一意ID（UUID）
 * - projectId: 対象プロジェクトID（外部キー、カスケード削除）
 * - name: 現場調査名（必須、最大200文字）
 * - surveyDate: 調査日（必須）
 * - memo: メモ（任意、最大2000文字）
 * - createdAt: 作成日時
 * - updatedAt: 更新日時（楽観的排他制御用）
 * - deletedAt: 論理削除日時
 * インデックス:
 * - projectId: プロジェクト単位での現場調査検索用
 * - surveyDate: 調査日による検索用
 * - deletedAt: 論理削除フィルタリング用
 * - name: 現場調査名による検索用
 * Requirements:
 * - 1.1: プロジェクトに紐付く新規現場調査レコードを作成する
 * - 1.4: 現場調査と関連する画像データを論理削除する
 * - 1.6: プロジェクトが存在しない場合、現場調査の作成を許可しない
 */
model SiteSurvey {
  id         String    @id @default(uuid())
  projectId  String
  name       String // 現場調査名（必須、最大200文字）
  surveyDate DateTime  @db.Date // 調査日
  memo       String? // メモ（最大2000文字）
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime? // 論理削除

  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  images  SurveyImage[]

  @@index([projectId])
  @@index([surveyDate])
  @@index([deletedAt])
  @@index([name])
  @@map("site_surveys")
}

/**
 * 現場調査画像モデル
 * 現場調査に紐付く画像ファイルの情報を管理する。
 * 原画像とサムネイルはCloudflare R2に保存され、パスのみをデータベースに格納。
 * フィールド:
 * - id: 画像の一意ID（UUID）
 * - surveyId: 現場調査ID（外部キー、カスケード削除）
 * - originalPath: R2オブジェクトパス（原画像）
 * - thumbnailPath: R2オブジェクトパス（サムネイル）
 * - fileName: 元ファイル名
 * - fileSize: ファイルサイズ（バイト）
 * - width: 画像幅
 * - height: 画像高さ
 * - displayOrder: 表示順序
 * - comment: 写真コメント（最大2000文字）
 * - includeInReport: 報告書出力フラグ
 * - createdAt: 作成日時
 * インデックス:
 * - surveyId: 現場調査単位での画像検索用
 * - displayOrder: 表示順序によるソート用
 * - includeInReport: 報告書出力対象画像のフィルタリング用
 * Requirements:
 * - 4.1: 画像をストレージに保存し現場調査に紐付ける
 * - 4.4: サムネイルを自動生成する
 * - 4.9: 画像一覧を固定の表示順序で表示する
 * - 10.4: 写真コメント（最大2000文字）
 * - 10.8: 報告書出力対象画像の選択
 */
model SurveyImage {
  id              String   @id @default(uuid())
  surveyId        String
  originalPath    String // R2オブジェクトパス
  thumbnailPath   String // サムネイルパス
  fileName        String // 元ファイル名
  fileSize        Int // ファイルサイズ（バイト）
  width           Int // 画像幅
  height          Int // 画像高さ
  displayOrder    Int // 表示順序
  comment         String? // 写真コメント（最大2000文字）
  includeInReport Boolean  @default(false) // 報告書出力フラグ
  createdAt       DateTime @default(now())

  survey     SiteSurvey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  annotation ImageAnnotation?

  @@index([surveyId])
  @@index([displayOrder])
  @@index([includeInReport])
  @@map("survey_images")
}

/**
 * 画像注釈モデル
 * 画像に対する注釈データ（寸法線、マーキング、コメント）をFabric.js JSON形式で保存。
 * 1つの画像につき1つの注釈データを持つ（1対1リレーション）。
 * フィールド:
 * - id: 注釈の一意ID（UUID）
 * - imageId: 画像ID（外部キー、@unique、カスケード削除）
 * - data: Fabric.js JSON形式の注釈データ
 * - version: スキーマバージョン（デフォルト: "1.0"）
 * - createdAt: 作成日時
 * - updatedAt: 更新日時
 * Requirements:
 * - 9.1: 全ての注釈データをデータベースに保存する
 * - 9.2: 保存された注釈データを復元して表示する
 */
model ImageAnnotation {
  id        String   @id @default(uuid())
  imageId   String   @unique
  data      Json // Fabric.js JSON形式
  version   String   @default("1.0") // スキーマバージョン
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  image SurveyImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@map("image_annotations")
}
