// Prisma Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===== User Authentication Data Models =====

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  displayName          String
  passwordHash         String
  twoFactorEnabled     Boolean   @default(false)
  twoFactorSecret      String? // AES-256-GCM暗号化済み（Base32エンコードされたTOTP秘密鍵）
  isLocked             Boolean   @default(false)
  lockedUntil          DateTime?
  loginFailures        Int       @default(0)
  twoFactorFailures    Int       @default(0)
  twoFactorLockedUntil DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  userRoles             UserRole[]
  refreshTokens         RefreshToken[]
  invitationsSent       Invitation[]          @relation("InviterToInvitations")
  invitation            Invitation?           @relation("InvitationToUser")
  passwordResetRequests PasswordResetToken[]
  passwordHistories     PasswordHistory[]
  twoFactorBackupCodes  TwoFactorBackupCode[]
  auditLogsAsActor      AuditLog[]            @relation("ActorAuditLogs")

  // Project Management リレーション
  salesPersonProjects        Project[]              @relation("SalesPersonProjects")
  constructionPersonProjects Project[]              @relation("ConstructionPersonProjects")
  createdProjects            Project[]              @relation("CreatedProjects")
  statusChangedHistories     ProjectStatusHistory[] @relation("StatusChangedByUser")

  // Estimate Request Management リレーション
  estimateRequestStatusChanges EstimateRequestStatusHistory[] @relation("EstimateRequestStatusChangedByUser")

  @@index([email])
  @@index([isLocked])
  @@map("users")
}

model Invitation {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  inviterId String
  status    String    @default("pending") // pending, used, expired, revoked
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  userId    String?   @unique

  inviter User  @relation("InviterToInvitations", fields: [inviterId], references: [id])
  user    User? @relation("InvitationToUser", fields: [userId], references: [id])

  @@index([token])
  @@index([email])
  @@index([status])
  @@index([expiresAt])
  @@map("invitations")
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  token      String   @unique
  deviceInfo String? // User-Agent情報（オプション）
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  priority    Int      @default(0) // 高い値が高優先度
  isSystem    Boolean  @default(false) // システムロール（削除不可）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@index([name])
  @@index([priority])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String // adr, user, role, permission, project, report, settings
  action      String // create, read, update, delete, manage, approve, reject, delegate, export
  description String
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([action])
  @@map("permissions")
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  assignedAt   DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model PasswordHistory {
  id           String   @id @default(uuid())
  userId       String
  passwordHash String // Argon2idハッシュ
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("password_histories")
}

model TwoFactorBackupCode {
  id        String    @id @default(uuid())
  userId    String
  codeHash  String // Argon2idハッシュ（8文字の英数字コード）
  usedAt    DateTime? // 使用済み追跡（1回限り使用）
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([usedAt])
  @@map("two_factor_backup_codes")
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String // ROLE_CREATED, ROLE_UPDATED, ROLE_DELETED, PERMISSION_ASSIGNED, PERMISSION_REVOKED, USER_ROLE_ASSIGNED, USER_ROLE_REVOKED, PERMISSION_CHECK_FAILED, TWO_FACTOR_ENABLED, TWO_FACTOR_DISABLED
  actorId    String
  targetType String // User, Role, Permission, UserRole, RolePermission
  targetId   String
  before     Json? // 変更前の値（JSON形式）
  after      Json? // 変更後の値（JSON形式）
  metadata   Json? // IPアドレス、ユーザーエージェント、リクエストID
  createdAt  DateTime @default(now())

  actor User @relation("ActorAuditLogs", fields: [actorId], references: [id], onDelete: Cascade)
  // Note: targetIdは多態的なフィールドで、targetTypeに応じてUser/Role/Permission等を参照
  // 外部キー制約は設けず、アプリケーションレベルで整合性を管理

  @@index([actorId])
  @@index([targetId])
  @@index([targetType, targetId])
  @@index([actorId, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

// ===== Project Management Data Models =====

/**
 * プロジェクトステータス
 * ワークフロー順: 準備中 → 調査中 → 見積中 → 決裁待ち → 契約中 → 工事中 → 引渡中 → 請求中 → 入金待ち → 完了
 * 終端ステータス: 完了、中止、失注
 * Requirements: 10.1
 */
enum ProjectStatus {
  PREPARING // 準備中
  SURVEYING // 調査中
  ESTIMATING // 見積中
  APPROVING // 決裁待ち
  CONTRACTING // 契約中
  CONSTRUCTING // 工事中
  DELIVERING // 引渡中
  BILLING // 請求中
  AWAITING // 入金待ち
  COMPLETED // 完了
  CANCELLED // 中止
  LOST // 失注
}

/**
 * ステータス遷移種別
 * Requirements: 10.11
 */
enum TransitionType {
  initial // 初期遷移（プロジェクト作成時、fromStatusなし）
  forward // 順方向遷移（ワークフロー進行）
  backward // 差し戻し遷移（1つ前のステータスへ戻る）
  terminate // 終端遷移（完了・中止・失注）
}

/**
 * プロジェクトモデル
 * プロジェクトは工事案件が発生した際に最初に作成されるエンティティ。
 * 当該工事における現場調査や見積などの業務は、プロジェクト配下にぶら下がる形で管理される。
 * Requirements: 1.14, 1.15, 9.7, 13.1, 13.2, 13.3, 13.5, 13.7, 13.8
 */
model Project {
  id                   String        @id @default(uuid())
  name                 String // プロジェクト名（必須、1-255文字）
  tradingPartnerId     String? // 取引先ID（任意、外部キー）
  salesPersonId        String // 営業担当者ID（必須）
  constructionPersonId String? // 工事担当者ID（任意）
  siteAddress          String? // 現場住所（任意、最大500文字）
  description          String? // 概要（任意、最大5000文字）
  status               ProjectStatus @default(PREPARING)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  deletedAt            DateTime? // 論理削除フィールド
  createdById          String // 作成者ID

  // リレーション
  tradingPartner     TradingPartner?        @relation(fields: [tradingPartnerId], references: [id])
  salesPerson        User                   @relation("SalesPersonProjects", fields: [salesPersonId], references: [id])
  constructionPerson User?                  @relation("ConstructionPersonProjects", fields: [constructionPersonId], references: [id])
  createdBy          User                   @relation("CreatedProjects", fields: [createdById], references: [id])
  statusHistory      ProjectStatusHistory[]
  siteSurveys        SiteSurvey[] // 現場調査リレーション
  quantityTables     QuantityTable[] // 数量表リレーション
  itemizedStatements ItemizedStatement[] // 内訳書リレーション
  estimateRequests   EstimateRequest[] // 見積依頼リレーション

  // 検索・フィルタリング・ソート用インデックス
  @@index([name])
  @@index([tradingPartnerId])
  @@index([status])
  @@index([salesPersonId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([deletedAt])
  @@map("projects")
}

/**
 * プロジェクトステータス変更履歴
 * ステータス変更の履歴を記録し、遷移種別と差し戻し理由を含む
 * フィールド:
 * - id: 履歴レコードの一意ID（UUID）
 * - projectId: 対象プロジェクトID（外部キー、カスケード削除）
 * - fromStatus: 変更前のステータス（nullable: 初期遷移時はnull）
 * - toStatus: 変更後のステータス（必須）
 * - transitionType: 遷移種別（initial/forward/backward/terminate）
 * - reason: 差し戻し理由（backward遷移時は必須、他は任意）
 * - changedById: 変更実行者ID（外部キー）
 * - changedAt: 変更日時（自動設定）
 * インデックス:
 * - projectId: プロジェクト単位での履歴検索用
 * - changedAt: タイムライン検索用
 * - transitionType: 遷移種別によるフィルタリング用
 * Requirements: 10.10, 10.11, 10.15
 */
model ProjectStatusHistory {
  id             String         @id @default(uuid())
  projectId      String
  fromStatus     ProjectStatus? // nullable: initial遷移時はnull
  toStatus       ProjectStatus
  transitionType TransitionType
  reason         String? // 差し戻し理由（backward遷移時は必須）
  changedById    String
  changedAt      DateTime       @default(now())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  changedBy User    @relation("StatusChangedByUser", fields: [changedById], references: [id])

  @@index([projectId])
  @@index([changedAt])
  @@index([transitionType])
  @@map("project_status_histories")
}

// ===== Trading Partner Management Data Models =====

/**
 * 取引先種別
 * Requirements: 6.1, 6.2, 6.3
 */
enum TradingPartnerType {
  CUSTOMER // 顧客
  SUBCONTRACTOR // 協力業者
}

/**
 * 取引先モデル
 * 取引先（顧客および協力業者）の情報を一元管理する。
 * フィールド:
 * - id: 取引先の一意ID（UUID）
 * - name: 取引先名（必須、最大200文字）
 * - nameKana: フリガナ（必須、最大200文字、カタカナのみ）
 * - branchName: 部課/支店/支社名（任意、最大100文字）
 * - representativeName: 代表者名（任意、最大100文字）
 * - address: 住所（必須、最大500文字）
 * - phoneNumber: 電話番号（任意）
 * - faxNumber: FAX番号（任意）
 * - email: メールアドレス（任意）
 * - billingClosingDay: 請求締日（1-31 or 99=末日）
 * - paymentMonthOffset: 支払月オフセット（1=翌月, 2=翌々月, 3=3ヶ月後）
 * - paymentDay: 支払日（1-31 or 99=末日）
 * - notes: 備考（最大2000文字）
 * - createdAt: 作成日時
 * - updatedAt: 更新日時（楽観的排他制御用）
 * - deletedAt: 論理削除日時
 * Requirements: 11.1, 11.2, 11.3, 11.5, 11.10, 11.11, 11.12, 11.13, 11.14
 */
model TradingPartner {
  id                 String    @id @default(uuid())
  name               String // 取引先名（必須、最大200文字）
  nameKana           String // フリガナ（必須、最大200文字、カタカナのみ）
  branchName         String? // 部課/支店/支社名（任意、最大100文字）
  representativeName String? // 代表者名（任意、最大100文字）
  address            String // 住所（必須、最大500文字）
  phoneNumber        String? // 電話番号（任意）
  faxNumber          String? // FAX番号（任意）
  email              String? // メールアドレス（任意）
  billingClosingDay  Int? // 請求締日（1-31 or 99=末日）
  paymentMonthOffset Int? // 支払月オフセット（1=翌月, 2=翌々月, 3=3ヶ月後）
  paymentDay         Int? // 支払日（1-31 or 99=末日）
  notes              String? // 備考（最大2000文字）
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime? // 論理削除

  // リレーション
  types            TradingPartnerTypeMapping[]
  projects         Project[] // この取引先に紐付くプロジェクト
  estimateRequests EstimateRequest[] // この取引先宛の見積依頼

  // インデックス
  // Requirements: 2.11, 4.8 - 同一の取引先名+支店名の重複を防ぐ複合一意制約
  @@unique([name, branchName, deletedAt], name: "name_branchName_deletedAt")
  @@index([nameKana])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("trading_partners")
}

/**
 * 取引先種別マッピング（多対多の代替としてのジョイントテーブル）
 * 1つの取引先は「顧客」「協力業者」またはその両方を持つことができる。
 * Requirements: 6.1, 6.2, 6.3
 */
model TradingPartnerTypeMapping {
  id               String             @id @default(uuid())
  tradingPartnerId String
  type             TradingPartnerType

  tradingPartner TradingPartner @relation(fields: [tradingPartnerId], references: [id], onDelete: Cascade)

  @@unique([tradingPartnerId, type], name: "tradingPartnerId_type")
  @@index([tradingPartnerId])
  @@index([type])
  @@map("trading_partner_type_mappings")
}

// ===== Site Survey Management Data Models =====

/**
 * 現場調査モデル
 * プロジェクトに紐付く現場調査データを管理する。
 * 現場調査時に撮影した写真や図面に対して、寸法・マーキング・コメント等の注釈を追加し、
 * 工事計画の基礎資料として活用する。
 * フィールド:
 * - id: 現場調査の一意ID（UUID）
 * - projectId: 対象プロジェクトID（外部キー、カスケード削除）
 * - name: 現場調査名（必須、最大200文字）
 * - surveyDate: 調査日（必須）
 * - memo: メモ（任意、最大2000文字）
 * - createdAt: 作成日時
 * - updatedAt: 更新日時（楽観的排他制御用）
 * - deletedAt: 論理削除日時
 * インデックス:
 * - projectId: プロジェクト単位での現場調査検索用
 * - surveyDate: 調査日による検索用
 * - deletedAt: 論理削除フィルタリング用
 * - name: 現場調査名による検索用
 * Requirements:
 * - 1.1: プロジェクトに紐付く新規現場調査レコードを作成する
 * - 1.4: 現場調査と関連する画像データを論理削除する
 * - 1.6: プロジェクトが存在しない場合、現場調査の作成を許可しない
 */
model SiteSurvey {
  id         String    @id @default(uuid())
  projectId  String
  name       String // 現場調査名（必須、最大200文字）
  surveyDate DateTime  @db.Date // 調査日
  memo       String? // メモ（最大2000文字）
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime? // 論理削除

  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  images  SurveyImage[]

  @@index([projectId])
  @@index([surveyDate])
  @@index([deletedAt])
  @@index([name])
  @@map("site_surveys")
}

/**
 * 現場調査画像モデル
 * 現場調査に紐付く画像ファイルの情報を管理する。
 * 原画像とサムネイルはCloudflare R2に保存され、パスのみをデータベースに格納。
 * フィールド:
 * - id: 画像の一意ID（UUID）
 * - surveyId: 現場調査ID（外部キー、カスケード削除）
 * - originalPath: R2オブジェクトパス（原画像）
 * - thumbnailPath: R2オブジェクトパス（サムネイル）
 * - fileName: 元ファイル名
 * - fileSize: ファイルサイズ（バイト）
 * - width: 画像幅
 * - height: 画像高さ
 * - displayOrder: 表示順序
 * - comment: 写真コメント（最大2000文字）
 * - includeInReport: 報告書出力フラグ
 * - createdAt: 作成日時
 * インデックス:
 * - surveyId: 現場調査単位での画像検索用
 * - displayOrder: 表示順序によるソート用
 * - includeInReport: 報告書出力対象画像のフィルタリング用
 * Requirements:
 * - 4.1: 画像をストレージに保存し現場調査に紐付ける
 * - 4.4: サムネイルを自動生成する
 * - 4.9: 画像一覧を固定の表示順序で表示する
 * - 10.4: 写真コメント（最大2000文字）
 * - 10.8: 報告書出力対象画像の選択
 */
model SurveyImage {
  id              String   @id @default(uuid())
  surveyId        String
  originalPath    String // R2オブジェクトパス
  thumbnailPath   String // サムネイルパス
  fileName        String // 元ファイル名
  fileSize        Int // ファイルサイズ（バイト）
  width           Int // 画像幅
  height          Int // 画像高さ
  displayOrder    Int // 表示順序
  comment         String? // 写真コメント（最大2000文字）
  includeInReport Boolean  @default(false) // 報告書出力フラグ
  createdAt       DateTime @default(now())

  survey         SiteSurvey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  annotation     ImageAnnotation?
  quantityGroups QuantityGroup[] // 数量グループリレーション

  @@index([surveyId])
  @@index([displayOrder])
  @@index([includeInReport])
  @@map("survey_images")
}

/**
 * 画像注釈モデル
 * 画像に対する注釈データ（寸法線、マーキング、コメント）をFabric.js JSON形式で保存。
 * 1つの画像につき1つの注釈データを持つ（1対1リレーション）。
 * フィールド:
 * - id: 注釈の一意ID（UUID）
 * - imageId: 画像ID（外部キー、@unique、カスケード削除）
 * - data: Fabric.js JSON形式の注釈データ
 * - version: スキーマバージョン（デフォルト: "1.0"）
 * - createdAt: 作成日時
 * - updatedAt: 更新日時
 * Requirements:
 * - 9.1: 全ての注釈データをデータベースに保存する
 * - 9.2: 保存された注釈データを復元して表示する
 */
model ImageAnnotation {
  id        String   @id @default(uuid())
  imageId   String   @unique
  data      Json // Fabric.js JSON形式
  version   String   @default("1.0") // スキーマバージョン
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  image SurveyImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@map("image_annotations")
}

// ===== Quantity Table Management Data Models =====

/**
 * 計算方法
 * Requirements: 8.1, 8.5, 8.8
 */
enum CalculationMethod {
  STANDARD // 標準（直接入力）
  AREA_VOLUME // 面積・体積
  PITCH // ピッチ
}

/**
 * 数量表モデル
 * プロジェクトに紐付く数量表を管理する。
 * 1つのプロジェクトに対して複数の数量表を作成でき、各数量表は複数の数量グループで構成される。
 * フィールド:
 * - id: 数量表の一意ID（UUID）
 * - projectId: 対象プロジェクトID（外部キー）
 * - name: 数量表名（必須、1-200文字）
 * - createdAt: 作成日時
 * - updatedAt: 更新日時（楽観的排他制御用）
 * - deletedAt: 論理削除日時
 * インデックス:
 * - projectId: プロジェクト単位での数量表検索用
 * - deletedAt: 論理削除フィルタリング用
 * Requirements:
 * - 2.1: 数量表一覧画面で新規作成操作を行う
 * - 2.2: 数量表名を入力して作成を確定する
 * - 2.3: プロジェクトに紐づく全ての数量表を作成日時順に一覧表示する
 * - 2.4: 数量表を選択して削除操作を行う
 * - 2.5: 数量表名を編集する
 */
model QuantityTable {
  id        String    @id @default(uuid())
  projectId String
  name      String // 数量表名（必須、1-200文字）
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // 論理削除

  project Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  groups  QuantityGroup[]

  @@index([projectId])
  @@index([deletedAt])
  @@map("quantity_tables")
}

/**
 * 数量グループモデル
 * 数量表に紐付く数量グループを管理する。
 * 各グループは現場調査画像と紐づけることができ、複数の数量項目を含む。
 * フィールド:
 * - id: 数量グループの一意ID（UUID）
 * - quantityTableId: 所属する数量表ID（外部キー、カスケード削除）
 * - surveyImageId: 紐付け現場調査画像ID（外部キー、任意）
 * - name: グループ名（任意、最大200文字）
 * - displayOrder: 表示順序
 * - createdAt: 作成日時
 * - updatedAt: 更新日時
 * インデックス:
 * - quantityTableId, displayOrder: 数量表単位でのグループ取得・並び順用
 * Requirements:
 * - 4.1: 数量表編集画面で数量グループ追加操作を行う
 * - 4.2: 数量グループが追加される場合、同一プロジェクトの注釈付き現場調査写真選択機能を提供する
 * - 4.3: 数量グループ内で写真選択操作を行う
 * - 4.4: 数量グループに写真が紐づけられている状態で、注釈付き写真と数量項目の関連性を視覚的に表示する
 * - 4.5: 数量グループの削除操作を行う
 */
model QuantityGroup {
  id              String  @id @default(uuid())
  quantityTableId String
  surveyImageId   String? // 紐付け現場調査画像ID
  name            String? // グループ名（任意、最大200文字）
  displayOrder    Int // 表示順序

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quantityTable QuantityTable  @relation(fields: [quantityTableId], references: [id], onDelete: Cascade)
  surveyImage   SurveyImage?   @relation(fields: [surveyImageId], references: [id], onDelete: SetNull)
  items         QuantityItem[]

  @@index([quantityTableId, displayOrder])
  @@map("quantity_groups")
}

/**
 * 数量項目モデル
 * 数量グループに紐付く数量項目を管理する。
 * 各項目は大項目・中項目・小項目・任意分類・工種・名称・規格・単位・計算方法・調整係数・丸め設定・数量・備考の属性を持つ。
 * フィールド:
 * - id: 数量項目の一意ID（UUID）
 * - quantityGroupId: 所属する数量グループID（外部キー、カスケード削除）
 * - majorCategory: 大項目（任意、最大100文字）
 * - middleCategory: 中項目（任意、最大100文字）
 * - minorCategory: 小項目（任意、最大100文字）
 * - customCategory: 任意分類（任意、最大100文字）
 * - workType: 工種（必須、最大100文字）
 * - name: 名称（必須、最大200文字）
 * - specification: 規格（任意、最大500文字）
 * - unit: 単位（必須、最大50文字）
 * - calculationMethod: 計算方法（STANDARD/AREA_VOLUME/PITCH）
 * - calculationParams: 計算用パラメータ（JSON）
 * - adjustmentFactor: 調整係数（デフォルト: 1.0000）
 * - roundingUnit: 丸め単位（デフォルト: 0.0100）
 * - quantity: 数量（必須）
 * - remarks: 備考（任意）
 * - displayOrder: 表示順序
 * - createdAt: 作成日時
 * - updatedAt: 更新日時
 * インデックス:
 * - quantityGroupId, displayOrder: 数量グループ単位での項目取得・並び順用
 * Requirements:
 * - 5.1: 数量グループ内で行追加操作を行う
 * - 5.2: 数量項目の各フィールドに値を入力する
 * - 5.3: 必須フィールド（工種・名称・単位・計算方法・調整係数・丸め設定・数量）が未入力で保存を試行する
 * - 5.4: 数量項目を選択して削除操作を行う
 */
model QuantityItem {
  id                String            @id @default(uuid())
  quantityGroupId   String
  majorCategory     String? // 大項目（任意、最大100文字）
  middleCategory    String? // 中項目（任意、最大100文字）
  minorCategory     String? // 小項目（任意、最大100文字）
  customCategory    String? // 任意分類（任意、最大100文字）
  workType          String // 工種（必須、最大100文字）
  name              String // 名称（必須、最大200文字）
  specification     String? // 規格（任意、最大500文字）
  unit              String // 単位（必須、最大50文字）
  calculationMethod CalculationMethod @default(STANDARD) // 計算方法
  calculationParams Json? // 計算用パラメータ（JSON）
  adjustmentFactor  Decimal           @default(1.0000) @db.Decimal(10, 4) // 調整係数
  roundingUnit      Decimal           @default(0.0100) @db.Decimal(10, 4) // 丸め単位
  quantity          Decimal           @db.Decimal(15, 4) // 数量
  remarks           String? // 備考
  displayOrder      Int // 表示順序

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quantityGroup QuantityGroup @relation(fields: [quantityGroupId], references: [id], onDelete: Cascade)

  @@index([quantityGroupId, displayOrder])
  @@map("quantity_items")
}

// ===== Itemized Statement Management Data Models =====

/**
 * 内訳書モデル
 * 数量表の項目を「任意分類」「工種」「名称」「規格」「単位」の5項目でピボット集計し、
 * 内訳書として保存・閲覧する。内訳書は作成時点のスナップショットとして独立して保持され、
 * 元の数量表が変更されても影響を受けない。
 * フィールド:
 * - id: 内訳書の一意ID（UUID）
 * - projectId: 対象プロジェクトID（外部キー、カスケード削除）
 * - name: 内訳書名（必須、最大200文字）
 * - sourceQuantityTableId: 集計元数量表ID（参照情報のみ、外部キー制約なし）
 * - sourceQuantityTableName: 集計元数量表名（スナップショット、最大200文字）
 * - createdAt: 作成日時
 * - updatedAt: 更新日時（楽観的排他制御用）
 * - deletedAt: 論理削除日時
 * インデックス:
 * - projectId: プロジェクト単位での内訳書検索用
 * - deletedAt: 論理削除フィルタリング用
 * - createdAt: 作成日時でのソート用
 * - 部分一意制約: 同一プロジェクト内での内訳書名重複を防ぐ（論理削除されていないレコードのみ）
 * Requirements:
 * - REQ-8.1: 内訳書作成時に集計時点の数量項目データを内訳書に保存する（スナップショット独立性）
 * - REQ-10.1: 内訳書はupdatedAtフィールドを持つ（楽観的排他制御用）
 */
model ItemizedStatement {
  id                      String    @id @default(uuid())
  projectId               String
  name                    String // 内訳書名（必須、最大200文字）
  sourceQuantityTableId   String // 集計元数量表ID（参照情報のみ）
  sourceQuantityTableName String // 集計元数量表名（スナップショット）
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  deletedAt               DateTime? // 論理削除

  project          Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items            ItemizedStatementItem[]
  estimateRequests EstimateRequest[]

  // インデックス
  @@index([projectId])
  @@index([deletedAt])
  @@index([createdAt])
  // 同一プロジェクト内での内訳書名重複を防ぐ部分一意制約（論理削除されていないレコードのみ）
  // PostgreSQLでは部分インデックスとしてマイグレーション時にSQLで追加
  @@map("itemized_statements")
}

/**
 * 内訳書項目モデル
 * 内訳書に紐付く集計済み項目を管理する。
 * ピボット集計の結果として生成され、「任意分類」「工種」「名称」「規格」「単位」の組み合わせをキーとして
 * グループ化された数量の合計値を保持する。
 * フィールド:
 * - id: 項目の一意ID（UUID）
 * - itemizedStatementId: 内訳書ID（外部キー、カスケード削除）
 * - customCategory: 任意分類（任意、最大100文字）
 * - workType: 工種（任意、最大100文字）
 * - name: 名称（任意、最大200文字）
 * - specification: 規格（任意、最大500文字）
 * - unit: 単位（任意、最大50文字）
 * - quantity: 数量（小数点以下2桁精度、必須）
 * - displayOrder: 表示順序
 * インデックス:
 * - itemizedStatementId: 内訳書単位での項目取得用
 * - displayOrder: 表示順序によるソート用
 * Requirements:
 * - REQ-2.4: 合計数量は小数点以下2桁の精度で計算する
 */
model ItemizedStatementItem {
  id                  String  @id @default(uuid())
  itemizedStatementId String
  customCategory      String? // 任意分類（任意、最大100文字）
  workType            String? // 工種（任意、最大100文字）
  name                String? // 名称（任意、最大200文字）
  specification       String? // 規格（任意、最大500文字）
  unit                String? // 単位（任意、最大50文字）
  quantity            Decimal @db.Decimal(10, 2) // 数量（小数点以下2桁精度）
  displayOrder        Int // 表示順序

  itemizedStatement    ItemizedStatement     @relation(fields: [itemizedStatementId], references: [id], onDelete: Cascade)
  estimateRequestItems EstimateRequestItem[]

  @@index([itemizedStatementId])
  @@index([itemizedStatementId, displayOrder])
  @@map("itemized_statement_items")
}

// ===== Estimate Request Management Data Models =====

/**
 * 見積依頼方法
 * Requirements: 4.8, 4.9 - 見積依頼方法としてメールまたはFAXを選択可能
 */
enum EstimateRequestMethod {
  EMAIL
  FAX
}

/**
 * 見積依頼ステータス
 * Requirements: 12.2 - 見積依頼のステータス（依頼前、依頼済、見積受領済）
 * ワークフロー: 依頼前 → 依頼済 → 見積受領済
 */
enum EstimateRequestStatus {
  BEFORE_REQUEST // 依頼前（初期値）
  REQUESTED // 依頼済
  QUOTATION_RECEIVED // 見積受領済
}

/**
 * 受領見積書コンテンツタイプ
 * Requirements: 11.7 - テキスト入力とファイルアップロードの排他的選択
 */
enum ReceivedQuotationContentType {
  TEXT // テキスト入力
  FILE // ファイルアップロード
}

/**
 * 見積依頼モデル
 * プロジェクトに紐付く協力業者への見積依頼を管理する。
 * ユーザーは内訳書の項目を選択し、メールまたはFAX送信に必要な情報を生成できる。
 * フィールド:
 * - id: 見積依頼の一意ID（UUID）
 * - projectId: 対象プロジェクトID（外部キー、カスケード削除）
 * - tradingPartnerId: 宛先取引先ID（外部キー、RESTRICT）
 * - itemizedStatementId: 参照内訳書ID（外部キー、RESTRICT）
 * - name: 見積依頼名（必須、最大200文字）
 * - method: 見積依頼方法（EMAIL/FAX）
 * - includeBreakdownInBody: 内訳書を本文に含める
 * - createdAt: 作成日時
 * - updatedAt: 更新日時（楽観的排他制御用）
 * - deletedAt: 論理削除日時
 * インデックス:
 * - projectId: プロジェクト単位での見積依頼検索用
 * - tradingPartnerId: 取引先単位での見積依頼検索用
 * - deletedAt: 論理削除フィルタリング用
 * - createdAt: 作成日時でのソート用
 * Requirements:
 * - 8.1: 見積依頼をプロジェクトに紐づけて保存する
 * - 8.3: 見積依頼の作成日時と更新日時を記録する
 * - 8.4: 見積依頼の削除時に論理削除を行う
 * - 8.5: 楽観的排他制御により同時更新を防止する
 */
/**
 * 見積依頼モデル
 * プロジェクトに紐付く協力業者への見積依頼を管理する。
 * ユーザーは内訳書の項目を選択し、メールまたはFAX送信に必要な情報を生成できる。
 * フィールド:
 * - id: 見積依頼の一意ID（UUID）
 * - projectId: 対象プロジェクトID（外部キー、カスケード削除）
 * - tradingPartnerId: 宛先取引先ID（外部キー、RESTRICT）
 * - itemizedStatementId: 参照内訳書ID（外部キー、RESTRICT）
 * - name: 見積依頼名（必須、最大200文字）
 * - method: 見積依頼方法（EMAIL/FAX）
 * - status: 見積依頼ステータス（BEFORE_REQUEST/REQUESTED/QUOTATION_RECEIVED）
 * - includeBreakdownInBody: 内訳書を本文に含める
 * - createdAt: 作成日時
 * - updatedAt: 更新日時（楽観的排他制御用）
 * - deletedAt: 論理削除日時
 * インデックス:
 * - projectId: プロジェクト単位での見積依頼検索用
 * - tradingPartnerId: 取引先単位での見積依頼検索用
 * - status: ステータスによるフィルタリング用
 * - deletedAt: 論理削除フィルタリング用
 * - createdAt: 作成日時でのソート用
 * Requirements:
 * - 8.1: 見積依頼をプロジェクトに紐づけて保存する
 * - 8.3: 見積依頼の作成日時と更新日時を記録する
 * - 8.4: 見積依頼の削除時に論理削除を行う
 * - 8.5: 楽観的排他制御により同時更新を防止する
 * - 12.1-12.12: 見積依頼ステータス管理機能
 */
model EstimateRequest {
  id                     String                @id @default(uuid())
  projectId              String
  tradingPartnerId       String
  itemizedStatementId    String
  name                   String // 見積依頼名（必須、最大200文字）
  method                 EstimateRequestMethod @default(EMAIL) // 見積依頼方法
  status                 EstimateRequestStatus @default(BEFORE_REQUEST) // 見積依頼ステータス（Requirements: 12.3）
  includeBreakdownInBody Boolean               @default(false) // 内訳書を本文に含める
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  deletedAt              DateTime? // 論理削除

  project            Project                        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tradingPartner     TradingPartner                 @relation(fields: [tradingPartnerId], references: [id])
  itemizedStatement  ItemizedStatement              @relation(fields: [itemizedStatementId], references: [id])
  selectedItems      EstimateRequestItem[]
  receivedQuotations ReceivedQuotation[] // Requirements: 11.11 - 複数の受領見積書
  statusHistory      EstimateRequestStatusHistory[] // Requirements: 12.11 - ステータス変更履歴

  @@index([projectId])
  @@index([tradingPartnerId])
  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("estimate_requests")
}

/**
 * 見積依頼項目モデル
 * 見積依頼で選択された内訳書項目の参照を保持する。
 * フィールド:
 * - id: 項目の一意ID（UUID）
 * - estimateRequestId: 見積依頼ID（外部キー、カスケード削除）
 * - itemizedStatementItemId: 内訳書項目ID（外部キー、RESTRICT）
 * - selected: 選択状態
 * ユニーク制約: estimateRequestId + itemizedStatementItemId
 * インデックス:
 * - estimateRequestId: 見積依頼単位での項目取得用
 * Requirements:
 * - 8.2: 見積依頼に選択された項目リストを保存する
 * - 4.4, 4.5: 項目の選択状態を記録
 */
model EstimateRequestItem {
  id                      String  @id @default(uuid())
  estimateRequestId       String
  itemizedStatementItemId String
  selected                Boolean @default(false)

  estimateRequest       EstimateRequest       @relation(fields: [estimateRequestId], references: [id], onDelete: Cascade)
  itemizedStatementItem ItemizedStatementItem @relation(fields: [itemizedStatementItemId], references: [id])

  @@unique([estimateRequestId, itemizedStatementItemId])
  @@index([estimateRequestId])
  @@map("estimate_request_items")
}

/**
 * 受領見積書モデル
 * 見積依頼に対する協力業者からの返答として届いた受領見積書を管理する。
 * テキスト入力またはファイルアップロードのいずれかでコンテンツを保存する。
 * フィールド:
 * - id: 受領見積書の一意ID（UUID）
 * - estimateRequestId: 見積依頼ID（外部キー、カスケード削除）
 * - name: 受領見積書名（必須、最大200文字）
 * - submittedAt: 提出日（必須）
 * - contentType: コンテンツタイプ（TEXT/FILE）
 * - textContent: テキストコンテンツ（contentType=TEXTの場合に必須）
 * - filePath: R2オブジェクトパス（contentType=FILEの場合に必須）
 * - fileName: 元ファイル名（contentType=FILEの場合に必須）
 * - fileMimeType: MIMEタイプ（contentType=FILEの場合に必須）
 * - fileSize: ファイルサイズ（バイト、contentType=FILEの場合に必須）
 * - createdAt: 作成日時
 * - updatedAt: 更新日時（楽観的排他制御用）
 * - deletedAt: 論理削除日時
 * インデックス:
 * - estimateRequestId: 見積依頼単位での受領見積書検索用
 * - deletedAt: 論理削除フィルタリング用
 * - createdAt: 作成日時でのソート用
 * Requirements:
 * - 11.1-11.17: 受領見積書登録機能
 * - 11.3: 受領見積書名（必須）
 * - 11.4: 提出日（必須）
 * - 11.5: テキスト入力フィールド
 * - 11.6, 11.8: ファイルアップロード
 * - 11.7: テキストとファイルの排他的選択
 * - 11.11: 1つの見積依頼に対して複数の受領見積書を許可
 */
model ReceivedQuotation {
  id                String                       @id @default(uuid())
  estimateRequestId String
  name              String // 受領見積書名（必須、最大200文字）
  submittedAt       DateTime                     @db.Date // 提出日
  contentType       ReceivedQuotationContentType // コンテンツタイプ（TEXT/FILE）
  textContent       String? // テキストコンテンツ（contentType=TEXTの場合）
  filePath          String? // R2オブジェクトパス（contentType=FILEの場合）
  fileName          String? // 元ファイル名（contentType=FILEの場合）
  fileMimeType      String? // MIMEタイプ（contentType=FILEの場合）
  fileSize          Int? // ファイルサイズ（バイト、contentType=FILEの場合）
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt
  deletedAt         DateTime? // 論理削除

  estimateRequest EstimateRequest @relation(fields: [estimateRequestId], references: [id], onDelete: Cascade)

  @@index([estimateRequestId])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("received_quotations")
}

/**
 * 見積依頼ステータス変更履歴モデル
 * 見積依頼のステータス変更履歴を記録する。
 * フィールド:
 * - id: 履歴レコードの一意ID（UUID）
 * - estimateRequestId: 対象見積依頼ID（外部キー、カスケード削除）
 * - fromStatus: 変更前のステータス（nullable: 初期ステータス設定時はnull）
 * - toStatus: 変更後のステータス（必須）
 * - changedById: 変更実行者ID（外部キー）
 * - changedAt: 変更日時（自動設定）
 * インデックス:
 * - estimateRequestId: 見積依頼単位での履歴検索用
 * - changedAt: タイムライン検索用
 * Requirements:
 * - 12.11: ステータス変更履歴を記録する
 */
model EstimateRequestStatusHistory {
  id                String                 @id @default(uuid())
  estimateRequestId String
  fromStatus        EstimateRequestStatus? // nullable: 初期ステータス設定時はnull
  toStatus          EstimateRequestStatus
  changedById       String
  changedAt         DateTime               @default(now())

  estimateRequest EstimateRequest @relation(fields: [estimateRequestId], references: [id], onDelete: Cascade)
  changedBy       User            @relation("EstimateRequestStatusChangedByUser", fields: [changedById], references: [id])

  @@index([estimateRequestId])
  @@index([changedAt])
  @@map("estimate_request_status_histories")
}

// ===== Company Info Management Data Models =====

/**
 * 自社情報モデル
 * 見積書・請求書などの帳票出力時に使用する自社の基本情報を管理する。
 * 1件のみ存在可能（シングルトンパターン）。削除機能は提供しない。
 * フィールド:
 * - id: 自社情報の一意ID（UUID）
 * - companyName: 会社名（必須、最大200文字）
 * - address: 住所（必須、最大500文字）
 * - representative: 代表者（必須、最大100文字）
 * - phone: 電話番号（任意、最大20文字）
 * - fax: FAX番号（任意、最大20文字）
 * - email: メールアドレス（任意、最大254文字）
 * - invoiceRegistrationNumber: 適格請求書発行事業者登録番号（任意、T+13桁数字）
 * - version: 楽観的排他制御用バージョン
 * - createdAt: 作成日時
 * - updatedAt: 更新日時
 * Requirements (company-info):
 * - 1.1-1.5: 自社情報登録画面表示
 * - 2.1-2.8: 自社情報の保存（upsert）
 * - 4.1-4.10: データバリデーション
 * - 6.1-6.10: アクセス制御
 * - 9.1-9.10: API設計
 */
model CompanyInfo {
  id                        String   @id @default(uuid())
  companyName               String   @map("company_name") // 会社名（必須、最大200文字）
  address                   String // 住所（必須、最大500文字）
  representative            String // 代表者（必須、最大100文字）
  phone                     String? // 電話番号（任意、最大20文字）
  fax                       String? // FAX番号（任意、最大20文字）
  email                     String? // メールアドレス（任意、最大254文字）
  invoiceRegistrationNumber String?  @map("invoice_registration_number") // 適格請求書発行事業者登録番号（任意、T+13桁）
  version                   Int      @default(0) // 楽観的排他制御用
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  @@map("company_info")
}
