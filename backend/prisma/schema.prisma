// Prisma Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===== User Authentication Data Models =====

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  displayName          String
  passwordHash         String
  twoFactorEnabled     Boolean   @default(false)
  twoFactorSecret      String? // AES-256-GCM暗号化済み（Base32エンコードされたTOTP秘密鍵）
  isLocked             Boolean   @default(false)
  lockedUntil          DateTime?
  loginFailures        Int       @default(0)
  twoFactorFailures    Int       @default(0)
  twoFactorLockedUntil DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  userRoles             UserRole[]
  refreshTokens         RefreshToken[]
  invitationsSent       Invitation[]          @relation("InviterToInvitations")
  invitation            Invitation?           @relation("InvitationToUser")
  passwordResetRequests PasswordResetToken[]
  passwordHistories     PasswordHistory[]
  twoFactorBackupCodes  TwoFactorBackupCode[]
  auditLogsAsActor      AuditLog[]            @relation("ActorAuditLogs")

  // Project Management リレーション
  salesPersonProjects        Project[]              @relation("SalesPersonProjects")
  constructionPersonProjects Project[]              @relation("ConstructionPersonProjects")
  createdProjects            Project[]              @relation("CreatedProjects")
  statusChangedHistories     ProjectStatusHistory[] @relation("StatusChangedByUser")

  @@index([email])
  @@index([isLocked])
  @@map("users")
}

model Invitation {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  inviterId String
  status    String    @default("pending") // pending, used, expired, revoked
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  userId    String?   @unique

  inviter User  @relation("InviterToInvitations", fields: [inviterId], references: [id])
  user    User? @relation("InvitationToUser", fields: [userId], references: [id])

  @@index([token])
  @@index([email])
  @@index([status])
  @@index([expiresAt])
  @@map("invitations")
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  token      String   @unique
  deviceInfo String? // User-Agent情報（オプション）
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  priority    Int      @default(0) // 高い値が高優先度
  isSystem    Boolean  @default(false) // システムロール（削除不可）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@index([name])
  @@index([priority])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String // adr, user, role, permission, project, report, settings
  action      String // create, read, update, delete, manage, approve, reject, delegate, export
  description String
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([action])
  @@map("permissions")
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  assignedAt   DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model PasswordHistory {
  id           String   @id @default(uuid())
  userId       String
  passwordHash String // Argon2idハッシュ
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("password_histories")
}

model TwoFactorBackupCode {
  id        String    @id @default(uuid())
  userId    String
  codeHash  String // Argon2idハッシュ（8文字の英数字コード）
  usedAt    DateTime? // 使用済み追跡（1回限り使用）
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([usedAt])
  @@map("two_factor_backup_codes")
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String // ROLE_CREATED, ROLE_UPDATED, ROLE_DELETED, PERMISSION_ASSIGNED, PERMISSION_REVOKED, USER_ROLE_ASSIGNED, USER_ROLE_REVOKED, PERMISSION_CHECK_FAILED, TWO_FACTOR_ENABLED, TWO_FACTOR_DISABLED
  actorId    String
  targetType String // User, Role, Permission, UserRole, RolePermission
  targetId   String
  before     Json? // 変更前の値（JSON形式）
  after      Json? // 変更後の値（JSON形式）
  metadata   Json? // IPアドレス、ユーザーエージェント、リクエストID
  createdAt  DateTime @default(now())

  actor User @relation("ActorAuditLogs", fields: [actorId], references: [id], onDelete: Cascade)
  // Note: targetIdは多態的なフィールドで、targetTypeに応じてUser/Role/Permission等を参照
  // 外部キー制約は設けず、アプリケーションレベルで整合性を管理

  @@index([actorId])
  @@index([targetId])
  @@index([targetType, targetId])
  @@index([actorId, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

// ===== Project Management Data Models =====

/**
 * プロジェクトステータス
 * ワークフロー順: 準備中 → 調査中 → 見積中 → 決裁待ち → 契約中 → 工事中 → 引渡中 → 請求中 → 入金待ち → 完了
 * 終端ステータス: 完了、中止、失注
 * Requirements: 10.1
 */
enum ProjectStatus {
  PREPARING // 準備中
  SURVEYING // 調査中
  ESTIMATING // 見積中
  APPROVING // 決裁待ち
  CONTRACTING // 契約中
  CONSTRUCTING // 工事中
  DELIVERING // 引渡中
  BILLING // 請求中
  AWAITING // 入金待ち
  COMPLETED // 完了
  CANCELLED // 中止
  LOST // 失注
}

/**
 * ステータス遷移種別
 * Requirements: 10.11
 */
enum TransitionType {
  initial // 初期遷移（プロジェクト作成時、fromStatusなし）
  forward // 順方向遷移（ワークフロー進行）
  backward // 差し戻し遷移（1つ前のステータスへ戻る）
  terminate // 終端遷移（完了・中止・失注）
}

/**
 * プロジェクトモデル
 * プロジェクトは工事案件が発生した際に最初に作成されるエンティティ。
 * 当該工事における現場調査や見積などの業務は、プロジェクト配下にぶら下がる形で管理される。
 * Requirements: 1.14, 1.15, 9.7, 13.1, 13.2, 13.3, 13.5, 13.7, 13.8
 */
model Project {
  id                   String        @id @default(uuid())
  name                 String // プロジェクト名（必須、1-255文字）
  customerName         String // 顧客名（必須、1-255文字）
  salesPersonId        String // 営業担当者ID（必須）
  constructionPersonId String? // 工事担当者ID（任意）
  siteAddress          String? // 現場住所（任意、最大500文字）
  description          String? // 概要（任意、最大5000文字）
  status               ProjectStatus @default(PREPARING)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  deletedAt            DateTime? // 論理削除フィールド
  createdById          String // 作成者ID

  // Userモデルとのリレーション
  salesPerson        User                   @relation("SalesPersonProjects", fields: [salesPersonId], references: [id])
  constructionPerson User?                  @relation("ConstructionPersonProjects", fields: [constructionPersonId], references: [id])
  createdBy          User                   @relation("CreatedProjects", fields: [createdById], references: [id])
  statusHistory      ProjectStatusHistory[]

  // 検索・フィルタリング・ソート用インデックス
  @@index([name])
  @@index([customerName])
  @@index([status])
  @@index([salesPersonId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([deletedAt])
  @@map("projects")
}

/**
 * プロジェクトステータス変更履歴
 * ステータス変更の履歴を記録し、遷移種別と差し戻し理由を含む
 * フィールド:
 * - id: 履歴レコードの一意ID（UUID）
 * - projectId: 対象プロジェクトID（外部キー、カスケード削除）
 * - fromStatus: 変更前のステータス（nullable: 初期遷移時はnull）
 * - toStatus: 変更後のステータス（必須）
 * - transitionType: 遷移種別（initial/forward/backward/terminate）
 * - reason: 差し戻し理由（backward遷移時は必須、他は任意）
 * - changedById: 変更実行者ID（外部キー）
 * - changedAt: 変更日時（自動設定）
 * インデックス:
 * - projectId: プロジェクト単位での履歴検索用
 * - changedAt: タイムライン検索用
 * - transitionType: 遷移種別によるフィルタリング用
 * Requirements: 10.10, 10.11, 10.15
 */
model ProjectStatusHistory {
  id             String         @id @default(uuid())
  projectId      String
  fromStatus     ProjectStatus? // nullable: initial遷移時はnull
  toStatus       ProjectStatus
  transitionType TransitionType
  reason         String? // 差し戻し理由（backward遷移時は必須）
  changedById    String
  changedAt      DateTime       @default(now())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  changedBy User    @relation("StatusChangedByUser", fields: [changedById], references: [id])

  @@index([projectId])
  @@index([changedAt])
  @@index([transitionType])
  @@map("project_status_histories")
}

// ===== Trading Partner Management Data Models =====

/**
 * 取引先種別
 * Requirements: 6.1, 6.2, 6.3
 */
enum TradingPartnerType {
  CUSTOMER // 顧客
  SUBCONTRACTOR // 協力業者
}

/**
 * 取引先モデル
 * 取引先（顧客および協力業者）の情報を一元管理する。
 * フィールド:
 * - id: 取引先の一意ID（UUID）
 * - name: 取引先名（必須、最大200文字）
 * - nameKana: フリガナ（必須、最大200文字、カタカナのみ）
 * - branchName: 部課/支店/支社名（任意、最大100文字）
 * - branchNameKana: 部課/支店/支社フリガナ（任意、最大100文字）
 * - representativeName: 代表者名（任意、最大100文字）
 * - representativeNameKana: 代表者フリガナ（任意、最大100文字）
 * - address: 住所（必須、最大500文字）
 * - phoneNumber: 電話番号（任意）
 * - faxNumber: FAX番号（任意）
 * - email: メールアドレス（任意）
 * - billingClosingDay: 請求締日（1-31 or 99=末日）
 * - paymentMonthOffset: 支払月オフセット（1=翌月, 2=翌々月, 3=3ヶ月後）
 * - paymentDay: 支払日（1-31 or 99=末日）
 * - notes: 備考（最大2000文字）
 * - createdAt: 作成日時
 * - updatedAt: 更新日時（楽観的排他制御用）
 * - deletedAt: 論理削除日時
 * Requirements: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.10, 11.11, 11.12, 11.13, 11.14
 */
model TradingPartner {
  id                     String    @id @default(uuid())
  name                   String // 取引先名（必須、最大200文字）
  nameKana               String // フリガナ（必須、最大200文字、カタカナのみ）
  branchName             String? // 部課/支店/支社名（任意、最大100文字）
  branchNameKana         String? // 部課/支店/支社フリガナ（任意、最大100文字）
  representativeName     String? // 代表者名（任意、最大100文字）
  representativeNameKana String? // 代表者フリガナ（任意、最大100文字）
  address                String // 住所（必須、最大500文字）
  phoneNumber            String? // 電話番号（任意）
  faxNumber              String? // FAX番号（任意）
  email                  String? // メールアドレス（任意）
  billingClosingDay      Int? // 請求締日（1-31 or 99=末日）
  paymentMonthOffset     Int? // 支払月オフセット（1=翌月, 2=翌々月, 3=3ヶ月後）
  paymentDay             Int? // 支払日（1-31 or 99=末日）
  notes                  String? // 備考（最大2000文字）
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  deletedAt              DateTime? // 論理削除

  // リレーション
  types TradingPartnerTypeMapping[]

  // インデックス
  @@unique([name, deletedAt], name: "name_deletedAt") // 削除されていない取引先名の一意制約
  @@index([nameKana])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("trading_partners")
}

/**
 * 取引先種別マッピング（多対多の代替としてのジョイントテーブル）
 * 1つの取引先は「顧客」「協力業者」またはその両方を持つことができる。
 * Requirements: 6.1, 6.2, 6.3
 */
model TradingPartnerTypeMapping {
  id               String             @id @default(uuid())
  tradingPartnerId String
  type             TradingPartnerType

  tradingPartner TradingPartner @relation(fields: [tradingPartnerId], references: [id], onDelete: Cascade)

  @@unique([tradingPartnerId, type], name: "tradingPartnerId_type")
  @@index([tradingPartnerId])
  @@index([type])
  @@map("trading_partner_type_mappings")
}
