name: CD - Production

on:
  # mainブランチへのpushで自動デプロイ
  push:
    branches: [main]

  # 手動実行も可能
  workflow_dispatch:

# デプロイメント実行の同時実行制御
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      # デプロイ前の通知
      - name: Pre-deployment notification
        run: |
          echo "========================================="
          echo "Production Deployment Information"
          echo "========================================="
          echo "Environment: production"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Commit Message: ${{ github.event.head_commit.message }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "========================================="
          echo ""
          echo "⚠️  PRODUCTION DEPLOYMENT IN PROGRESS"
          echo "⚠️  This will affect live users"
          echo ""

      # Railway CLIを使用したデプロイ
      - name: Setup Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy Backend to Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Backend to Railway (Production)"
          echo "========================================="
          railway up --service ${{ secrets.RAILWAY_BACKEND_SERVICE_ID }} --environment production --detach
          echo "Backend deployment initiated"

      - name: Deploy Frontend to Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Frontend to Railway (Production)"
          echo "========================================="
          railway up --service ${{ secrets.RAILWAY_FRONTEND_SERVICE_ID }} --environment production --detach
          echo "Frontend deployment initiated"

      # デプロイ後の待機（Railwayがデプロイを完了するまで）
      - name: Wait for deployment
        run: |
          echo "Waiting for Railway deployment to complete..."
          sleep 90

      # ヘルスチェック実行
      - name: Health check
        id: health-check
        run: |
          echo "========================================="
          echo "Running Health Checks (Production)"
          echo "========================================="

          BACKEND_URL="${{ secrets.PRODUCTION_BACKEND_URL }}"
          FRONTEND_URL="${{ secrets.PRODUCTION_FRONTEND_URL }}"
          MAX_RETRIES=10
          RETRY_INTERVAL=10

          echo "Target Backend URL: ${BACKEND_URL}"
          echo "Target Frontend URL: ${FRONTEND_URL}"
          echo ""

          # バックエンドヘルスチェック
          echo "1. Backend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/health" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "✓ Backend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "✗ Backend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Backend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          # フロントエンドヘルスチェック
          echo ""
          echo "2. Frontend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${FRONTEND_URL}" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "✓ Frontend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "✗ Frontend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Frontend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          echo ""
          echo "========================================="
          echo "All Health Checks Passed"
          echo "========================================="

      # デプロイ完了通知
      - name: Post-deployment notification
        if: success()
        run: |
          echo "========================================="
          echo "Production Deployment Completed Successfully"
          echo "========================================="
          echo "Environment: production"
          echo "Backend URL: ${{ secrets.PRODUCTION_BACKEND_URL }}"
          echo "Frontend URL: ${{ secrets.PRODUCTION_FRONTEND_URL }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "✓ Live service is now updated"
          echo ""
          echo "Post-deployment checklist:"
          echo "1. Monitor error rates (Sentry)"
          echo "2. Check application metrics"
          echo "3. Verify user-facing features"
          echo "4. Monitor Railway deployment logs"
          echo "========================================="

      # デプロイ失敗時の通知とロールバック手順
      - name: Deployment failure notification
        if: failure()
        run: |
          echo "========================================="
          echo "⚠️  PRODUCTION DEPLOYMENT FAILED ⚠️"
          echo "========================================="
          echo "Environment: production"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "⚠️  IMMEDIATE ACTION REQUIRED ⚠️"
          echo ""
          echo "Rollback options:"
          echo ""
          echo "Option 1: Railway Dashboard"
          echo "  1. Log in to Railway Dashboard"
          echo "  2. Select ArchiTrack project"
          echo "  3. Go to Deployments tab"
          echo "  4. Select last successful deployment"
          echo "  5. Click 'Redeploy'"
          echo ""
          echo "Option 2: Manual workflow trigger"
          echo "  1. Go to Actions tab"
          echo "  2. Select 'CD - Production' workflow"
          echo "  3. Click 'Run workflow'"
          echo "  4. Select previous commit SHA"
          echo ""
          echo "Option 3: Git revert"
          echo "  git revert ${{ github.sha }}"
          echo "  git push origin main"
          echo ""
          echo "========================================="
          exit 1
