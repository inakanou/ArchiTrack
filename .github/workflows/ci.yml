name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend, e2e]
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Prisma binaries
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/prisma
            **/node_modules/.prisma
          key: prisma-binaries-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            prisma-binaries-${{ runner.os }}-

      - name: Install dependencies
        run: |
          if [ "${{ matrix.workspace }}" = "e2e" ]; then
            npm ci
          else
            npm --prefix ${{ matrix.workspace }} ci
          fi
      - name: Run format check
        run: |
          if [ "${{ matrix.workspace }}" = "e2e" ]; then
            npm run format:check
          else
            npm --prefix ${{ matrix.workspace }} run format:check
          fi
      - name: Run lint
        run: |
          if [ "${{ matrix.workspace }}" = "e2e" ]; then
            npm run lint
          else
            npm --prefix ${{ matrix.workspace }} run lint
          fi

  requirement-coverage:
    name: Requirement Coverage Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check requirement coverage
        run: |
          echo "========================================="
          echo "Requirement Coverage Check"
          echo "========================================="
          echo ""
          echo "This check validates that:"
          echo "  1. All E2E-applicable acceptance criteria are covered by tests"
          echo "  2. Excluded requirements have defined alternative verification methods"
          echo ""
          echo "Exclusion list: e2e/requirement-exclusions.json"
          echo ""
          npm run check:req-coverage

  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend, e2e]
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Prisma binaries
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/prisma
            **/node_modules/.prisma
          key: prisma-binaries-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            prisma-binaries-${{ runner.os }}-

      - name: Install dependencies
        run: |
          if [ "${{ matrix.workspace }}" = "e2e" ]; then
            npm ci
          else
            npm --prefix ${{ matrix.workspace }} ci
          fi
      - name: Run type check
        run: |
          if [ "${{ matrix.workspace }}" = "e2e" ]; then
            npm run type-check
          else
            npm --prefix ${{ matrix.workspace }} run type-check
          fi
        env:
          # Prisma 7 requires DATABASE_URL for prisma generate (dummy value for CI)
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend]
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Prisma binaries
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/prisma
            **/node_modules/.prisma
          key: prisma-binaries-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            prisma-binaries-${{ runner.os }}-

      - name: Install dependencies
        run: npm --prefix ${{ matrix.workspace }} ci
      - name: Generate Prisma Client (backend only)
        if: matrix.workspace == 'backend'
        run: npm --prefix backend run prisma:generate
        env:
          # Prisma 7 requires DATABASE_URL for prisma generate (dummy value for CI)
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
      - name: Run unit tests
        run: |
          if [ "${{ matrix.workspace }}" = "backend" ]; then
            npm --prefix backend run test:unit
          else
            npm --prefix frontend run test
          fi
      - name: Generate coverage report
        run: |
          if [ "${{ matrix.workspace }}" = "backend" ]; then
            npm --prefix backend run test:unit:coverage
          else
            npm --prefix frontend run test:coverage
          fi
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ${{ matrix.workspace }}/coverage
          flags: ${{ matrix.workspace }}-unit

      - name: Check coverage gaps (warning mode)
        continue-on-error: true
        run: |
          echo "========================================="
          echo "Coverage Gap Check (${{ matrix.workspace }})"
          echo "========================================="
          npm --prefix ${{ matrix.workspace }} run coverage:check || {
            echo ""
            echo "‚ö†Ô∏è  Coverage gaps detected (warning mode - not blocking)"
            echo "   Run 'npm run coverage:check' locally for details"
          }

  build:
    name: Build Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend]
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Prisma binaries
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/prisma
            **/node_modules/.prisma
          key: prisma-binaries-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            prisma-binaries-${{ runner.os }}-

      - name: Install dependencies
        run: npm --prefix ${{ matrix.workspace }} ci
      - name: Build
        run: npm --prefix ${{ matrix.workspace }} run build
        env:
          # Prisma 7 requires DATABASE_URL for prisma generate (dummy value for CI)
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      # Phase 1: Validate ES Module imports with node (backend only)
      - name: Validate ES Module imports (backend)
        if: matrix.workspace == 'backend'
        run: |
          echo "üîç Validating ES Module imports with node..."

          # Validate entry point
          node --check ${{ matrix.workspace }}/dist/src/index.js

          # Validate all built JavaScript files
          find ${{ matrix.workspace }}/dist -name '*.js' -type f | while read file; do
            echo "Checking: $file"
            node --check "$file" || {
              echo "‚ùå ES Module error in: $file"
              echo "üí° Hint: Check for missing .js extensions in imports"
              exit 1
            }
          done

          echo "‚úÖ All ES modules are valid (no import errors detected)"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.workspace }}-build
          path: ${{ matrix.workspace }}/dist
          retention-days: 7

  test-storybook:
    name: Storybook Tests
    runs-on: ubuntu-latest
    needs: [lint, typecheck, build]
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Prisma binaries
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/prisma
            **/node_modules/.prisma
          key: prisma-binaries-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            prisma-binaries-${{ runner.os }}-

      - name: Install frontend dependencies
        run: npm --prefix frontend ci
      - name: Install Playwright browsers
        run: npx --prefix frontend playwright install chromium --with-deps
      - name: Run Storybook tests
        run: npm --prefix frontend run test-storybook:ci
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: storybook-test-results
          path: frontend/test-results/

  test-integration:
    name: Integration & E2E Tests
    runs-on: ubuntu-latest
    # requirement-coverage „ÇíÂâçÊèêÊù°‰ª∂„Å´ËøΩÂä†ÔºàE2EÂÆüË°åÂâç„Å´„Ç´„Éê„É¨„ÉÉ„Ç∏Ê§úË®º„ÇíÈÄöÈÅé„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„ÇãÔºâ
    needs: [lint, typecheck, test-unit, build, test-storybook, requirement-coverage]
    # Dependabot PR„Åß„ÅØ„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Å™„ÅÑ„Åü„ÇÅ„ÄÅintegration/e2e„ÉÜ„Çπ„Éà„Çí„Çπ„Ç≠„ÉÉ„Éó
    if: github.actor != 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Prisma binaries
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/prisma
            **/node_modules/.prisma
          key: prisma-binaries-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            prisma-binaries-${{ runner.os }}-

      - name: Install Japanese fonts for Playwright screenshots
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk

      - name: Install root dependencies
        run: npm ci

      - name: Install backend dependencies
        run: npm --prefix backend ci

      - name: Generate Prisma Client
        run: npm --prefix backend run prisma:generate
        env:
          # Prisma 7 requires DATABASE_URL for prisma generate (dummy value for CI)
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
      - name: Start PostgreSQL and Redis with Docker Compose
        run: |
          # PostgreSQL„Å®Redis„ÅÆ„Åø„ÇíËµ∑ÂãïÔºàbackend„Å®frontend„ÅØËµ∑Âãï„Åó„Å™„ÅÑÔºâ
          # CIÁí∞Â¢ÉÁî®„ÅÆ„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d postgres redis
          # „Çµ„Éº„Éì„Çπ„Ååhealthy„Å´„Å™„Çã„Åæ„ÅßÂæÖ„Å§
          timeout 60 bash -c 'until docker ps | grep -q "healthy.*architrack-postgres"; do sleep 2; done'
          timeout 60 bash -c 'until docker ps | grep -q "healthy.*architrack-redis"; do sleep 2; done'
      - name: Validate environment variables for integration tests
        run: |
          echo "üîç Validating required environment variables for integration tests..."

          missing_vars=()

          if [ -z "${{ secrets.TEST_JWT_PUBLIC_KEY }}" ]; then
            missing_vars+=("TEST_JWT_PUBLIC_KEY")
          fi

          if [ -z "${{ secrets.TEST_JWT_PRIVATE_KEY }}" ]; then
            missing_vars+=("TEST_JWT_PRIVATE_KEY")
          fi

          if [ -z "${{ secrets.TEST_TWO_FACTOR_ENCRYPTION_KEY }}" ]; then
            missing_vars+=("TEST_TWO_FACTOR_ENCRYPTION_KEY")
          fi

          if [ ${#missing_vars[@]} -gt 0 ]; then
            echo "‚ùå Missing required GitHub Secrets:"
            for var in "${missing_vars[@]}"; do
              echo "  - $var"
            done
            echo ""
            echo "Please configure these secrets in:"
            echo "  Settings > Secrets and variables > Actions > Repository secrets"
            echo ""
            echo "To generate these values:"
            echo "  - JWT keys: npm run generate-keys (in backend directory)"
            echo "  - 2FA key: node -e \"console.log(require('crypto').randomBytes(32).toString('hex'))\""
            exit 1
          fi

          echo "‚úÖ All required environment variables are configured"

      - name: Setup test database
        run: |
          # „ÉÜ„Çπ„Éà„Éá„Éº„Çø„Éô„Éº„Çπ„ÅåÊó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØÂâäÈô§„Åó„Å¶ÂÜç‰ΩúÊàêÔºà„ÇØ„É™„Éº„É≥„Å™Áä∂ÊÖã„Çí‰øùË®ºÔºâ
          docker exec architrack-postgres psql -U postgres -c "DROP DATABASE IF EXISTS architrack_test;"
          docker exec architrack-postgres psql -U postgres -c "CREATE DATABASE architrack_test;"
          # „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíÈÅ©Áî®Ôºà„É©„É≥„Éä„Éº‰∏ä„ÅßÂÆüË°åÔºâ
          npm --prefix backend run prisma:migrate:deploy
        env:
          DATABASE_URL: postgresql://postgres:dev@localhost:5432/architrack_test
      - name: Run integration tests
        run: npm --prefix backend run test:integration
        env:
          DATABASE_URL: postgresql://postgres:dev@localhost:5432/architrack_test
          NODE_ENV: test
          REDIS_URL: redis://localhost:6379/1
          JWT_PUBLIC_KEY: ${{ secrets.TEST_JWT_PUBLIC_KEY }}
          JWT_PRIVATE_KEY: ${{ secrets.TEST_JWT_PRIVATE_KEY }}
          TWO_FACTOR_ENCRYPTION_KEY: ${{ secrets.TEST_TWO_FACTOR_ENCRYPTION_KEY }}

      - name: Create .env file for E2E
        run: |
          echo "NODE_ENV=test" > .env
          echo "PORT=3000" >> .env
          echo "LOG_LEVEL=info" >> .env
          echo "DATABASE_URL=postgresql://postgres:dev@postgres:5432/architrack_test" >> .env
          echo "REDIS_URL=redis://redis:6379" >> .env
          echo "FRONTEND_URL=http://localhost:5173" >> .env
          echo "ACCESS_TOKEN_EXPIRY=15m" >> .env
          echo "REFRESH_TOKEN_EXPIRY=7d" >> .env
          echo "VITE_API_URL=http://localhost:3000" >> .env
          echo "JWT_PUBLIC_KEY=${{ secrets.TEST_JWT_PUBLIC_KEY }}" >> .env
          echo "JWT_PRIVATE_KEY=${{ secrets.TEST_JWT_PRIVATE_KEY }}" >> .env
          echo "TWO_FACTOR_ENCRYPTION_KEY=${{ secrets.TEST_TWO_FACTOR_ENCRYPTION_KEY }}" >> .env
          echo "DISABLE_RATE_LIMIT=true" >> .env

      - name: Start Docker Compose for E2E
        run: |
          # CIÁí∞Â¢ÉÁî®„ÅÆ„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d
          timeout 120 bash -c 'until docker ps | grep -q "healthy.*architrack-backend"; do sleep 2; done'
          timeout 120 bash -c 'until docker ps | grep -q "healthy.*architrack-frontend"; do sleep 2; done'

      - name: Debug - Check backend container logs
        if: always()
        run: |
          echo "=== Backend container logs ==="
          docker logs architrack-backend --tail 100
          echo "=== Backend container environment variables (filtered) ==="
          docker exec architrack-backend printenv | grep -E "NODE_ENV|PORT|DATABASE_URL|REDIS_URL|JWT" | sed 's/=.*/=***/'

      - name: Run database migrations
        run: docker exec architrack-backend npx prisma migrate deploy
      - name: Run E2E tests
        run: npx playwright test
        env:
          CI: true
          NODE_ENV: test
          DISABLE_RATE_LIMIT: "true"
          # CIÁí∞Â¢É„Åß„ÅØÊ®ôÊ∫ñ„Éù„Éº„Éà„Çí‰ΩøÁî®Ôºàdocker-compose.ci.ymlË®≠ÂÆöÔºâ
          BASE_URL: http://localhost:5173
          # E2E„ÉÜ„Çπ„Éà„Åß‰ΩøÁî®„Åô„ÇãAPI URLÔºà„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅØ„Éù„Éº„Éà3000„ÅßËµ∑ÂãïÔºâ
          API_BASE_URL: http://127.0.0.1:3000
          DATABASE_URL: postgresql://postgres:dev@localhost:5432/architrack_test
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/
      - name: Stop Docker Compose
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install root dependencies
        run: npm ci --ignore-scripts
      - name: Install backend dependencies
        run: npm --prefix backend ci --ignore-scripts
      - name: Install frontend dependencies
        run: npm --prefix frontend ci --ignore-scripts
      - name: Run security audit
        # Uses unified security audit script with allowlist support
        # - Production deps with high+ severity: block (unless in allowlist)
        # - Dev deps with high+ severity: warn only
        # - Allowlist: .security-audit-allowlist.json
        run: node scripts/security-audit.mjs --verbose

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-unit, build, test-storybook, test-integration, security, requirement-coverage]
    if: always()
    steps:
      - name: Check status
        run: |
          # Dependabot PR„ÅÆÂ†¥Âêà„ÄÅIntegration Tests„ÅØ„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Çã„Åü„ÇÅ„ÄÅskipped„ÇÇË®±ÂÆπ
          integration_ok="false"
          if [[ "${{ needs.test-integration.result }}" == "success" ]] || \
             [[ "${{ needs.test-integration.result }}" == "skipped" ]]; then
            integration_ok="true"
          fi

          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.typecheck.result }}" != "success" ]] || \
             [[ "${{ needs.test-unit.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.test-storybook.result }}" != "success" ]] || \
             [[ "$integration_ok" != "true" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]] || \
             [[ "${{ needs.requirement-coverage.result }}" != "success" ]]; then
            echo "‚ùå CI check failed:"
            echo "   - Lint: ${{ needs.lint.result }}"
            echo "   - TypeCheck: ${{ needs.typecheck.result }}"
            echo "   - Unit Tests: ${{ needs.test-unit.result }}"
            echo "   - Build: ${{ needs.build.result }}"
            echo "   - Storybook Tests: ${{ needs.test-storybook.result }}"
            echo "   - Integration Tests: ${{ needs.test-integration.result }}"
            echo "   - Security: ${{ needs.security.result }}"
            echo "   - Requirement Coverage: ${{ needs.requirement-coverage.result }}"
            exit 1
          fi
          echo "‚úÖ All CI checks passed successfully"

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [ci-success]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Prisma binaries
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/prisma
            **/node_modules/.prisma
          key: prisma-binaries-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            prisma-binaries-${{ runner.os }}-

      - name: Install backend dependencies
        run: npm --prefix backend ci

      - name: Check environment variables
        run: npm --prefix backend run check:env
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          REDIS_URL: ${{ secrets.STAGING_REDIS_URL }}
          FRONTEND_URL: ${{ secrets.STAGING_FRONTEND_URL }}
          JWT_PUBLIC_KEY: ${{ secrets.STAGING_JWT_PUBLIC_KEY }}
          JWT_PRIVATE_KEY: ${{ secrets.STAGING_JWT_PRIVATE_KEY }}
          TWO_FACTOR_ENCRYPTION_KEY: ${{ secrets.STAGING_TWO_FACTOR_ENCRYPTION_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Pre-deployment notification
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          echo "========================================="
          echo "Staging Deployment Information"
          echo "========================================="
          echo "Environment: staging"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Commit Message: ${COMMIT_MSG%%$'\n'*}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "========================================="

      - name: Setup Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy Backend to Staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_STAGING_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Backend to Railway (Staging)"
          echo "========================================="
          railway up --service ${{ secrets.RAILWAY_BACKEND_STAGING_SERVICE_ID }} --environment staging --detach
          echo "Backend deployment initiated"

      - name: Deploy Frontend to Staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_STAGING_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Frontend to Railway (Staging)"
          echo "========================================="
          railway up --service ${{ secrets.RAILWAY_FRONTEND_STAGING_SERVICE_ID }} --environment staging --detach
          echo "Frontend deployment initiated"

      - name: Wait for deployment
        run: |
          echo "Waiting for Railway deployment to complete..."
          sleep 90

      - name: Health check
        id: health-check
        run: |
          echo "========================================="
          echo "Running Health Checks (Staging)"
          echo "========================================="

          BACKEND_URL="${{ secrets.STAGING_BACKEND_URL }}"
          FRONTEND_URL="${{ secrets.STAGING_FRONTEND_URL }}"
          MAX_RETRIES=10
          RETRY_INTERVAL=10

          echo "Target Backend URL: ${BACKEND_URL}"
          echo "Target Frontend URL: ${FRONTEND_URL}"
          echo ""

          # „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          echo "1. Backend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -L -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/health" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "‚úì Backend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "‚úó Backend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Backend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          # „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          echo ""
          echo "2. Frontend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -L -s -o /dev/null -w "%{http_code}" "${FRONTEND_URL}" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "‚úì Frontend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "‚úó Frontend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Frontend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          echo ""
          echo "========================================="
          echo "All Health Checks Passed"
          echo "========================================="

      - name: Post-deployment notification
        if: success()
        run: |
          echo "========================================="
          echo "Staging Deployment Completed Successfully"
          echo "========================================="
          echo "Environment: staging"
          echo "Backend URL: ${{ secrets.STAGING_BACKEND_URL }}"
          echo "Frontend URL: ${{ secrets.STAGING_FRONTEND_URL }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "Next steps:"
          echo "1. Run integration tests on staging environment"
          echo "2. Perform QA validation"
          echo "3. If tests pass, create PR to merge develop ‚Üí main"
          echo "========================================="

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "========================================="
          echo "Staging Deployment Failed"
          echo "========================================="
          echo "Environment: staging"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "Action required:"
          echo "1. Check Railway deployment logs"
          echo "2. Review CI test results"
          echo "3. Fix issues and push again to develop"
          echo "========================================="

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [ci-success]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Prisma binaries
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/prisma
            **/node_modules/.prisma
          key: prisma-binaries-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            prisma-binaries-${{ runner.os }}-

      - name: Install backend dependencies
        run: npm --prefix backend ci

      - name: Check environment variables
        run: npm --prefix backend run check:env
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          REDIS_URL: ${{ secrets.PRODUCTION_REDIS_URL }}
          FRONTEND_URL: ${{ secrets.PRODUCTION_FRONTEND_URL }}
          JWT_PUBLIC_KEY: ${{ secrets.PRODUCTION_JWT_PUBLIC_KEY }}
          JWT_PRIVATE_KEY: ${{ secrets.PRODUCTION_JWT_PRIVATE_KEY }}
          TWO_FACTOR_ENCRYPTION_KEY: ${{ secrets.PRODUCTION_TWO_FACTOR_ENCRYPTION_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Pre-deployment notification
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          echo "========================================="
          echo "Production Deployment Information"
          echo "========================================="
          echo "Environment: production"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Commit Message: ${COMMIT_MSG%%$'\n'*}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "========================================="
          echo ""
          echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT IN PROGRESS"
          echo "‚ö†Ô∏è  This will affect live users"
          echo ""

      - name: Setup Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy Backend to Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Backend to Railway (Production)"
          echo "========================================="
          railway up --service ${{ secrets.RAILWAY_BACKEND_SERVICE_ID }} --environment production --detach
          echo "Backend deployment initiated"

      - name: Deploy Frontend to Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Frontend to Railway (Production)"
          echo "========================================="
          railway up --service ${{ secrets.RAILWAY_FRONTEND_SERVICE_ID }} --environment production --detach
          echo "Frontend deployment initiated"

      - name: Wait for deployment
        run: |
          echo "Waiting for Railway deployment to complete..."
          sleep 90

      - name: Health check
        id: health-check
        run: |
          echo "========================================="
          echo "Running Health Checks (Production)"
          echo "========================================="

          BACKEND_URL="${{ secrets.PRODUCTION_BACKEND_URL }}"
          FRONTEND_URL="${{ secrets.PRODUCTION_FRONTEND_URL }}"
          MAX_RETRIES=10
          RETRY_INTERVAL=10

          echo "Target Backend URL: ${BACKEND_URL}"
          echo "Target Frontend URL: ${FRONTEND_URL}"
          echo ""

          # „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          echo "1. Backend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -L -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/health" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "‚úì Backend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "‚úó Backend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Backend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          # „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          echo ""
          echo "2. Frontend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -L -s -o /dev/null -w "%{http_code}" "${FRONTEND_URL}" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "‚úì Frontend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "‚úó Frontend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Frontend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          echo ""
          echo "========================================="
          echo "All Health Checks Passed"
          echo "========================================="

      - name: Post-deployment notification
        if: success()
        run: |
          echo "========================================="
          echo "Production Deployment Completed Successfully"
          echo "========================================="
          echo "Environment: production"
          echo "Backend URL: ${{ secrets.PRODUCTION_BACKEND_URL }}"
          echo "Frontend URL: ${{ secrets.PRODUCTION_FRONTEND_URL }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "‚úì Live service is now updated"
          echo ""
          echo "Post-deployment checklist:"
          echo "1. Monitor error rates (Sentry)"
          echo "2. Check application metrics"
          echo "3. Verify user-facing features"
          echo "4. Monitor Railway deployment logs"
          echo "========================================="

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "========================================="
          echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT FAILED ‚ö†Ô∏è"
          echo "========================================="
          echo "Environment: production"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "‚ö†Ô∏è  IMMEDIATE ACTION REQUIRED ‚ö†Ô∏è"
          echo ""
          echo "Rollback options:"
          echo ""
          echo "Option 1: Railway Dashboard"
          echo "  1. Log in to Railway Dashboard"
          echo "  2. Select ArchiTrack project"
          echo "  3. Go to Deployments tab"
          echo "  4. Select last successful deployment"
          echo "  5. Click 'Redeploy'"
          echo ""
          echo "Option 2: Manual workflow trigger"
          echo "  1. Go to Actions tab"
          echo "  2. Select 'CI' workflow"
          echo "  3. Click 'Run workflow'"
          echo "  4. Select previous commit SHA"
          echo ""
          echo "Option 3: Git revert"
          echo "  git revert ${{ github.sha }}"
          echo "  git push origin main"
          echo ""
          echo "========================================="
          exit 1
