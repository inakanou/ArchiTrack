name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend, e2e]
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install dependencies
        run: |
          if [ "${{ matrix.workspace }}" = "e2e" ]; then
            npm ci
          else
            npm --prefix ${{ matrix.workspace }} ci
          fi
      - name: Run format check
        run: |
          if [ "${{ matrix.workspace }}" = "e2e" ]; then
            npm run format:check
          else
            npm --prefix ${{ matrix.workspace }} run format:check
          fi
      - name: Run lint
        run: |
          if [ "${{ matrix.workspace }}" = "e2e" ]; then
            npm run lint
          else
            npm --prefix ${{ matrix.workspace }} run lint
          fi

  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend, e2e]
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install dependencies
        run: |
          if [ "${{ matrix.workspace }}" = "e2e" ]; then
            npm ci
          else
            npm --prefix ${{ matrix.workspace }} ci
          fi
      - name: Run type check
        run: |
          if [ "${{ matrix.workspace }}" = "e2e" ]; then
            npm run type-check
          else
            npm --prefix ${{ matrix.workspace }} run type-check
          fi

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend]
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install dependencies
        run: npm --prefix ${{ matrix.workspace }} ci
      - name: Run unit tests
        run: |
          if [ "${{ matrix.workspace }}" = "backend" ]; then
            npm --prefix backend run test:unit
          else
            npm --prefix frontend run test
          fi
      - name: Generate coverage report
        run: |
          if [ "${{ matrix.workspace }}" = "backend" ]; then
            npm --prefix backend run test:unit:coverage
          else
            npm --prefix frontend run test:coverage
          fi
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ${{ matrix.workspace }}/coverage
          flags: ${{ matrix.workspace }}-unit

  build:
    name: Build Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend]
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install dependencies
        run: npm --prefix ${{ matrix.workspace }} ci
      - name: Build
        run: npm --prefix ${{ matrix.workspace }} run build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.workspace }}-build
          path: ${{ matrix.workspace }}/dist
          retention-days: 7

  test-storybook:
    name: Storybook Tests
    runs-on: ubuntu-latest
    needs: [lint, typecheck, build]
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install frontend dependencies
        run: npm --prefix frontend ci
      - name: Install Playwright browsers
        run: npx --prefix frontend playwright install chromium --with-deps
      - name: Run Storybook tests
        run: npm --prefix frontend run test-storybook:ci
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: storybook-test-results
          path: frontend/test-results/

  test-integration:
    name: Integration & E2E Tests
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-unit, build, test-storybook]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: architrack_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install root dependencies
        run: npm ci
      - name: Install backend dependencies
        run: npm --prefix backend ci
      - name: Generate Prisma Client
        run: npm --prefix backend run prisma:generate
      - name: Setup test database
        run: |
          # テストデータベースにマイグレーションを適用
          npm --prefix backend run db:migrate:deploy
        env:
          DATABASE_URL: postgresql://postgres:dev@localhost:5432/architrack_test
      - name: Run integration tests
        run: npm --prefix backend run test:integration
        env:
          DATABASE_URL: postgresql://postgres:dev@localhost:5432/architrack_test
          NODE_ENV: test
          REDIS_URL: redis://localhost:6379/1
      - name: Start Docker Compose for E2E
        run: |
          docker compose up -d
          timeout 120 bash -c 'until docker ps | grep -q "healthy.*architrack-backend"; do sleep 2; done'
          timeout 120 bash -c 'until docker ps | grep -q "healthy.*architrack-frontend"; do sleep 2; done'
      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/
      - name: Stop Docker Compose
        if: always()
        run: docker compose down -v

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend]
    steps:
      - uses: actions/checkout@v5
      - name: Run npm audit
        run: npm --prefix ${{ matrix.workspace }} audit --audit-level=moderate || true

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-unit, build, test-storybook, test-integration, security]
    if: always()
    steps:
      - name: Check status
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.typecheck.result }}" != "success" ]] || \
             [[ "${{ needs.test-unit.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.test-storybook.result }}" != "success" ]] || \
             [[ "${{ needs.test-integration.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]]; then
            echo "❌ CI check failed:"
            echo "   - Lint: ${{ needs.lint.result }}"
            echo "   - TypeCheck: ${{ needs.typecheck.result }}"
            echo "   - Unit Tests: ${{ needs.test-unit.result }}"
            echo "   - Build: ${{ needs.build.result }}"
            echo "   - Storybook Tests: ${{ needs.test-storybook.result }}"
            echo "   - Integration Tests: ${{ needs.test-integration.result }}"
            echo "   - Security: ${{ needs.security.result }}"
            exit 1
          fi
          echo "✅ All CI checks passed successfully"

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [ci-success]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install backend dependencies
        run: npm --prefix backend ci

      - name: Check environment variables
        run: npm --prefix backend run check:env
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          REDIS_URL: ${{ secrets.STAGING_REDIS_URL }}
          FRONTEND_URL: ${{ secrets.STAGING_FRONTEND_URL }}
          JWT_PUBLIC_KEY: ${{ secrets.STAGING_JWT_PUBLIC_KEY }}
          JWT_PRIVATE_KEY: ${{ secrets.STAGING_JWT_PRIVATE_KEY }}
          TWO_FACTOR_ENCRYPTION_KEY: ${{ secrets.STAGING_TWO_FACTOR_ENCRYPTION_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Pre-deployment notification
        run: |
          echo "========================================="
          echo "Staging Deployment Information"
          echo "========================================="
          echo "Environment: staging"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Commit Message: ${{ github.event.head_commit.message }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "========================================="

      - name: Setup Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy Backend to Staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_STAGING_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Backend to Railway (Staging)"
          echo "========================================="
          railway up --service ${{ secrets.RAILWAY_BACKEND_STAGING_SERVICE_ID }} --environment staging --detach
          echo "Backend deployment initiated"

      - name: Deploy Frontend to Staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_STAGING_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Frontend to Railway (Staging)"
          echo "========================================="
          railway up --service ${{ secrets.RAILWAY_FRONTEND_STAGING_SERVICE_ID }} --environment staging --detach
          echo "Frontend deployment initiated"

      - name: Wait for deployment
        run: |
          echo "Waiting for Railway deployment to complete..."
          sleep 90

      - name: Health check
        id: health-check
        run: |
          echo "========================================="
          echo "Running Health Checks (Staging)"
          echo "========================================="

          BACKEND_URL="${{ secrets.STAGING_BACKEND_URL }}"
          FRONTEND_URL="${{ secrets.STAGING_FRONTEND_URL }}"
          MAX_RETRIES=10
          RETRY_INTERVAL=10

          echo "Target Backend URL: ${BACKEND_URL}"
          echo "Target Frontend URL: ${FRONTEND_URL}"
          echo ""

          # バックエンドヘルスチェック
          echo "1. Backend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -L -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/health" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "✓ Backend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "✗ Backend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Backend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          # フロントエンドヘルスチェック
          echo ""
          echo "2. Frontend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -L -s -o /dev/null -w "%{http_code}" "${FRONTEND_URL}" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "✓ Frontend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "✗ Frontend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Frontend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          echo ""
          echo "========================================="
          echo "All Health Checks Passed"
          echo "========================================="

      - name: Post-deployment notification
        if: success()
        run: |
          echo "========================================="
          echo "Staging Deployment Completed Successfully"
          echo "========================================="
          echo "Environment: staging"
          echo "Backend URL: ${{ secrets.STAGING_BACKEND_URL }}"
          echo "Frontend URL: ${{ secrets.STAGING_FRONTEND_URL }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "Next steps:"
          echo "1. Run integration tests on staging environment"
          echo "2. Perform QA validation"
          echo "3. If tests pass, create PR to merge develop → main"
          echo "========================================="

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "========================================="
          echo "Staging Deployment Failed"
          echo "========================================="
          echo "Environment: staging"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "Action required:"
          echo "1. Check Railway deployment logs"
          echo "2. Review CI test results"
          echo "3. Fix issues and push again to develop"
          echo "========================================="

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [ci-success]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install backend dependencies
        run: npm --prefix backend ci

      - name: Check environment variables
        run: npm --prefix backend run check:env
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          REDIS_URL: ${{ secrets.PRODUCTION_REDIS_URL }}
          FRONTEND_URL: ${{ secrets.PRODUCTION_FRONTEND_URL }}
          JWT_PUBLIC_KEY: ${{ secrets.PRODUCTION_JWT_PUBLIC_KEY }}
          JWT_PRIVATE_KEY: ${{ secrets.PRODUCTION_JWT_PRIVATE_KEY }}
          TWO_FACTOR_ENCRYPTION_KEY: ${{ secrets.PRODUCTION_TWO_FACTOR_ENCRYPTION_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Pre-deployment notification
        run: |
          echo "========================================="
          echo "Production Deployment Information"
          echo "========================================="
          echo "Environment: production"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Commit Message: ${{ github.event.head_commit.message }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "========================================="
          echo ""
          echo "⚠️  PRODUCTION DEPLOYMENT IN PROGRESS"
          echo "⚠️  This will affect live users"
          echo ""

      - name: Setup Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy Backend to Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Backend to Railway (Production)"
          echo "========================================="
          railway up --service ${{ secrets.RAILWAY_BACKEND_SERVICE_ID }} --environment production --detach
          echo "Backend deployment initiated"

      - name: Deploy Frontend to Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Frontend to Railway (Production)"
          echo "========================================="
          railway up --service ${{ secrets.RAILWAY_FRONTEND_SERVICE_ID }} --environment production --detach
          echo "Frontend deployment initiated"

      - name: Wait for deployment
        run: |
          echo "Waiting for Railway deployment to complete..."
          sleep 90

      - name: Health check
        id: health-check
        run: |
          echo "========================================="
          echo "Running Health Checks (Production)"
          echo "========================================="

          BACKEND_URL="${{ secrets.PRODUCTION_BACKEND_URL }}"
          FRONTEND_URL="${{ secrets.PRODUCTION_FRONTEND_URL }}"
          MAX_RETRIES=10
          RETRY_INTERVAL=10

          echo "Target Backend URL: ${BACKEND_URL}"
          echo "Target Frontend URL: ${FRONTEND_URL}"
          echo ""

          # バックエンドヘルスチェック
          echo "1. Backend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -L -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/health" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "✓ Backend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "✗ Backend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Backend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          # フロントエンドヘルスチェック
          echo ""
          echo "2. Frontend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -L -s -o /dev/null -w "%{http_code}" "${FRONTEND_URL}" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "✓ Frontend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "✗ Frontend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Frontend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          echo ""
          echo "========================================="
          echo "All Health Checks Passed"
          echo "========================================="

      - name: Post-deployment notification
        if: success()
        run: |
          echo "========================================="
          echo "Production Deployment Completed Successfully"
          echo "========================================="
          echo "Environment: production"
          echo "Backend URL: ${{ secrets.PRODUCTION_BACKEND_URL }}"
          echo "Frontend URL: ${{ secrets.PRODUCTION_FRONTEND_URL }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "✓ Live service is now updated"
          echo ""
          echo "Post-deployment checklist:"
          echo "1. Monitor error rates (Sentry)"
          echo "2. Check application metrics"
          echo "3. Verify user-facing features"
          echo "4. Monitor Railway deployment logs"
          echo "========================================="

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "========================================="
          echo "⚠️  PRODUCTION DEPLOYMENT FAILED ⚠️"
          echo "========================================="
          echo "Environment: production"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "⚠️  IMMEDIATE ACTION REQUIRED ⚠️"
          echo ""
          echo "Rollback options:"
          echo ""
          echo "Option 1: Railway Dashboard"
          echo "  1. Log in to Railway Dashboard"
          echo "  2. Select ArchiTrack project"
          echo "  3. Go to Deployments tab"
          echo "  4. Select last successful deployment"
          echo "  5. Click 'Redeploy'"
          echo ""
          echo "Option 2: Manual workflow trigger"
          echo "  1. Go to Actions tab"
          echo "  2. Select 'CI' workflow"
          echo "  3. Click 'Run workflow'"
          echo "  4. Select previous commit SHA"
          echo ""
          echo "Option 3: Git revert"
          echo "  git revert ${{ github.sha }}"
          echo "  git push origin main"
          echo ""
          echo "========================================="
          exit 1
