name: CD

on:
  # CI成功後に自動実行
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]

  # 手動実行でデプロイ環境を選択可能
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'staging'

# デプロイメント実行の同時実行制御
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'production' }}
  cancel-in-progress: false

jobs:
  # CI成功確認ジョブ
  check-ci:
    name: Verify CI Success
    runs-on: ubuntu-latest
    # workflow_runトリガーかつCI成功時のみ実行（失敗/キャンセル時はスキップ）
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    steps:
      - name: CI workflow succeeded
        run: echo "CI workflow succeeded - proceeding with deployment"

  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'Production' }}
    runs-on: ubuntu-latest
    # CI成功時、またはworkflow_dispatchの場合に実行
    needs: [check-ci]
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'workflow_run' && needs.check-ci.result == 'success')

    # GitHub環境設定（デプロイ履歴・承認フロー用）
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - uses: actions/checkout@v4

      # デプロイ前の通知とバックアップ記録
      - name: Pre-deployment notification
        run: |
          echo "========================================="
          echo "Deployment Information"
          echo "========================================="
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Commit Message: ${{ github.event.head_commit.message }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "========================================="

          # GitHub環境にデプロイ開始を記録
          echo "DEPLOY_START_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_ENV
          echo "DEPLOY_COMMIT=${{ github.sha }}" >> $GITHUB_ENV

      # Railway CLIを使用したデプロイ
      - name: Setup Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy Backend to Railway
        id: deploy-backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Backend to Railway"
          echo "========================================="

          # Backendサービスをデプロイ
          railway up --service ${{ secrets.RAILWAY_BACKEND_SERVICE_ID }} --detach

          echo "Backend deployment initiated"

      - name: Deploy Frontend to Railway
        id: deploy-frontend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "========================================="
          echo "Deploying Frontend to Railway"
          echo "========================================="

          # Frontendサービスをデプロイ
          railway up --service ${{ secrets.RAILWAY_FRONTEND_SERVICE_ID }} --detach

          echo "Frontend deployment initiated"

      # デプロイ後の待機（Railwayがデプロイを完了するまで）
      - name: Wait for deployment
        run: |
          echo "Waiting for Railway deployment to complete..."
          sleep 90

      # ヘルスチェック実行
      - name: Health check
        id: health-check
        run: |
          echo "========================================="
          echo "Running Health Checks"
          echo "========================================="

          BACKEND_URL="${{ secrets.PRODUCTION_BACKEND_URL }}"
          MAX_RETRIES=10
          RETRY_INTERVAL=10

          echo "Target Backend URL: ${BACKEND_URL}"
          echo ""

          # バックエンドヘルスチェック
          echo "1. Backend Health Check"
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/health" || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "Backend health check passed (HTTP $HTTP_CODE)"
              break
            elif [[ $i -eq $MAX_RETRIES ]]; then
              echo "Backend health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
              exit 1
            else
              echo "Backend not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          echo ""
          echo "========================================="
          echo "Health Checks Completed Successfully"
          echo "========================================="

      # デプロイ完了通知
      - name: Post-deployment notification
        if: success()
        run: |
          echo "========================================="
          echo "Deployment Completed Successfully"
          echo "========================================="
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Backend URL: ${{ secrets.PRODUCTION_BACKEND_URL }}"
          echo "Frontend URL: ${{ secrets.PRODUCTION_FRONTEND_URL }}"
          echo "Commit: ${{ env.DEPLOY_COMMIT }}"
          echo "Duration: from ${{ env.DEPLOY_START_TIME }}"
          echo "========================================="

      # デプロイ失敗時の通知
      - name: Deployment failure notification
        if: failure()
        run: |
          echo "========================================="
          echo "Deployment Failed"
          echo "========================================="
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Commit: ${{ env.DEPLOY_COMMIT }}"
          echo "Check logs for details"
          echo ""
          echo "Rollback may be required - see rollback section below"
          echo "========================================="

  # ロールバック手順（参考情報）
  #
  # ロールバックが必要な場合は以下の手順を実行してください：
  #
  # 方法1: GitHub Actions workflow_dispatchで前回のコミットをデプロイ
  #   1. Actions タブを開く
  #   2. "CD" workflowを選択
  #   3. "Run workflow" をクリック
  #   4. 対象環境を選択して実行
  #
  # 方法2: Railway Dashboard から直接ロールバック
  #   1. Railway Dashboard にログイン
  #   2. 対象プロジェクトを選択
  #   3. Deployments タブから前回のデプロイメントを選択
  #   4. "Redeploy" をクリック
  #
  # 方法3: Railway CLI を使用
  #   ```bash
  #   # Railway CLIをインストール
  #   npm i -g @railway/cli
  #
  #   # ログイン
  #   railway login
  #
  #   # デプロイメント履歴を確認
  #   railway status
  #
  #   # 特定のデプロイメントにロールバック
  #   railway rollback <deployment-id>
  #   ```
  #
  # 方法4: Gitで前回のコミットに戻してプッシュ
  #   ```bash
  #   # 前回のコミットを確認
  #   git log --oneline -n 10
  #
  #   # 特定のコミットに戻す
  #   git revert <commit-sha>
  #
  #   # または直接リセット（注意: force pushが必要）
  #   git reset --hard <commit-sha>
  #   git push --force-with-lease origin main
  #   ```
  #
  # 緊急時の連絡先:
  #   - チームSlack: #architrack-alerts
  #   - オンコール担当: @platform-team
