FROM node:20-alpine

WORKDIR /app

# Alpine Linux用の必要なビルドツールをインストール
RUN apk add --no-cache python3 make g++

COPY package*.json ./

# npm installを実行し、Alpine用のネイティブモジュールを確実にインストール
RUN npm install

COPY . .

EXPOSE 5173

# 起動時スクリプトを作成
RUN echo '#!/bin/sh\n\
# Alpine環境用のネイティブモジュールを確実にインストール\n\
echo "Rebuilding native modules for Alpine..."\n\
npm install --force --no-save @rollup/rollup-linux-x64-musl 2>/dev/null || true\n\
npm rebuild\n\
echo "Starting Vite dev server..."\n\
exec npm run dev\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

CMD ["/app/entrypoint.sh"]
