echo "ğŸ” Running format checks before push..."

# Backend format check
if [ -d "backend" ]; then
  echo "ğŸ” Checking backend formatting..."
  npm --prefix backend run format:check
  if [ $? -ne 0 ]; then
    echo "âŒ Backend format check failed. Push aborted."
    echo "   Run 'npm --prefix backend run format' to fix formatting issues."
    exit 1
  fi
fi

# Frontend format check
if [ -d "frontend" ]; then
  echo "ğŸ” Checking frontend formatting..."
  npm --prefix frontend run format:check
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend format check failed. Push aborted."
    echo "   Run 'npm --prefix frontend run format' to fix formatting issues."
    exit 1
  fi
fi

# E2E format check
echo "ğŸ” Checking E2E formatting..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ E2E format check failed. Push aborted."
  echo "   Run 'npm run format' to fix formatting issues."
  exit 1
fi

echo "ğŸ” Running type checks before push..."

# Backend type check
if [ -d "backend" ]; then
  echo "ğŸ” Checking backend types..."
  npm --prefix backend run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Backend type check failed. Push aborted."
    exit 1
  fi
fi

# Frontend type check
if [ -d "frontend" ]; then
  echo "ğŸ” Checking frontend types..."
  npm --prefix frontend run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend type check failed. Push aborted."
    exit 1
  fi
fi

# E2E type check
echo "ğŸ” Checking E2E types..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ E2E type check failed. Push aborted."
  exit 1
fi

echo "ğŸ” Running full lint checks before push..."

# Backend lint
if [ -d "backend" ]; then
  echo "ğŸ” Linting backend..."
  npm --prefix backend run lint
  if [ $? -ne 0 ]; then
    echo "âŒ Backend lint failed. Push aborted."
    exit 1
  fi
fi

# Frontend lint
if [ -d "frontend" ]; then
  echo "ğŸ” Linting frontend..."
  npm --prefix frontend run lint
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend lint failed. Push aborted."
    exit 1
  fi
fi

# E2E lint
echo "ğŸ” Linting E2E tests..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ E2E lint failed. Push aborted."
  exit 1
fi

echo "ğŸ”¨ Building projects before push..."

# Backend build
if [ -d "backend" ]; then
  echo "ğŸ”¨ Building backend..."
  npm --prefix backend run build
  if [ $? -ne 0 ]; then
    echo "âŒ Backend build failed. Push aborted."
    exit 1
  fi
fi

# Frontend build
if [ -d "frontend" ]; then
  echo "ğŸ”¨ Building frontend..."
  npm --prefix frontend run build
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend build failed. Push aborted."
    exit 1
  fi
fi

# Backend unit tests
if [ -d "backend" ]; then
  echo "ğŸ§ª Running backend unit tests..."
  npm --prefix backend run test:unit
  if [ $? -ne 0 ]; then
    echo "âŒ Backend unit tests failed. Push aborted."
    exit 1
  fi
fi

# Frontend unit tests
if [ -d "frontend" ]; then
  echo "ğŸ§ª Running frontend unit tests..."
  npm --prefix frontend run test
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend unit tests failed. Push aborted."
    exit 1
  fi
fi

# Backend integration tests
# Dockerç’°å¢ƒãŒå¿…é ˆ - èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
if [ -d "backend" ]; then
  echo "ğŸ”— Running backend integration tests..."

  # Dockerç’°å¢ƒã®ãƒã‚§ãƒƒã‚¯
  if ! docker ps | grep -q architrack-postgres; then
    echo "âŒ Docker containers are not running. Integration tests cannot be executed."
    echo "   Please run 'docker compose up -d' and try again."
    echo "   Push aborted to ensure all tests are executed."
    exit 1
  fi

  # ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã¯Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œ
  # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®Prisma Query Engineå•é¡Œã‚’å›é¿
  docker exec architrack-backend npm run test:integration
  if [ $? -ne 0 ]; then
    echo "âŒ Backend integration tests failed. Push aborted."
    exit 1
  fi
fi

# E2E tests
# Dockerç’°å¢ƒãŒå¿…é ˆ - èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
echo "ğŸ§ª Running E2E tests..."

# Dockerç’°å¢ƒã®ãƒã‚§ãƒƒã‚¯
if ! docker ps | grep -q architrack-backend; then
  echo "âŒ Docker containers are not running. E2E tests cannot be executed."
  echo "   Please run 'docker compose up -d' and try again."
  echo "   Push aborted to ensure all tests are executed."
  exit 1
fi

# E2Eãƒ†ã‚¹ãƒˆã‚’åŒæœŸå®Ÿè¡Œï¼ˆShift-LeftåŸå‰‡: å“è³ªã‚²ãƒ¼ãƒˆã¨ã—ã¦æ©Ÿèƒ½ï¼‰
# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š: 10åˆ†ï¼ˆ600ç§’ï¼‰ã§ãƒãƒ³ã‚°ã‚¢ãƒƒãƒ—ã‚’é˜²æ­¢
echo "   Note: E2E tests will run synchronously to ensure quality before push."
timeout 600 npm run test:e2e
E2E_EXIT_CODE=$?

if [ $E2E_EXIT_CODE -eq 124 ]; then
  echo "âŒ E2E tests timed out after 10 minutes. Push aborted."
  exit 1
elif [ $E2E_EXIT_CODE -ne 0 ]; then
  echo "âŒ E2E tests failed. Push aborted."
  exit 1
fi

echo "âœ… All checks passed!"
