echo "ğŸ” Running type checks before push..."

# Backend type check
if [ -d "backend" ]; then
  echo "ğŸ” Checking backend types..."
  npm --prefix backend run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Backend type check failed. Push aborted."
    exit 1
  fi
fi

# Frontend type check
if [ -d "frontend" ]; then
  echo "ğŸ” Checking frontend types..."
  npm --prefix frontend run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend type check failed. Push aborted."
    exit 1
  fi
fi

# E2E type check
echo "ğŸ” Checking E2E types..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ E2E type check failed. Push aborted."
  exit 1
fi

# Backend unit tests
if [ -d "backend" ]; then
  echo "ğŸ§ª Running backend unit tests..."
  npm --prefix backend run test:unit
  if [ $? -ne 0 ]; then
    echo "âŒ Backend unit tests failed. Push aborted."
    exit 1
  fi
fi

# Frontend unit tests
if [ -d "frontend" ]; then
  echo "ğŸ§ª Running frontend unit tests..."
  npm --prefix frontend run test
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend unit tests failed. Push aborted."
    exit 1
  fi
fi

# Backend integration tests
# Dockerç’°å¢ƒãŒå¿…é ˆ - èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
if [ -d "backend" ]; then
  echo "ğŸ”— Running backend integration tests..."

  # Dockerç’°å¢ƒã®ãƒã‚§ãƒƒã‚¯
  if ! docker ps | grep -q architrack-postgres; then
    echo "âŒ Docker containers are not running. Integration tests cannot be executed."
    echo "   Please run 'docker compose up -d' and try again."
    echo "   Push aborted to ensure all tests are executed."
    exit 1
  fi

  npm --prefix backend run test:integration
  if [ $? -ne 0 ]; then
    echo "âŒ Backend integration tests failed. Push aborted."
    exit 1
  fi
fi

# E2E tests
# Dockerç’°å¢ƒãŒå¿…é ˆ - èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
echo "ğŸ§ª Running E2E tests..."

# Dockerç’°å¢ƒã®ãƒã‚§ãƒƒã‚¯
if ! docker ps | grep -q architrack-backend; then
  echo "âŒ Docker containers are not running. E2E tests cannot be executed."
  echo "   Please run 'docker compose up -d' and try again."
  echo "   Push aborted to ensure all tests are executed."
  exit 1
fi

npm run test:e2e
if [ $? -ne 0 ]; then
  echo "âŒ E2E tests failed. Push aborted."
  exit 1
fi

echo "âœ… All checks passed!"
