#!/bin/sh
# ============================================================================
# ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼ˆå®Œå…¨ç‰ˆ: ãƒ­ã‚°ä¿å­˜ + ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ + åœ§ç¸®ï¼‰
# ============================================================================

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
mkdir -p .logs

# ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ããƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å
TIMESTAMP=$(date +"%Y-%m-%d-%H-%M-%S")
LOG_FILE=".logs/pre-push-${TIMESTAMP}.log"
LATEST_LOG=".logs/pre-push-latest.log"

# ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: 30æ—¥ä»¥ä¸Šå‰ã®ãƒ­ã‚°ã‚’å‰Šé™¤
find .logs -name "pre-push-*.log" -type f -mtime +30 -delete 2>/dev/null || true
find .logs -name "pre-push-*.log.gz" -type f -mtime +30 -delete 2>/dev/null || true

# ãƒ­ã‚°åœ§ç¸®: 7æ—¥ä»¥ä¸Šå‰ã®æœªåœ§ç¸®ãƒ­ã‚°ã‚’gzipåœ§ç¸®
find .logs -name "pre-push-*.log" -type f -mtime +7 ! -name "pre-push-latest.log" -exec gzip {} \; 2>/dev/null || true

# æœ€æ–°ãƒ­ã‚°ã¸ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆ
ln -sf "pre-push-${TIMESTAMP}.log" "${LATEST_LOG}"

# ============================================================================
# ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯å‡¦ç†ã‚’æ³¢æ‹¬å¼§ã§å›²ã‚“ã§ã€æœ€å¾Œã«ãƒ­ã‚°ã«å‡ºåŠ›
# shäº’æ›ã®æ–¹æ³•ï¼ˆãƒ—ãƒ­ã‚»ã‚¹ç½®æ›ã‚’ä½¿ã‚ãªã„ï¼‰
# ============================================================================
{

echo "============================================================================"
echo "ðŸ“ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: ${LOG_FILE}"
echo "ðŸ“ æœ€æ–°ãƒ­ã‚°: ${LATEST_LOG}"
echo "============================================================================"
echo ""

echo "ðŸ” Running format checks before push..."

# Backend format check
if [ -d "backend" ]; then
  echo "ðŸ” Checking backend formatting..."
  npm --prefix backend run format:check
  if [ $? -ne 0 ]; then
    echo "âŒ Backend format check failed. Push aborted."
    echo "   Run 'npm --prefix backend run format' to fix formatting issues."
    exit 1
  fi
fi

# Frontend format check
if [ -d "frontend" ]; then
  echo "ðŸ” Checking frontend formatting..."
  npm --prefix frontend run format:check
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend format check failed. Push aborted."
    echo "   Run 'npm --prefix frontend run format' to fix formatting issues."
    exit 1
  fi
fi

# E2E format check
echo "ðŸ” Checking E2E formatting..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ E2E format check failed. Push aborted."
  echo "   Run 'npm run format' to fix formatting issues."
  exit 1
fi

echo "ðŸ”Ž Running type checks before push..."

# Backend type check
if [ -d "backend" ]; then
  echo "ðŸ” Checking backend types..."
  npm --prefix backend run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Backend type check failed. Push aborted."
    exit 1
  fi
fi

# Frontend type check
if [ -d "frontend" ]; then
  echo "ðŸ” Checking frontend types..."
  npm --prefix frontend run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend type check failed. Push aborted."
    exit 1
  fi
fi

# E2E type check
echo "ðŸ” Checking E2E types..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ E2E type check failed. Push aborted."
  exit 1
fi

echo "ðŸ” Running full lint checks before push..."

# Backend lint
if [ -d "backend" ]; then
  echo "ðŸ” Linting backend..."
  npm --prefix backend run lint
  if [ $? -ne 0 ]; then
    echo "âŒ Backend lint failed. Push aborted."
    exit 1
  fi
fi

# Frontend lint
if [ -d "frontend" ]; then
  echo "ðŸ” Linting frontend..."
  npm --prefix frontend run lint
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend lint failed. Push aborted."
    exit 1
  fi
fi

# E2E lint
echo "ðŸ” Linting E2E tests..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ E2E lint failed. Push aborted."
  exit 1
fi

echo "ðŸ”¨ Building projects before push..."

# Backend build
if [ -d "backend" ]; then
  echo "ðŸ”¨ Building backend..."
  npm --prefix backend run build
  if [ $? -ne 0 ]; then
    echo "âŒ Backend build failed. Push aborted."
    exit 1
  fi
fi

# Frontend build
if [ -d "frontend" ]; then
  echo "ðŸ”¨ Building frontend..."
  npm --prefix frontend run build
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend build failed. Push aborted."
    exit 1
  fi
fi

echo "ðŸ”’ Running security scan before push..."

# Backend security scan
if [ -d "backend" ]; then
  echo "ðŸ” Scanning backend dependencies for vulnerabilities..."
  npm --prefix backend audit --audit-level=moderate
  BACKEND_AUDIT_EXIT=$?
  if [ $BACKEND_AUDIT_EXIT -ne 0 ]; then
    echo "âš ï¸  Backend security vulnerabilities detected (moderate or higher)."
    echo "   This is a WARNING - push will continue, but please address these issues."
    echo "   Run 'npm --prefix backend audit' to see details."
    echo "   Run 'npm --prefix backend audit fix' to attempt automatic fixes."
    echo ""
  else
    echo "âœ… Backend security scan passed."
  fi
fi

# Frontend security scan
if [ -d "frontend" ]; then
  echo "ðŸ” Scanning frontend dependencies for vulnerabilities..."
  npm --prefix frontend audit --audit-level=moderate
  FRONTEND_AUDIT_EXIT=$?
  if [ $FRONTEND_AUDIT_EXIT -ne 0 ]; then
    echo "âš ï¸  Frontend security vulnerabilities detected (moderate or higher)."
    echo "   This is a WARNING - push will continue, but please address these issues."
    echo "   Run 'npm --prefix frontend audit' to see details."
    echo "   Run 'npm --prefix frontend audit fix' to attempt automatic fixes."
    echo ""
  else
    echo "âœ… Frontend security scan passed."
  fi
fi

# Backend unit tests with coverage
if [ -d "backend" ]; then
  echo "ðŸ§ª Running backend unit tests with coverage..."
  npm --prefix backend run test:unit:coverage
  if [ $? -ne 0 ]; then
    echo "âŒ Backend unit tests or coverage check failed. Push aborted."
    echo "   Coverage thresholds: statements 80%, branches 80%, functions 80%, lines 80%"
    echo "   Run 'npm --prefix backend run test:unit:coverage' to check coverage locally."
    exit 1
  fi
fi

# Frontend unit tests with coverage
if [ -d "frontend" ]; then
  echo "ðŸ§ª Running frontend unit tests with coverage..."
  npm --prefix frontend run test:coverage
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend unit tests or coverage check failed. Push aborted."
    echo "   Run 'npm --prefix frontend run test:coverage' to check coverage locally."
    exit 1
  fi
fi

# Storybook tests (Interaction + Accessibility)
if [ -d "frontend" ] && git diff --cached --name-only | grep -q "^frontend/"; then
  echo "ðŸ“– Running Storybook tests..."
  npm --prefix frontend run test-storybook:ci
  if [ $? -ne 0 ]; then
    echo "âŒ Storybook tests failed. Push aborted."
    echo "   Run 'npm --prefix frontend run test-storybook:ci' to check locally."
    exit 1
  fi
fi

# Dockerç’°å¢ƒã®è‡ªå‹•æ§‹ç¯‰
echo "ðŸ³ Setting up Docker environment for integration tests..."

# Dockerç’°å¢ƒã®ãƒã‚§ãƒƒã‚¯ã¨èµ·å‹•
if ! docker ps | grep -q architrack-postgres; then
  echo "   Docker containers not running. Starting Docker Compose..."
  docker compose up -d
  if [ $? -ne 0 ]; then
    echo "âŒ Failed to start Docker containers. Push aborted."
    exit 1
  fi

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
  echo "   Waiting for database to be ready..."
  sleep 10

  # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§30ç§’å¾…æ©Ÿï¼‰
  MAX_RETRIES=6
  RETRY_COUNT=0
  while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    if docker exec architrack-postgres pg_isready -U architrack > /dev/null 2>&1; then
      echo "   âœ… Database is ready"
      break
    fi
    RETRY_COUNT=$((RETRY_COUNT + 1))
    if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
      echo "âŒ Database failed to start within timeout. Push aborted."
      exit 1
    fi
    echo "   Waiting for database... ($RETRY_COUNT/$MAX_RETRIES)"
    sleep 5
  done
else
  echo "   âœ… Docker containers already running"
fi

# Backend integration tests
if [ -d "backend" ]; then
  echo "ðŸ”— Running backend integration tests..."

  # ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã¯Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œ
  # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®Prisma Query Engineå•é¡Œã‚’å›žé¿
  docker exec architrack-backend npm run test:integration
  if [ $? -ne 0 ]; then
    echo "âŒ Backend integration tests failed. Push aborted."
    exit 1
  fi
fi

# E2E tests
echo "ðŸ§ª Running E2E tests..."

# E2Eãƒ†ã‚¹ãƒˆã‚’åŒæœŸå®Ÿè¡Œï¼ˆShift-LeftåŽŸå‰‡: å“è³ªã‚²ãƒ¼ãƒˆã¨ã—ã¦æ©Ÿèƒ½ï¼‰
# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š: 10åˆ†ï¼ˆ600ç§’ï¼‰ã§ãƒãƒ³ã‚°ã‚¢ãƒƒãƒ—ã‚’é˜²æ­¢
echo "   Note: E2E tests will run synchronously to ensure quality before push."
timeout 600 npm run test:e2e
E2E_EXIT_CODE=$?

if [ $E2E_EXIT_CODE -eq 124 ]; then
  echo "âŒ E2E tests timed out after 10 minutes. Push aborted."
  exit 1
elif [ $E2E_EXIT_CODE -ne 0 ]; then
  echo "âŒ E2E tests failed. Push aborted."
  exit 1
fi

echo "âœ… All checks passed!"

} 2>&1 | tee "${LOG_FILE}"
